<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOLYO — Portfolio Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Josefin+Sans:wght@100;200;300;400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Abril+Fatface&family=Source+Sans+3:wght@300;400;600&family=Syne:wght@400;500;600;700;800&family=Fraunces:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Karla:wght@300;400;500;600&family=Rubik+Mono+One&family=Roboto+Mono:wght@300;400;500&family=Bebas+Neue&family=Lato:wght@300;400;700&family=Caveat:wght@400;500;600;700&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a0a; --bg2: #111111; --bg3: #161616;
            --text: #c8c8c8; --dim: #555; --bright: #e8e8e8;
            --accent: #888; --border: #1e1e1e;
            --bgfx: #888888; --bgfx-o: 1;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Cormorant Garamond', serif;
            background: var(--bg); color: var(--text);
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* === BACKGROUND LAYER === */
        #bgLayer {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            transition: opacity 0.5s;
            opacity: var(--bgfx-o);
        }
        nav, .hero, .ticker, section, footer { position: relative; z-index: 1; }

        /* BG: Brume */
        .bg-brume #bgLayer {
            background:
                radial-gradient(ellipse at 20% 50%, color-mix(in srgb, var(--bgfx) 10%, transparent) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, color-mix(in srgb, var(--bgfx) 8%, transparent) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 90%, color-mix(in srgb, var(--bgfx) 6%, transparent) 0%, transparent 50%);
        }
        /* BG: Vignette */
        .bg-vignette #bgLayer {
            background: radial-gradient(ellipse at center, color-mix(in srgb, var(--bgfx) 3%, transparent) 20%, color-mix(in srgb, var(--bgfx) 18%, black) 100%);
        }
        /* BG: Grain — generated dynamically via JS */
        .bg-grain #bgLayer { }
        /* BG: Grille — generated dynamically via JS */
        .bg-grille #bgLayer { }
        /* BG: Constellations */
        .bg-constellations #bgLayer {
            background-image:
                radial-gradient(circle at 15% 25%, color-mix(in srgb, var(--bgfx) 14%, transparent) 1px, transparent 1px),
                radial-gradient(circle at 85% 15%, color-mix(in srgb, var(--bgfx) 10%, transparent) 1px, transparent 1px),
                radial-gradient(circle at 45% 70%, color-mix(in srgb, var(--bgfx) 12%, transparent) 1px, transparent 1px),
                radial-gradient(circle at 70% 55%, color-mix(in srgb, var(--bgfx) 8%, transparent) 1px, transparent 1px),
                radial-gradient(circle at 25% 85%, color-mix(in srgb, var(--bgfx) 11%, transparent) 1px, transparent 1px),
                radial-gradient(circle at 55% 30%, color-mix(in srgb, var(--bgfx) 9%, transparent) 1px, transparent 1px),
                radial-gradient(circle at 90% 80%, color-mix(in srgb, var(--bgfx) 13%, transparent) 1px, transparent 1px);
            background-size: 350px 350px, 280px 280px, 400px 400px, 320px 320px, 260px 260px, 380px 380px, 300px 300px;
        }
        /* BG: Fumée */
        .bg-fumee #bgLayer {
            background:
                radial-gradient(ellipse at 10% 20%, color-mix(in srgb, var(--bgfx) 12%, transparent) 0%, transparent 40%),
                radial-gradient(ellipse at 90% 80%, color-mix(in srgb, var(--bgfx) 9%, transparent) 0%, transparent 35%),
                radial-gradient(ellipse at 50% 50%, color-mix(in srgb, var(--bgfx) 10%, transparent) 0%, transparent 45%),
                radial-gradient(ellipse at 30% 70%, color-mix(in srgb, var(--bgfx) 6%, transparent) 0%, transparent 30%),
                radial-gradient(ellipse at 70% 30%, color-mix(in srgb, var(--bgfx) 7%, transparent) 0%, transparent 35%);
            animation: bgDrift 30s ease-in-out infinite alternate;
        }
        @keyframes bgDrift {
            0% { transform: scale(1) translate(0,0); }
            33% { transform: scale(1.05) translate(-1%,1%); }
            66% { transform: scale(0.98) translate(1%,-1%); }
            100% { transform: scale(1.02) translate(-0.5%,0.5%); }
        }
        /* BG: Runes — generated dynamically via JS */
        .bg-runes #bgLayer { }
        /* BG: Éclats */
        .bg-eclats #bgLayer {
            background:
                radial-gradient(circle at 20% 30%, color-mix(in srgb, var(--bgfx) 7%, transparent) 0%, transparent 20%),
                radial-gradient(circle at 75% 15%, color-mix(in srgb, var(--bgfx) 5%, transparent) 0%, transparent 15%),
                radial-gradient(circle at 60% 70%, color-mix(in srgb, var(--bgfx) 8%, transparent) 0%, transparent 18%),
                radial-gradient(circle at 10% 80%, color-mix(in srgb, var(--bgfx) 4%, transparent) 0%, transparent 12%),
                radial-gradient(circle at 85% 60%, color-mix(in srgb, var(--bgfx) 6%, transparent) 0%, transparent 16%),
                radial-gradient(circle at 40% 10%, color-mix(in srgb, var(--bgfx) 7%, transparent) 0%, transparent 14%);
        }
        /* BG: Nébulose */
        .bg-nebulose #bgLayer {
            background:
                radial-gradient(ellipse at 30% 20%, color-mix(in srgb, var(--bgfx) 15%, transparent) 0%, transparent 35%),
                radial-gradient(ellipse at 70% 70%, color-mix(in srgb, var(--bgfx) 18%, transparent) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 40%, color-mix(in srgb, var(--bgfx) 8%, transparent) 0%, transparent 50%);
            filter: blur(40px);
        }
        /* BG: Tissu — generated dynamically via JS */
        .bg-tissu #bgLayer { }
        /* BG: Aurora — animated color orbs */
        .bg-aurora #bgLayer {
            background:
                radial-gradient(ellipse at 20% 30%, color-mix(in srgb, var(--bgfx) 20%, transparent) 0%, transparent 45%),
                radial-gradient(ellipse at 80% 60%, color-mix(in srgb, var(--bgfx) 18%, #2020a0 5%) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 80%, color-mix(in srgb, var(--bgfx) 15%, #20a060 5%) 0%, transparent 35%);
            filter: blur(50px);
            animation: auroraShift 25s ease-in-out infinite alternate;
        }
        @keyframes auroraShift {
            0% { transform: scale(1) rotate(0deg); }
            33% { transform: scale(1.08) rotate(2deg); }
            66% { transform: scale(0.95) rotate(-1deg); }
            100% { transform: scale(1.03) rotate(1deg); }
        }

        /* BG: Plasma — animated blob orbs */
        .bg-plasma #bgLayer {
            background:
                radial-gradient(circle at 30% 40%, color-mix(in srgb, var(--bgfx) 22%, transparent) 0%, transparent 30%),
                radial-gradient(circle at 70% 60%, color-mix(in srgb, var(--bgfx) 18%, transparent) 0%, transparent 25%),
                radial-gradient(circle at 50% 20%, color-mix(in srgb, var(--bgfx) 14%, transparent) 0%, transparent 28%),
                radial-gradient(circle at 20% 70%, color-mix(in srgb, var(--bgfx) 12%, transparent) 0%, transparent 22%);
            filter: blur(35px);
            animation: plasmaPulse 18s ease-in-out infinite alternate;
        }
        @keyframes plasmaPulse {
            0% { transform: scale(1) translate(0,0); }
            25% { transform: scale(1.1) translate(2%,-1%); }
            50% { transform: scale(0.96) translate(-1%,2%); }
            75% { transform: scale(1.05) translate(1%,-2%); }
            100% { transform: scale(0.98) translate(-1%,1%); }
        }

        /* BG: Rayons — light beams from center */
        .bg-rayons #bgLayer {
            background:
                conic-gradient(from 0deg at 50% 40%,
                    transparent 0deg, color-mix(in srgb, var(--bgfx) 4%, transparent) 15deg,
                    transparent 30deg, color-mix(in srgb, var(--bgfx) 3%, transparent) 60deg,
                    transparent 80deg, color-mix(in srgb, var(--bgfx) 5%, transparent) 110deg,
                    transparent 140deg, color-mix(in srgb, var(--bgfx) 3%, transparent) 180deg,
                    transparent 210deg, color-mix(in srgb, var(--bgfx) 4%, transparent) 250deg,
                    transparent 280deg, color-mix(in srgb, var(--bgfx) 3%, transparent) 320deg,
                    transparent 360deg);
            animation: rayonsSpin 60s linear infinite;
        }
        @keyframes rayonsSpin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        /* BG: Bokeh — out of focus light circles */
        .bg-bokeh #bgLayer {
            background:
                radial-gradient(circle 80px at 15% 25%, color-mix(in srgb, var(--bgfx) 10%, transparent) 0%, transparent 100%),
                radial-gradient(circle 120px at 85% 20%, color-mix(in srgb, var(--bgfx) 7%, transparent) 0%, transparent 100%),
                radial-gradient(circle 60px at 40% 65%, color-mix(in srgb, var(--bgfx) 12%, transparent) 0%, transparent 100%),
                radial-gradient(circle 90px at 75% 75%, color-mix(in srgb, var(--bgfx) 8%, transparent) 0%, transparent 100%),
                radial-gradient(circle 70px at 25% 80%, color-mix(in srgb, var(--bgfx) 9%, transparent) 0%, transparent 100%),
                radial-gradient(circle 100px at 60% 30%, color-mix(in srgb, var(--bgfx) 6%, transparent) 0%, transparent 100%),
                radial-gradient(circle 50px at 90% 50%, color-mix(in srgb, var(--bgfx) 11%, transparent) 0%, transparent 100%);
            animation: bokehFloat 20s ease-in-out infinite alternate;
        }
        @keyframes bokehFloat {
            0% { transform: translate(0,0); }
            50% { transform: translate(-1%,1%); }
            100% { transform: translate(1%,-0.5%); }
        }

        /* BG: Toile — canvas/painted texture, JS generated */
        .bg-toile #bgLayer { }



        /* === ONBOARDING === */
        .onboard-bg {
            position: fixed; inset: 0; z-index: 99999;
            background: rgba(3,3,3,0.97); backdrop-filter: blur(30px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; animation: onbFadeIn 0.6s ease forwards;
        }
        @keyframes onbFadeIn { to { opacity:1; } }
        .onboard-box {
            max-width: 460px; width: 90%; text-align: center; padding: 3rem 2rem;
        }
        .onboard-sigil {
            width: 60px; height: 60px; margin: 0 auto 1.5rem; opacity: 0.4;
        }
        .onboard-title {
            font-family: 'Cinzel Decorative', serif; font-size: 1.6rem;
            color: var(--bright); letter-spacing: 0.15em; margin-bottom: 0.6rem;
        }
        .onboard-sub {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.6rem; letter-spacing: 0.3em; text-transform: uppercase;
            color: var(--dim); margin-bottom: 2rem;
        }
        .onboard-steps {
            text-align: left; margin-bottom: 2rem;
        }
        .onboard-step {
            display: flex; gap: 0.8rem; align-items: flex-start; margin-bottom: 1.2rem;
        }
        .onboard-num {
            font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--accent);
            min-width: 24px; text-align: center; line-height: 1.4;
        }
        .onboard-step-text {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.58rem; letter-spacing: 0.06em; color: var(--text);
            line-height: 1.7;
        }
        .onboard-step-text strong { color: var(--bright); font-weight: 400; }
        .onboard-go {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.65rem; letter-spacing: 0.25em; text-transform: uppercase;
            padding: 0.9rem 2.5rem; background: rgba(200,200,200,0.1);
            color: var(--bright); border: 1px solid rgba(200,200,200,0.15);
            cursor: pointer; transition: all 0.3s;
        }
        .onboard-go:hover { background: rgba(200,200,200,0.2); border-color: rgba(200,200,200,0.3); }
        .onboard-skip {
            display: block; margin: 1rem auto 0; background: none; border: none;
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.42rem; letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--dim); cursor: pointer; transition: color 0.2s;
        }
        .onboard-skip:hover { color: var(--text); }

        /* === SEO PANEL === */
        .seo-cfg { margin-top: 0.3rem; border: 1px solid var(--border); border-radius: 5px; padding: 0.6rem; }
        .seo-field {
            width: 100%; box-sizing: border-box; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.04em; background: transparent;
            border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem;
            outline: none; border-radius: 3px; transition: border 0.3s; margin-bottom: 0.4rem;
        }
        .seo-field:focus { border-color: rgba(255,255,255,0.15); }
        .seo-field::placeholder { color: var(--dim); font-style: italic; }
        .seo-textarea {
            width: 100%; box-sizing: border-box; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.03em; background: transparent;
            border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem;
            outline: none; border-radius: 3px; transition: border 0.3s; margin-bottom: 0.4rem;
            resize: vertical; min-height: 40px; line-height: 1.5;
        }
        .seo-textarea:focus { border-color: rgba(255,255,255,0.15); }
        .seo-textarea::placeholder { color: var(--dim); font-style: italic; }
        .seo-preview {
            margin-top: 0.5rem; padding: 0.6rem; border: 1px solid var(--border);
            border-radius: 4px; background: rgba(255,255,255,0.02);
        }
        .seo-preview-title {
            font-family: 'Josefin Sans', sans-serif; font-weight: 400;
            font-size: 0.55rem; color: #88f; margin-bottom: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .seo-preview-url {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.38rem; color: #4a4; margin-bottom: 2px;
        }
        .seo-preview-desc {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.4rem; color: var(--dim); line-height: 1.4;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        /* === SECTION REORDER === */
        .section-reorder-cfg { margin-top: 0.3rem; border: 1px solid var(--border); border-radius: 5px; overflow: hidden; }
        .section-reorder-item {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.55rem 0.6rem; border-bottom: 1px solid var(--border);
            transition: background 0.2s; cursor: grab;
        }
        .section-reorder-item:last-child { border-bottom: none; }
        .section-reorder-item:hover { background: rgba(255,255,255,0.02); }
        .section-reorder-item.dragging { opacity: 0.4; background: rgba(255,255,255,0.04); }
        .section-reorder-item.drag-over { box-shadow: inset 0 -2px 0 var(--accent); }
        .section-reorder-handle {
            font-size: 0.7rem; color: var(--dim); cursor: grab; user-select: none;
        }
        .section-reorder-name {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--text); flex: 1;
        }
        .section-reorder-arrows { display: flex; gap: 0.15rem; }
        .section-reorder-arrow {
            background: none; border: 1px solid var(--border); color: var(--dim);
            font-size: 0.5rem; width: 22px; height: 22px; border-radius: 3px;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .section-reorder-arrow:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }

        /* === EXPORT/IMPORT JSON === */
        .json-btns { display: flex; gap: 0.3rem; margin-top: 0.4rem; }
        .json-btn {
            flex: 1; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.46rem; letter-spacing: 0.1em; text-transform: uppercase;
            padding: 0.5rem 0.6rem; border: 1px solid var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            border-radius: 3px; transition: all 0.3s; text-align: center;
        }
        .json-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .json-btn.import { position: relative; overflow: hidden; }
        .json-btn.import input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        /* === EDITABLE === */
        .editable { outline: none; border-radius: 3px; transition: box-shadow 0.2s; cursor: text; }
        .editable:hover { box-shadow: 0 0 0 1px rgba(255,255,255,0.06); }
        .editable:focus { box-shadow: 0 0 0 2px rgba(255,255,255,0.14); background: rgba(255,255,255,0.02); }

        /* === TOOLBAR === */
        .edit-toolbar {
            position: fixed; bottom: 1.2rem; right: 1.2rem;
            z-index: 9999; display: flex; flex-direction: column;
            gap: 0.45rem; align-items: flex-end;
        }
        .tb {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.62rem; letter-spacing: 0.15em; text-transform: uppercase;
            padding: 0.65rem 1.1rem; border: 1px solid var(--border);
            background: rgba(10,10,10,0.95); color: var(--text);
            cursor: pointer; backdrop-filter: blur(20px); transition: all 0.3s;
            border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;
        }
        .tb:hover { border-color: rgba(255,255,255,0.2); color: var(--bright); }
        .tb svg { width: 13px; height: 13px; }
        .tb-group { display: flex; gap: 0.3rem; align-items: center; }
        .tb-sm {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.12em; text-transform: uppercase;
            padding: 0.55rem 0.7rem; border: 1px solid var(--border);
            background: rgba(10,10,10,0.95); color: var(--dim);
            cursor: pointer; backdrop-filter: blur(20px); transition: all 0.3s;
            border-radius: 4px; display: flex; align-items: center; gap: 0.35rem;
            white-space: nowrap;
        }
        .tb-sm:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .tb-sm svg { width: 11px; height: 11px; }
        .tb-sm.danger:hover { border-color: rgba(180,80,80,0.4); color: #c87070; }
        .tb-undo-group { display: flex; gap: 0.2rem; align-items: center; }
        .tb-ur {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.7rem; width: 32px; height: 32px;
            border: 1px solid var(--border); background: rgba(10,10,10,0.95);
            color: var(--dim); cursor: pointer; backdrop-filter: blur(20px);
            transition: all 0.3s; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .tb-ur:hover:not(:disabled) { border-color: rgba(255,255,255,0.2); color: var(--bright); }
        .tb-ur:disabled { opacity: 0.25; cursor: default; }
        .tb-ur svg { width: 14px; height: 14px; }

        /* About editor in Config */
        .about-cfg { margin-top: 0.3rem; border: 1px solid var(--border); border-radius: 5px; padding: 0.6rem; }
        .about-field {
            width: 100%; box-sizing: border-box; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.04em; background: transparent;
            border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem;
            outline: none; border-radius: 3px; transition: border 0.3s; margin-bottom: 0.4rem;
        }
        .about-field:focus { border-color: rgba(255,255,255,0.15); }
        .about-field::placeholder { color: var(--dim); font-style: italic; }
        .about-textarea {
            width: 100%; box-sizing: border-box; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.03em; background: transparent;
            border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem;
            outline: none; border-radius: 3px; transition: border 0.3s; margin-bottom: 0.4rem;
            resize: vertical; min-height: 50px; line-height: 1.6;
        }
        .about-textarea:focus { border-color: rgba(255,255,255,0.15); }
        .about-textarea::placeholder { color: var(--dim); font-style: italic; }
        .about-stat-row { display: flex; gap: 0.4rem; align-items: center; margin-bottom: 0.3rem; }
        .about-stat-field {
            flex: 1; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; background: transparent; border: 1px solid var(--border);
            color: var(--text); padding: 0.3rem 0.4rem; outline: none; border-radius: 3px;
            transition: border 0.3s;
        }
        .about-stat-field:focus { border-color: rgba(255,255,255,0.15); }
        .about-stat-field::placeholder { color: var(--dim); font-style: italic; }
        .save-badge {
            position: fixed; bottom: 0.5rem; left: 50%; transform: translateX(-50%);
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.42rem; letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--dim); opacity: 0; transition: opacity 0.4s;
            z-index: 9999; pointer-events: none;
            display: flex; align-items: center; gap: 0.35rem;
        }
        .save-badge.show { opacity: 1; }
        .save-badge-dot { width: 5px; height: 5px; border-radius: 50%; background: #4a8; box-shadow: 0 0 5px rgba(68,170,136,0.4); }
        .save-confirm {
            position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%);
            background: var(--bg2); border: 1px solid var(--border); padding: 0.6rem 1.2rem;
            border-radius: 5px; z-index: 10003; display: flex; align-items: center; gap: 0.5rem;
            box-shadow: 0 6px 25px rgba(0,0,0,0.5); transition: bottom 0.35s cubic-bezier(0.4,0,0.2,1);
            backdrop-filter: blur(20px);
        }
        .save-confirm.show { bottom: 1.5rem; }
        .save-confirm-text {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.52rem; letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--bright);
        }
        .save-confirm-sub {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.4rem; letter-spacing: 0.08em; color: var(--dim); margin-top: 1px;
        }

        /* === THEME PANEL === */
        .tp {
            position: fixed; top: 0; right: -360px; width: 350px; height: 100vh;
            background: rgba(8,8,8,0.97); backdrop-filter: blur(30px);
            border-left: 1px solid var(--border); z-index: 10000;
            padding: 2rem 1.3rem; overflow-y: auto;
            transition: right 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        .tp.open { right: 0; }
        .tp-title { font-family: 'Cinzel', serif; font-size: 0.95rem; color: var(--bright); letter-spacing: 0.15em; margin-bottom: 1.8rem; }
        .tp-close { position: absolute; top: 1.2rem; right: 1.2rem; background: none; border: none; color: var(--dim); cursor: pointer; font-size: 1.1rem; }
        .tp-close:hover { color: var(--bright); }
        .tp-label { font-family: 'Josefin Sans', sans-serif; font-weight: 300; font-size: 0.55rem; letter-spacing: 0.25em; text-transform: uppercase; color: var(--dim); margin-bottom: 0.7rem; margin-top: 1.2rem; }
        .tp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .tp-opt {
            padding: 0.7rem; border: 1px solid var(--border); border-radius: 5px;
            cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .tp-opt:hover { border-color: rgba(255,255,255,0.15); }
        .tp-opt.active { border-color: rgba(255,255,255,0.35); background: rgba(255,255,255,0.04); }
        .tp-opt-name { font-family: 'Josefin Sans', sans-serif; font-weight: 300; font-size: 0.55rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text); margin-top: 0.4rem; }
        .tp-dots { display: flex; gap: 3px; justify-content: center; }
        .tp-dot { width: 16px; height: 16px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); }

        /* === LOGO UPLOAD in panel === */
        .logo-upload-zone {
            border: 1px dashed var(--border); border-radius: 6px;
            padding: 1.2rem; text-align: center; cursor: pointer;
            transition: all 0.3s; position: relative; margin-top: 0.3rem;
        }
        .logo-upload-zone:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.02); }
        .logo-upload-zone svg { width: 28px; height: 28px; color: var(--dim); margin-bottom: 0.5rem; }
        .logo-upload-zone .luz-text {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.52rem; letter-spacing: 0.2em; text-transform: uppercase;
            color: var(--dim); display: block;
        }
        .logo-upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .logo-preview-wrap {
            display: none; align-items: center; gap: 0.8rem;
            padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; margin-top: 0.3rem;
        }
        .logo-preview-wrap.active { display: flex; }
        .logo-preview-wrap img { width: 48px; height: 48px; object-fit: contain; border-radius: 4px; background: rgba(255,255,255,0.03); }
        .logo-preview-info { flex: 1; }
        .logo-preview-name {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.52rem; letter-spacing: 0.12em; color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;
        }
        .logo-preview-size {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.48rem; letter-spacing: 0.1em; color: var(--dim); margin-top: 2px;
        }
        .logo-remove {
            background: none; border: 1px solid var(--border); color: var(--dim);
            font-size: 0.7rem; width: 26px; height: 26px; border-radius: 4px;
            cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .logo-remove:hover { border-color: rgba(200,100,100,0.4); color: #c87070; }

        /* === BG Color Controls === */
        .bgfx-controls {
            margin-top: 0.6rem; padding: 0.8rem; border: 1px solid var(--border);
            border-radius: 5px; display: none;
        }
        .bgfx-controls.active { display: block; }
        .bgfx-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.6rem; }
        .bgfx-row:last-child { margin-bottom: 0; }
        .bgfx-color-input {
            width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 4px;
            cursor: pointer; background: none; padding: 0; overflow: hidden;
        }
        .bgfx-color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .bgfx-color-input::-webkit-color-swatch { border: none; border-radius: 3px; }
        .bgfx-color-input::-moz-color-swatch { border: none; border-radius: 3px; }
        .bgfx-hex {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.55rem; letter-spacing: 0.1em; text-transform: uppercase;
            background: transparent; border: 1px solid var(--border); color: var(--text);
            padding: 0.4rem 0.5rem; width: 72px; outline: none; border-radius: 3px;
        }
        .bgfx-hex:focus { border-color: rgba(255,255,255,0.2); }
        .bgfx-auto-btn {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.15em; text-transform: uppercase;
            padding: 0.4rem 0.65rem; border: 1px solid var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            border-radius: 3px; transition: all 0.3s; white-space: nowrap;
        }
        .bgfx-auto-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .bgfx-auto-btn.active { border-color: rgba(255,255,255,0.3); color: var(--bright); background: rgba(255,255,255,0.04); }
        .bgfx-swatches { display: flex; gap: 4px; flex-wrap: wrap; }
        .bgfx-swatch {
            width: 22px; height: 22px; border-radius: 50%; border: 2px solid transparent;
            cursor: pointer; transition: all 0.25s; position: relative;
        }
        .bgfx-swatch:hover { transform: scale(1.15); }
        .bgfx-swatch.active { border-color: var(--bright); }
        .bgfx-intensity-row { display: flex; align-items: center; gap: 0.6rem; }
        .bgfx-slider {
            -webkit-appearance: none; appearance: none; flex: 1; height: 3px;
            background: var(--border); outline: none; border-radius: 3px;
        }
        .bgfx-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px;
            border-radius: 50%; background: var(--text); cursor: pointer;
            border: 2px solid var(--bg); box-shadow: 0 0 0 1px var(--border);
        }
        .bgfx-slider::-moz-range-thumb {
            width: 14px; height: 14px; border-radius: 50%;
            background: var(--text); cursor: pointer;
            border: 2px solid var(--bg); box-shadow: 0 0 0 1px var(--border);
        }
        .bgfx-slider-label {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.48rem; letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--dim); min-width: 55px;
        }

        /* === EMAIL CONFIG === */
        .mail-cfg {
            margin-top: 0.3rem; padding: 0.9rem; border: 1px solid var(--border);
            border-radius: 5px;
        }
        .mail-row { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.6rem; }
        .mail-row:last-child { margin-bottom: 0; }
        .mail-input {
            flex: 1; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.58rem; letter-spacing: 0.05em;
            background: transparent; border: 1px solid var(--border); color: var(--text);
            padding: 0.5rem 0.6rem; outline: none; border-radius: 3px; transition: border 0.3s;
        }
        .mail-input:focus { border-color: rgba(255,255,255,0.2); }
        .mail-input::placeholder { color: var(--dim); font-style: italic; }
        .mail-mode-btns { display: flex; gap: 0.3rem; flex-wrap: wrap; }
        .mail-mode-btn {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.1em; text-transform: uppercase;
            padding: 0.4rem 0.6rem; border: 1px solid var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            border-radius: 3px; transition: all 0.3s;
        }
        .mail-mode-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .mail-mode-btn.active { border-color: rgba(255,255,255,0.3); color: var(--bright); background: rgba(255,255,255,0.04); }
        .mail-extra { display: none; margin-top: 0.5rem; }
        .mail-extra.show { display: block; }
        .mail-status {
            display: flex; align-items: center; gap: 0.4rem; margin-top: 0.5rem;
            padding: 0.5rem 0.6rem; border-radius: 3px; border: 1px solid var(--border);
        }
        .mail-dot {
            width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
        }
        .mail-dot.off { background: #555; }
        .mail-dot.on { background: #4a8; box-shadow: 0 0 6px rgba(68,170,136,0.4); }
        .mail-dot.warn { background: #a84; box-shadow: 0 0 6px rgba(170,136,68,0.4); }
        .mail-status-text {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.46rem; letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--dim);
        }
        .mail-hint {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.42rem; letter-spacing: 0.05em; color: var(--dim);
            margin-top: 0.35rem; line-height: 1.5; opacity: 0.7;
        }
        .mail-hint a { color: var(--accent); text-decoration: underline; }

        /* === SOCIAL LINKS MANAGER === */
        .soc-cfg {
            margin-top: 0.3rem; border: 1px solid var(--border);
            border-radius: 5px; overflow: hidden;
        }
        .soc-list { }
        .soc-item {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.55rem 0.6rem; border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .soc-item:hover { background: rgba(255,255,255,0.02); }
        .soc-item:last-child { border-bottom: none; }
        .soc-icon-pick {
            width: 28px; height: 28px; border-radius: 4px;
            border: 1px solid var(--border); background: transparent;
            color: var(--text); font-size: 0.9rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: border 0.3s; flex-shrink: 0; padding: 0;
        }
        .soc-icon-pick:hover { border-color: rgba(255,255,255,0.2); }
        .soc-field {
            flex: 1; min-width: 0;
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.05em;
            background: transparent; border: 1px solid transparent;
            color: var(--text); padding: 0.3rem 0.4rem; outline: none;
            border-radius: 3px; transition: border 0.3s;
        }
        .soc-field:focus { border-color: rgba(255,255,255,0.12); }
        .soc-field::placeholder { color: var(--dim); font-style: italic; }
        .soc-field-url {
            font-size: 0.42rem; color: var(--dim); letter-spacing: 0.02em;
        }
        .soc-del {
            background: none; border: none; color: var(--dim);
            cursor: pointer; font-size: 0.7rem; padding: 0.2rem;
            opacity: 0; transition: all 0.2s; flex-shrink: 0;
        }
        .soc-item:hover .soc-del { opacity: 1; }
        .soc-del:hover { color: #c87070; }
        .soc-add {
            display: flex; align-items: center; justify-content: center;
            gap: 0.4rem; padding: 0.6rem; cursor: pointer;
            border-top: 1px solid var(--border); transition: background 0.2s;
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.48rem; letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--dim);
        }
        .soc-add:hover { background: rgba(255,255,255,0.02); color: var(--text); }
        .soc-fields { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px; }
        .soc-empty {
            padding: 1rem; text-align: center;
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.46rem; letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--dim); opacity: 0.6;
        }
        /* Icon picker popup */
        .soc-picker-bg {
            position: fixed; inset: 0; z-index: 10003; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center;
        }
        .soc-picker-bg.show { display: flex; }
        .soc-picker-box {
            background: var(--bg2); border: 1px solid var(--border);
            padding: 1.2rem; border-radius: 6px; width: 280px; max-width: 90vw;
        }
        .soc-picker-title {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.55rem; letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--bright); margin-bottom: 0.8rem;
        }
        .soc-picker-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;
        }
        .soc-picker-item {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 1.15rem; border-radius: 5px; cursor: pointer;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .soc-picker-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }
        .soc-picker-custom {
            margin-top: 0.6rem; display: flex; gap: 0.3rem; align-items: center;
        }
        .soc-picker-custom input {
            flex: 1; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.52rem; background: transparent; border: 1px solid var(--border);
            color: var(--text); padding: 0.4rem 0.5rem; outline: none; border-radius: 3px;
        }
        .soc-picker-custom input:focus { border-color: rgba(255,255,255,0.2); }
        .soc-picker-custom button {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.1em; text-transform: uppercase;
            padding: 0.42rem 0.6rem; border: 1px solid var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            border-radius: 3px; transition: all 0.3s;
        }
        .soc-picker-custom button:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }

        /* === QUICK LINKS (Config) === */
        .qlinks-cfg { margin-top: 0.3rem; border: 1px solid var(--border); border-radius: 5px; overflow: hidden; }
        .qlink-item {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.55rem 0.6rem; border-bottom: 1px solid var(--border); transition: background 0.2s;
        }
        .qlink-item:hover { background: rgba(255,255,255,0.02); }
        .qlink-item:last-child { border-bottom: none; }
        .qlink-fields { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px; }
        .qlink-field {
            flex: 1; min-width: 0; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.05em; background: transparent;
            border: 1px solid transparent; color: var(--text); padding: 0.3rem 0.4rem;
            outline: none; border-radius: 3px; transition: border 0.3s;
        }
        .qlink-field:focus { border-color: rgba(255,255,255,0.12); }
        .qlink-field::placeholder { color: var(--dim); font-style: italic; }
        .qlink-field-url { font-size: 0.42rem; color: var(--dim); letter-spacing: 0.02em; }
        .qlink-del { background: none; border: none; color: var(--dim); cursor: pointer; font-size: 0.7rem; padding: 0.2rem; opacity: 0; transition: all 0.2s; flex-shrink: 0; }
        .qlink-item:hover .qlink-del { opacity: 1; }
        .qlink-del:hover { color: #c87070; }
        .qlink-add {
            display: flex; align-items: center; justify-content: center; gap: 0.4rem;
            padding: 0.6rem; cursor: pointer; border-top: 1px solid var(--border); transition: background 0.2s;
            font-family: 'Josefin Sans', sans-serif; font-weight: 200; font-size: 0.48rem;
            letter-spacing: 0.15em; text-transform: uppercase; color: var(--dim);
        }
        .qlink-add:hover { background: rgba(255,255,255,0.02); color: var(--text); }
        .qlink-empty {
            padding: 1rem; text-align: center; font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.46rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--dim); opacity: 0.6;
        }
        .quick-links-bar {
            display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 1rem;
        }
        .quick-link-btn {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.52rem; letter-spacing: 0.12em; text-transform: uppercase;
            padding: 0.5rem 1rem; border: 1px solid var(--border); color: var(--text);
            text-decoration: none; transition: all 0.3s; background: transparent;
        }
        .quick-link-btn:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.03); }

        /* === SERVICE MANAGEMENT (Config) === */
        .svc-cfg { margin-top: 0.3rem; border: 1px solid var(--border); border-radius: 5px; overflow: hidden; }
        .svc-item {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.55rem 0.6rem; border-bottom: 1px solid var(--border); transition: background 0.2s;
        }
        .svc-item:hover { background: rgba(255,255,255,0.02); }
        .svc-item:last-child { border-bottom: none; }
        .svc-icon-pick {
            width: 32px; height: 32px; border-radius: 4px; border: 1px solid var(--border);
            background: transparent; color: var(--text); font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: border 0.3s; flex-shrink: 0; padding: 0;
        }
        .svc-icon-pick:hover { border-color: rgba(255,255,255,0.2); }
        .svc-fields { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
        .svc-field {
            flex: 1; min-width: 0; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.05em; background: transparent;
            border: 1px solid transparent; color: var(--text); padding: 0.25rem 0.4rem;
            outline: none; border-radius: 3px; transition: border 0.3s;
        }
        .svc-field:focus { border-color: rgba(255,255,255,0.12); }
        .svc-field::placeholder { color: var(--dim); font-style: italic; }
        .svc-field-desc { font-size: 0.44rem; color: var(--dim); }
        .svc-field-price { font-size: 0.42rem; color: var(--dim); letter-spacing: 0.02em; }
        .svc-btns { display: flex; flex-direction: column; gap: 2px; flex-shrink: 0; }
        .svc-mini-btn {
            background: none; border: none; color: var(--dim); cursor: pointer;
            font-size: 0.55rem; padding: 1px 3px; opacity: 0; transition: all 0.2s;
        }
        .svc-item:hover .svc-mini-btn { opacity: 1; }
        .svc-mini-btn:hover { color: var(--text); }
        .svc-mini-btn.del:hover { color: #c87070; }
        .svc-add {
            display: flex; align-items: center; justify-content: center; gap: 0.4rem;
            padding: 0.6rem; cursor: pointer; border-top: 1px solid var(--border); transition: background 0.2s;
            font-family: 'Josefin Sans', sans-serif; font-weight: 200; font-size: 0.48rem;
            letter-spacing: 0.15em; text-transform: uppercase; color: var(--dim);
        }
        .svc-add:hover { background: rgba(255,255,255,0.02); color: var(--text); }
        .svc-empty {
            padding: 1rem; text-align: center; font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.46rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--dim); opacity: 0.6;
        }

        /* === ADVANCED COLORS & TYPOGRAPHY (Style tab) === */
        .adv-color-row {
            display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;
        }
        .adv-color-label {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.44rem; letter-spacing: 0.08em; text-transform: uppercase;
            color: var(--dim); min-width: 55px;
        }
        .adv-color-input {
            width: 24px; height: 24px; border: 1px solid var(--border); border-radius: 3px;
            cursor: pointer; background: none; padding: 0; flex-shrink: 0;
        }
        .adv-color-input::-webkit-color-swatch-wrapper { padding: 1px; }
        .adv-color-input::-webkit-color-swatch { border: none; border-radius: 2px; }
        .adv-color-hex {
            font-family: 'Roboto Mono', monospace; font-size: 0.45rem;
            background: transparent; border: 1px solid var(--border); color: var(--text);
            padding: 0.25rem 0.4rem; width: 65px; outline: none; border-radius: 3px;
            transition: border 0.3s; letter-spacing: 0.05em;
        }
        .adv-color-hex:focus { border-color: rgba(255,255,255,0.2); }
        .adv-color-reset {
            background: none; border: 1px solid var(--border); color: var(--dim);
            font-size: 0.6rem; width: 22px; height: 22px; border-radius: 3px;
            cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .adv-color-reset:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }
        .typo-row {
            display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;
        }
        .typo-label {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.44rem; letter-spacing: 0.08em; text-transform: uppercase;
            color: var(--dim); min-width: 65px;
        }
        .typo-select {
            flex: 1; font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.46rem; background: var(--bg2); border: 1px solid var(--border);
            color: var(--text); padding: 0.35rem 0.4rem; outline: none; border-radius: 3px;
            cursor: pointer; transition: border 0.3s;
        }
        .typo-select:focus { border-color: rgba(255,255,255,0.2); }
        .mail-test-btn {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.12em; text-transform: uppercase;
            padding: 0.4rem 0.7rem; border: 1px solid var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            border-radius: 3px; transition: all 0.3s; white-space: nowrap;
        }
        .mail-test-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }

        /* === FORM TOAST === */
        .form-toast {
            position: fixed; bottom: -80px; left: 50%; transform: translateX(-50%);
            background: var(--bg2); border: 1px solid var(--border);
            padding: 1rem 1.8rem; border-radius: 6px; z-index: 10003;
            display: flex; align-items: center; gap: 0.7rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            transition: bottom 0.4s cubic-bezier(0.4,0,0.2,1);
            backdrop-filter: blur(20px);
        }
        .form-toast.show { bottom: 2rem; }
        .form-toast-icon { font-size: 1.2rem; }
        .form-toast-text {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--bright);
        }
        .form-toast-sub {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.45rem; letter-spacing: 0.08em;
            color: var(--dim); margin-top: 2px;
        }

        .ov {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .ov.show { opacity: 1; pointer-events: auto; }

        /* === NAV === */
        nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            padding: 0.9rem 2rem; background: rgba(10,10,10,0.88);
            backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255,255,255,0.03);
            display: flex; align-items: center; justify-content: space-between;
        }
        .n-logo {
            font-family: 'Cinzel Decorative', serif; font-size: 1.1rem;
            color: var(--bright); letter-spacing: 0.35em; text-decoration: none;
            display: flex; align-items: center; gap: 0.6rem;
        }
        .n-logo img.nav-logo-img { height: 30px; width: auto; object-fit: contain; }
        .n-links { display: flex; gap: 2rem; list-style: none; }
        .n-links a {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.63rem; letter-spacing: 0.25em; text-transform: uppercase;
            color: var(--dim); text-decoration: none; transition: color 0.3s;
        }
        .n-links a:hover { color: var(--bright); }
        .n-links a.active-link { color: var(--bright); }
        .menu-t { display: none; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; }
        .menu-t span { width: 22px; height: 1px; background: var(--text); }

        /* === HERO === */
        .hero {
            min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            position: relative; padding: 6rem 2rem 4rem;
        }
        .hero::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(ellipse at 50% 30%, rgba(40,40,55,0.22) 0%, transparent 60%);
            pointer-events: none;
        }
        .ptc { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
        .pt {
            position: absolute; width: 2px; height: 2px;
            background: rgba(200,200,200,0.12); border-radius: 50%;
            animation: flt 10s ease-in-out infinite;
        }
        @keyframes flt {
            0%,100% { opacity: 0; transform: translateY(0); }
            15% { opacity: 1; } 85% { opacity: 1; }
            50% { opacity: 0.5; transform: translateY(-100px); }
        }
        .hero-logo-wrap {
            width: 110px; height: 110px; margin-bottom: 2rem; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .sigil { width: 110px; height: 110px; opacity: 0.42; animation: pls 6s ease-in-out infinite; }
        .hero-logo-img {
            max-width: 110px; max-height: 110px; object-fit: contain;
            opacity: 0.75; animation: pls 6s ease-in-out infinite;
        }
        @keyframes pls { 0%,100% { opacity: 0.35; transform: scale(1); } 50% { opacity: 0.55; transform: scale(1.03); } }

        .h-sub {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.67rem; letter-spacing: 0.4em; text-transform: uppercase;
            color: var(--dim); margin-bottom: 1.2rem;
        }
        .h-sub .d { color: var(--accent); }
        .h-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: clamp(2.4rem, 9vw, 4.8rem); font-weight: 400;
            color: var(--bright); letter-spacing: 0.12em; line-height: 1.05;
            margin-bottom: 0.4rem;
        }
        .h-tag {
            font-family: 'Cinzel', serif;
            font-size: clamp(0.82rem, 2.5vw, 1.15rem); font-weight: 400;
            letter-spacing: 0.35em; text-transform: uppercase;
            color: var(--dim); margin-bottom: 1.8rem;
        }
        .h-desc {
            font-size: 1.05rem; font-weight: 300; font-style: italic;
            color: var(--dim); max-width: 470px; line-height: 1.8; margin-bottom: 2.5rem;
        }
        .h-btns { display: flex; flex-direction: column; gap: 0.7rem; align-items: center; }
        .ba, .bb {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.63rem; letter-spacing: 0.3em; text-transform: uppercase;
            padding: 0.9rem 2.6rem; cursor: pointer; transition: all 0.4s;
            text-decoration: none; display: inline-block; text-align: center;
        }
        .ba { background: rgba(200,200,200,0.1); color: var(--bright); border: 1px solid rgba(200,200,200,0.12); }
        .ba:hover { background: rgba(200,200,200,0.18); border-color: rgba(200,200,200,0.25); }
        .bb { background: transparent; color: var(--dim); border: 1px solid rgba(200,200,200,0.06); }
        .bb:hover { color: var(--bright); border-color: rgba(200,200,200,0.15); }

        /* === TICKER === */
        .ticker {
            overflow: hidden; white-space: nowrap; padding: 1.2rem 0;
            border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
            position: relative;
        }
        .ticker::before, .ticker::after {
            content: ''; position: absolute; top: 0; bottom: 0; width: 60px;
            z-index: 2; pointer-events: none;
        }
        .ticker::before { left: 0; background: linear-gradient(90deg, var(--bg), transparent); }
        .ticker::after { right: 0; background: linear-gradient(-90deg, var(--bg), transparent); }
        .tkt { display: inline-flex; animation: sct 22s linear infinite; }
        @keyframes sct { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .tki {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.68rem; letter-spacing: 0.35em; text-transform: uppercase;
            color: var(--dim); padding: 0 1.2rem;
        }
        .tki .d { color: var(--accent); margin-left: 1.2rem; opacity: 0.4; }

        /* === SECTIONS === */
        section { padding: 5rem 2rem; }
        .sl {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.6rem; letter-spacing: 0.4em; text-transform: uppercase;
            color: var(--dim); margin-bottom: 0.8rem;
        }
        .sl .d { color: var(--accent); margin-right: 0.5rem; }
        .st {
            font-family: 'Cinzel Decorative', serif;
            font-size: clamp(1.6rem, 5vw, 2.5rem); font-weight: 400;
            color: var(--bright); letter-spacing: 0.05em; line-height: 1.2;
            margin-bottom: 1.8rem;
        }
        .cw { max-width: 660px; margin: 0 auto; }

        /* === ABOUT === */
        .as { border-top: 1px solid var(--border); }
        .at { font-size: 1.1rem; font-weight: 300; line-height: 1.9; color: var(--text); margin-bottom: 1.3rem; }
        .at strong { color: var(--bright); font-weight: 500; }
        .a-stats { display: flex; gap: 3rem; margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid var(--border); }
        .sn { font-family: 'Cinzel', serif; font-size: 2.2rem; font-weight: 400; color: var(--bright); line-height: 1; }
        .slb { font-family: 'Josefin Sans', sans-serif; font-weight: 200; font-size: 0.55rem; letter-spacing: 0.25em; text-transform: uppercase; color: var(--dim); margin-top: 0.4rem; }

        /* === SERVICES === */
        .ss { border-top: 1px solid var(--border); }
        .sg { display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem; }
        .sc { background: var(--bg2); border: 1px solid var(--border); padding: 2rem; transition: all 0.35s; }
        .sc:hover { border-color: rgba(255,255,255,0.08); background: var(--bg3); }
        .si { font-size: 1.5rem; margin-bottom: 1rem; }
        .snn { font-family: 'Josefin Sans', sans-serif; font-weight: 300; font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--bright); margin-bottom: 0.5rem; }
        .sd { font-size: 0.95rem; font-weight: 300; color: var(--dim); line-height: 1.6; margin-bottom: 0.9rem; }
        .stg {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.58rem; letter-spacing: 0.2em; text-transform: uppercase;
            padding: 0.45rem 0.9rem; border: 1px solid var(--border);
            color: var(--text); display: inline-block;
        }
        a.stg-link { display: inline-block; text-decoration: none; color: inherit; }
        a.stg-link .stg { cursor: pointer; transition: all 0.3s; }
        a.stg-link:hover .stg { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.04); }

        /* === PORTFOLIO === */
        .ps { border-top: 1px solid var(--border); }

        /* Collection Tabs */
        .collection-tabs {
            display: flex; gap: 0.5rem; margin-top: 1rem; margin-bottom: 1.5rem;
            flex-wrap: wrap; align-items: center;
        }
        .col-tab {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.58rem; letter-spacing: 0.18em; text-transform: uppercase;
            padding: 0.55rem 1.1rem; border: 1px solid var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            transition: all 0.3s; border-radius: 2px;
        }
        .col-tab:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .col-tab.active { border-color: rgba(255,255,255,0.3); color: var(--bright); background: rgba(255,255,255,0.04); }
        .col-tab-add {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.58rem; letter-spacing: 0.12em;
            padding: 0.55rem 0.8rem; border: 1px dashed var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            transition: all 0.3s; border-radius: 2px;
            display: flex; align-items: center; gap: 0.35rem;
        }
        .col-tab-add:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .col-tab-add svg { width: 11px; height: 11px; }

        /* Collection Header (name + actions) */
        .col-header {
            display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem;
        }
        .col-name {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase;
            color: var(--dim); font-style: italic;
        }
        .col-actions { display: flex; gap: 0.3rem; }
        .col-act-btn {
            background: none; border: 1px solid var(--border); color: var(--dim);
            font-size: 0.6rem; width: 24px; height: 24px; border-radius: 3px;
            cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .col-act-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .col-act-btn.del:hover { border-color: rgba(200,100,100,0.4); color: #c87070; }
        .col-desc {
            font-family: 'Cormorant Garamond', serif; font-size: 0.95rem;
            font-weight: 300; font-style: italic; color: var(--dim);
            margin-bottom: 1.2rem; line-height: 1.6;
        }

        /* Gallery Grid */
        .gal { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .gi {
            aspect-ratio: 1; background: var(--bg2); border: 1px solid var(--border);
            overflow: hidden; position: relative; cursor: pointer; transition: all 0.35s;
        }
        .gi:hover { border-color: rgba(255,255,255,0.1); }
        .gi img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.5s; }
        .gi:hover img { transform: scale(1.04); }
        .gp {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: var(--dim);
            gap: 0.4rem; font-family: 'Josefin Sans', sans-serif;
            font-size: 0.52rem; letter-spacing: 0.2em; text-transform: uppercase;
            transition: 0.3s;
        }
        .gi:hover .gp { color: var(--text); }
        .gp svg { width: 22px; height: 22px; opacity: 0.3; }
        .gu { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        /* Grid size controls */
        .grid-controls {
            display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;
        }
        .grid-label {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.5rem; letter-spacing: 0.2em; text-transform: uppercase;
            color: var(--dim);
        }
        .grid-btn {
            background: none; border: 1px solid var(--border); color: var(--dim);
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; padding: 0.3rem 0.55rem; border-radius: 3px;
            cursor: pointer; transition: all 0.3s;
        }
        .grid-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .grid-btn.active { border-color: rgba(255,255,255,0.3); color: var(--bright); }

        /* === CONTACT === */
        .cs { border-top: 1px solid var(--border); }
        .cd { font-size: 1.05rem; font-weight: 300; font-style: italic; color: var(--dim); margin-bottom: 2.5rem; line-height: 1.7; }
        .fg { margin-bottom: 1.1rem; }
        .fg input, .fg textarea {
            width: 100%; font-family: 'Cormorant Garamond', serif;
            font-size: 1rem; font-weight: 300; padding: 0.95rem;
            background: transparent; border: 1px solid var(--border);
            color: var(--text); outline: none; transition: border 0.3s;
        }
        .fg input::placeholder, .fg textarea::placeholder { color: var(--dim); font-style: italic; }
        .fg input:focus, .fg textarea:focus { border-color: rgba(255,255,255,0.15); }
        .fg textarea { min-height: 120px; resize: vertical; }
        .fs {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.63rem; letter-spacing: 0.25em; text-transform: uppercase;
            padding: 0.95rem 2.2rem; background: rgba(200,200,200,0.08);
            color: var(--bright); border: 1px solid rgba(200,200,200,0.1);
            cursor: pointer; transition: all 0.3s; display: inline-flex;
            align-items: center; gap: 0.5rem;
        }
        .fs:hover { background: rgba(200,200,200,0.15); }
        .ce { font-family: 'Josefin Sans', sans-serif; font-weight: 300; font-size: 0.72rem; letter-spacing: 0.2em; color: var(--dim); margin-top: 2rem; text-align: center; }
        .cx { display: flex; justify-content: center; gap: 0.7rem; margin-top: 1.3rem; }
        .sx {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.58rem; letter-spacing: 0.15em; text-transform: uppercase;
            padding: 0.55rem 1rem; border: 1px solid var(--border);
            color: var(--dim); text-decoration: none; display: inline-flex;
            align-items: center; gap: 0.4rem; transition: 0.3s;
        }
        .sx:hover { color: var(--bright); border-color: rgba(255,255,255,0.15); }

        /* === FOOTER === */
        footer { text-align: center; padding: 2rem; border-top: 1px solid var(--border); }
        footer p { font-family: 'Josefin Sans', sans-serif; font-weight: 200; font-size: 0.58rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--dim); }

        /* === LIGHTBOX === */
        .lb {
            position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 10001; display: none; align-items: center;
            justify-content: center; cursor: zoom-out;
        }
        .lb.show { display: flex; }
        .lb img { max-width: 92%; max-height: 90vh; object-fit: contain; }

        /* === MODAL (for collection name input) === */
        .modal-bg {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            z-index: 10002; display: none; align-items: center; justify-content: center;
        }
        .modal-bg.show { display: flex; }
        .modal-box {
            background: var(--bg2); border: 1px solid var(--border);
            padding: 2rem; width: 340px; max-width: 90vw; border-radius: 6px;
        }
        .modal-title {
            font-family: 'Cinzel', serif; font-size: 0.85rem;
            color: var(--bright); letter-spacing: 0.12em; margin-bottom: 1.2rem;
        }
        .modal-input {
            width: 100%; font-family: 'Cormorant Garamond', serif;
            font-size: 1rem; font-weight: 300; padding: 0.8rem;
            background: transparent; border: 1px solid var(--border);
            color: var(--text); outline: none; margin-bottom: 0.6rem;
        }
        .modal-input:focus { border-color: rgba(255,255,255,0.15); }
        .modal-input::placeholder { color: var(--dim); font-style: italic; }
        .modal-btns { display: flex; gap: 0.5rem; margin-top: 0.8rem; }
        .modal-btn {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.58rem; letter-spacing: 0.18em; text-transform: uppercase;
            padding: 0.6rem 1.3rem; border: 1px solid var(--border);
            background: transparent; color: var(--text); cursor: pointer;
            transition: all 0.3s; flex: 1; text-align: center;
        }
        .modal-btn:hover { border-color: rgba(255,255,255,0.2); color: var(--bright); }
        .modal-btn.primary { background: rgba(200,200,200,0.08); }

        /* === TEMPLATE SELECTOR === */
        .tpl-selector { margin-bottom: 0.5rem; }
        .tpl-scroll { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; scroll-snap-type: x mandatory; }
        .tpl-scroll::-webkit-scrollbar { height: 3px; }
        .tpl-scroll::-webkit-scrollbar-track { background: var(--border); }
        .tpl-scroll::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 3px; }
        .tpl-card {
            min-width: 130px; padding: 0.7rem; border: 1px solid var(--border);
            border-radius: 5px; cursor: pointer; transition: all 0.3s;
            scroll-snap-align: start; flex-shrink: 0;
        }
        .tpl-card:hover { border-color: rgba(255,255,255,0.15); }
        .tpl-card.active { border-color: rgba(255,255,255,0.35); background: rgba(255,255,255,0.04); }
        .tpl-card-icon { font-size: 1.3rem; margin-bottom: 0.35rem; line-height: 1; }
        .tpl-card-name {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.55rem; letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--bright); margin-bottom: 0.15rem;
        }
        .tpl-card-desc {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.42rem; letter-spacing: 0.08em;
            color: var(--dim); line-height: 1.4;
        }
        .tpl-card-bar { display: flex; gap: 2px; margin-top: 0.4rem; }
        .tpl-card-bar span { height: 2px; flex: 1; border-radius: 1px; opacity: 0.6; }

        /* =================================================================
           TEMPLATE OVERRIDES
           Each template overrides fonts, decorators, spacing, and style
        ================================================================= */

        /* --- PROFESSIONNEL --- */
        body.tpl-pro { font-family: 'Inter', sans-serif; }
        body.tpl-pro .n-logo { font-family: 'Space Grotesk', sans-serif; letter-spacing: 0.15em; font-size: 1rem; }
        body.tpl-pro .n-links a { font-family: 'Inter', sans-serif; font-weight: 400; letter-spacing: 0.12em; }
        body.tpl-pro .h-sub { font-family: 'Inter', sans-serif; font-weight: 400; letter-spacing: 0.3em; }
        body.tpl-pro .h-title { font-family: 'Space Grotesk', sans-serif; font-weight: 700; letter-spacing: 0.04em; }
        body.tpl-pro .h-tag { font-family: 'Inter', sans-serif; font-weight: 300; letter-spacing: 0.25em; }
        body.tpl-pro .h-desc { font-family: 'Inter', sans-serif; font-style: normal; font-weight: 300; }
        body.tpl-pro .st { font-family: 'Space Grotesk', sans-serif; font-weight: 600; letter-spacing: 0.02em; }
        body.tpl-pro .sl { font-family: 'Inter', sans-serif; font-weight: 400; }
        body.tpl-pro .tki { font-family: 'Inter', sans-serif; font-weight: 300; }
        body.tpl-pro .at { font-family: 'Inter', sans-serif; font-size: 1rem; line-height: 1.8; }
        body.tpl-pro .sn { font-family: 'Space Grotesk', sans-serif; }
        body.tpl-pro .slb { font-family: 'Inter', sans-serif; }
        body.tpl-pro .snn { font-family: 'Inter', sans-serif; font-weight: 500; }
        body.tpl-pro .sd { font-family: 'Inter', sans-serif; }
        body.tpl-pro .stg { font-family: 'Inter', sans-serif; }
        body.tpl-pro .ba, body.tpl-pro .bb { font-family: 'Inter', sans-serif; font-weight: 400; letter-spacing: 0.2em; border-radius: 4px; }
        body.tpl-pro .fs { font-family: 'Inter', sans-serif; font-weight: 400; border-radius: 4px; }
        body.tpl-pro .sc { border-radius: 8px; }
        body.tpl-pro .gi { border-radius: 6px; }
        body.tpl-pro .col-tab { font-family: 'Inter', sans-serif; border-radius: 4px; }
        body.tpl-pro .fg input, body.tpl-pro .fg textarea { font-family: 'Inter', sans-serif; border-radius: 4px; }
        body.tpl-pro .ce, body.tpl-pro .sx, body.tpl-pro .cd { font-family: 'Inter', sans-serif; }
        body.tpl-pro footer p { font-family: 'Inter', sans-serif; }
        body.tpl-pro .sigil { border-radius: 50%; }
        body.tpl-pro .modal-title { font-family: 'Space Grotesk', sans-serif; }
        body.tpl-pro .modal-input { font-family: 'Inter', sans-serif; }

        /* --- ARTISTIQUE --- */
        body.tpl-art { font-family: 'Lora', serif; }
        body.tpl-art .n-logo { font-family: 'Playfair Display', serif; letter-spacing: 0.25em; font-weight: 700; }
        body.tpl-art .n-links a { font-family: 'Lora', serif; font-weight: 400; font-style: italic; letter-spacing: 0.15em; }
        body.tpl-art .h-sub { font-family: 'Lora', serif; font-weight: 400; font-style: italic; letter-spacing: 0.3em; }
        body.tpl-art .h-title { font-family: 'Playfair Display', serif; font-weight: 900; letter-spacing: 0.06em; font-style: italic; }
        body.tpl-art .h-tag { font-family: 'Playfair Display', serif; font-weight: 400; letter-spacing: 0.2em; font-style: italic; }
        body.tpl-art .h-desc { font-family: 'Lora', serif; font-weight: 400; font-style: italic; }
        body.tpl-art .st { font-family: 'Playfair Display', serif; font-weight: 700; letter-spacing: 0.04em; font-style: italic; }
        body.tpl-art .sl { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art .tki { font-family: 'Playfair Display', serif; font-weight: 400; font-style: italic; }
        body.tpl-art .at { font-family: 'Lora', serif; font-size: 1.05rem; }
        body.tpl-art .sn { font-family: 'Playfair Display', serif; font-style: italic; }
        body.tpl-art .slb { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art .snn { font-family: 'Lora', serif; font-weight: 600; font-style: italic; letter-spacing: 0.15em; }
        body.tpl-art .sd, body.tpl-art .cd { font-family: 'Lora', serif; }
        body.tpl-art .stg { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art .ba, body.tpl-art .bb { font-family: 'Lora', serif; font-style: italic; letter-spacing: 0.2em; }
        body.tpl-art .fs { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art .sc { border-left: 2px solid var(--accent); border-top: none; border-right: none; border-bottom: none; background: transparent; }
        body.tpl-art .col-tab { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art .fg input, body.tpl-art .fg textarea { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art .ce, body.tpl-art .sx { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art footer p { font-family: 'Lora', serif; font-style: italic; }
        body.tpl-art .gal { gap: 8px; }
        body.tpl-art .gi { border: none; }

        /* --- CYBERPUNK --- */
        body.tpl-cyber { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber .n-logo { font-family: 'Orbitron', sans-serif; letter-spacing: 0.2em; font-size: 0.95rem; font-weight: 700; }
        body.tpl-cyber .n-links a { font-family: 'Share Tech Mono', monospace; letter-spacing: 0.15em; text-transform: uppercase; }
        body.tpl-cyber .h-sub { font-family: 'Share Tech Mono', monospace; letter-spacing: 0.35em; }
        body.tpl-cyber .h-title { font-family: 'Orbitron', sans-serif; font-weight: 900; letter-spacing: 0.08em; text-transform: uppercase; }
        body.tpl-cyber .h-tag { font-family: 'Orbitron', sans-serif; font-weight: 400; letter-spacing: 0.2em; font-size: clamp(0.65rem, 2vw, 0.85rem); }
        body.tpl-cyber .h-desc { font-family: 'Share Tech Mono', monospace; font-style: normal; font-size: 0.9rem; }
        body.tpl-cyber .st { font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; font-size: clamp(1.2rem, 4vw, 1.8rem); }
        body.tpl-cyber .sl { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber .tki { font-family: 'Orbitron', sans-serif; font-weight: 400; font-size: 0.58rem; }
        body.tpl-cyber .at { font-family: 'Share Tech Mono', monospace; font-size: 0.95rem; }
        body.tpl-cyber .sn { font-family: 'Orbitron', sans-serif; }
        body.tpl-cyber .slb { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber .snn { font-family: 'Orbitron', sans-serif; font-weight: 600; font-size: 0.65rem; }
        body.tpl-cyber .sd, body.tpl-cyber .cd { font-family: 'Share Tech Mono', monospace; font-style: normal; }
        body.tpl-cyber .stg { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber .ba, body.tpl-cyber .bb { font-family: 'Orbitron', sans-serif; font-weight: 500; letter-spacing: 0.15em; font-size: 0.55rem; border: 1px solid; clip-path: polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px); border-radius: 0; }
        body.tpl-cyber .ba { border-color: var(--accent); box-shadow: 0 0 15px color-mix(in srgb, var(--accent) 20%, transparent), inset 0 0 15px color-mix(in srgb, var(--accent) 5%, transparent); }
        body.tpl-cyber .fs { font-family: 'Orbitron', sans-serif; font-weight: 500; font-size: 0.55rem; }
        body.tpl-cyber .sc { border: 1px solid var(--border); clip-path: polygon(12px 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%,0 12px); }
        body.tpl-cyber .col-tab { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber .fg input, body.tpl-cyber .fg textarea { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber .ce, body.tpl-cyber .sx { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber footer p { font-family: 'Share Tech Mono', monospace; }
        body.tpl-cyber .sigil { filter: hue-rotate(160deg) brightness(1.5); }

        /* --- ROMANTIQUE --- */
        body.tpl-roman { font-family: 'EB Garamond', serif; }
        body.tpl-roman .n-logo { font-family: 'Cormorant Infant', serif; letter-spacing: 0.3em; font-weight: 600; font-style: italic; }
        body.tpl-roman .n-links a { font-family: 'EB Garamond', serif; font-weight: 400; font-style: italic; letter-spacing: 0.12em; font-size: 0.7rem; }
        body.tpl-roman .h-sub { font-family: 'EB Garamond', serif; font-style: italic; letter-spacing: 0.35em; }
        body.tpl-roman .h-title { font-family: 'Cormorant Infant', serif; font-weight: 300; letter-spacing: 0.15em; font-style: italic; font-size: clamp(2.8rem, 10vw, 5.2rem); }
        body.tpl-roman .h-tag { font-family: 'EB Garamond', serif; font-weight: 400; font-style: italic; letter-spacing: 0.3em; }
        body.tpl-roman .h-desc { font-family: 'EB Garamond', serif; font-style: italic; font-size: 1.1rem; }
        body.tpl-roman .st { font-family: 'Cormorant Infant', serif; font-weight: 300; letter-spacing: 0.08em; font-style: italic; font-size: clamp(1.8rem, 5.5vw, 2.8rem); }
        body.tpl-roman .sl { font-family: 'EB Garamond', serif; font-style: italic; font-size: 0.7rem; }
        body.tpl-roman .tki { font-family: 'Cormorant Infant', serif; font-style: italic; font-weight: 300; font-size: 0.8rem; }
        body.tpl-roman .at { font-family: 'EB Garamond', serif; font-size: 1.15rem; line-height: 2; }
        body.tpl-roman .sn { font-family: 'Cormorant Infant', serif; font-weight: 300; font-style: italic; font-size: 2.6rem; }
        body.tpl-roman .slb { font-family: 'EB Garamond', serif; font-style: italic; font-size: 0.65rem; }
        body.tpl-roman .snn { font-family: 'Cormorant Infant', serif; font-style: italic; font-weight: 500; letter-spacing: 0.15em; }
        body.tpl-roman .sd, body.tpl-roman .cd { font-family: 'EB Garamond', serif; font-style: italic; }
        body.tpl-roman .stg { font-family: 'EB Garamond', serif; font-style: italic; }
        body.tpl-roman .ba, body.tpl-roman .bb { font-family: 'EB Garamond', serif; font-style: italic; letter-spacing: 0.2em; font-size: 0.72rem; border-radius: 30px; }
        body.tpl-roman .fs { font-family: 'EB Garamond', serif; font-style: italic; border-radius: 30px; }
        body.tpl-roman .sc { border-radius: 12px; border: 1px solid var(--border); }
        body.tpl-roman .gi { border-radius: 8px; }
        body.tpl-roman .col-tab { font-family: 'EB Garamond', serif; font-style: italic; border-radius: 20px; }
        body.tpl-roman .fg input, body.tpl-roman .fg textarea { font-family: 'EB Garamond', serif; border-radius: 8px; }
        body.tpl-roman .ce, body.tpl-roman .sx { font-family: 'EB Garamond', serif; font-style: italic; }
        body.tpl-roman .sx { border-radius: 20px; }
        body.tpl-roman footer p { font-family: 'EB Garamond', serif; font-style: italic; }

        /* --- BRUTALISTE --- */
        body.tpl-brut { font-family: 'Space Mono', monospace; }
        body.tpl-brut .n-logo { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.25em; font-size: 1.4rem; }
        body.tpl-brut .n-links a { font-family: 'Space Mono', monospace; font-weight: 700; letter-spacing: 0.1em; font-size: 0.58rem; }
        body.tpl-brut .h-sub { font-family: 'Space Mono', monospace; font-weight: 700; letter-spacing: 0.2em; font-size: 0.6rem; }
        body.tpl-brut .h-title { font-family: 'Bebas Neue', sans-serif; font-weight: 400; letter-spacing: 0.08em; font-size: clamp(3.5rem, 14vw, 7rem); line-height: 0.9; }
        body.tpl-brut .h-tag { font-family: 'Space Mono', monospace; font-weight: 700; letter-spacing: 0.15em; font-size: clamp(0.6rem, 2vw, 0.8rem); text-transform: uppercase; }
        body.tpl-brut .h-desc { font-family: 'Space Mono', monospace; font-style: normal; font-size: 0.85rem; line-height: 1.7; font-weight: 400; }
        body.tpl-brut .st { font-family: 'Bebas Neue', sans-serif; font-weight: 400; letter-spacing: 0.06em; font-size: clamp(2.2rem, 8vw, 4rem); line-height: 0.95; }
        body.tpl-brut .sl { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 0.55rem; }
        body.tpl-brut .tki { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.25em; }
        body.tpl-brut .at { font-family: 'Space Mono', monospace; font-size: 0.88rem; line-height: 1.8; }
        body.tpl-brut .sn { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; }
        body.tpl-brut .slb { font-family: 'Space Mono', monospace; font-weight: 700; }
        body.tpl-brut .snn { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.2em; }
        body.tpl-brut .sd, body.tpl-brut .cd { font-family: 'Space Mono', monospace; font-style: normal; font-size: 0.85rem; }
        body.tpl-brut .stg { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 0.55rem; border-width: 2px; }
        body.tpl-brut .ba, body.tpl-brut .bb { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.2em; font-size: 0.85rem; border-width: 2px; border-radius: 0; }
        body.tpl-brut .fs { font-family: 'Bebas Neue', sans-serif; font-size: 0.85rem; letter-spacing: 0.2em; border-width: 2px; }
        body.tpl-brut .sc { border-width: 2px; background: transparent; }
        body.tpl-brut .sc:hover { background: var(--bg2); }
        body.tpl-brut .gi { border-width: 2px; }
        body.tpl-brut .col-tab { font-family: 'Space Mono', monospace; font-weight: 700; border-width: 2px; }
        body.tpl-brut .fg input, body.tpl-brut .fg textarea { font-family: 'Space Mono', monospace; border-width: 2px; }
        body.tpl-brut .ce, body.tpl-brut .sx { font-family: 'Space Mono', monospace; font-weight: 700; }
        body.tpl-brut .sx { border-width: 2px; }
        body.tpl-brut footer p { font-family: 'Space Mono', monospace; font-weight: 700; }
        body.tpl-brut .ticker { border-width: 2px 0; }
        body.tpl-brut .as, body.tpl-brut .ss, body.tpl-brut .ps, body.tpl-brut .cs { border-top-width: 2px; }

        /* --- JAPONISANT --- */
        body.tpl-zen { font-family: 'Zen Kaku Gothic New', sans-serif; }
        body.tpl-zen .n-logo { font-family: 'Noto Serif Display', serif; letter-spacing: 0.4em; font-weight: 400; font-size: 1rem; }
        body.tpl-zen .n-links a { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.2em; }
        body.tpl-zen .h-sub { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.45em; }
        body.tpl-zen .h-title { font-family: 'Noto Serif Display', serif; font-weight: 300; letter-spacing: 0.2em; font-size: clamp(2rem, 7vw, 3.8rem); }
        body.tpl-zen .h-tag { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.4em; }
        body.tpl-zen .h-desc { font-family: 'Zen Kaku Gothic New', sans-serif; font-style: normal; font-weight: 300; line-height: 2; }
        body.tpl-zen .st { font-family: 'Noto Serif Display', serif; font-weight: 300; letter-spacing: 0.1em; }
        body.tpl-zen .sl { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.45em; }
        body.tpl-zen .tki { font-family: 'Noto Serif Display', serif; font-weight: 300; letter-spacing: 0.4em; font-size: 0.62rem; }
        body.tpl-zen .at { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; line-height: 2.2; }
        body.tpl-zen .sn { font-family: 'Noto Serif Display', serif; font-weight: 300; }
        body.tpl-zen .slb { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.3em; }
        body.tpl-zen .snn { font-family: 'Noto Serif Display', serif; font-weight: 400; letter-spacing: 0.15em; }
        body.tpl-zen .sd, body.tpl-zen .cd { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; font-style: normal; }
        body.tpl-zen .stg { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; }
        body.tpl-zen .ba, body.tpl-zen .bb { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.3em; border: none; border-bottom: 1px solid var(--border); border-radius: 0; background: transparent; }
        body.tpl-zen .ba:hover, body.tpl-zen .bb:hover { border-color: var(--dim); background: transparent; }
        body.tpl-zen .fs { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.3em; border: none; border-bottom: 1px solid var(--border); background: transparent; }
        body.tpl-zen .sc { border: none; border-bottom: 1px solid var(--border); background: transparent; padding: 2rem 0; }
        body.tpl-zen .sc:hover { background: transparent; border-color: var(--dim); }
        body.tpl-zen .gi { border: none; }
        body.tpl-zen .gal { gap: 2px; }
        body.tpl-zen .col-tab { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; border: none; border-bottom: 1px solid transparent; border-radius: 0; }
        body.tpl-zen .col-tab.active { border-bottom-color: var(--bright); background: transparent; }
        body.tpl-zen .fg input, body.tpl-zen .fg textarea { font-family: 'Zen Kaku Gothic New', sans-serif; border: none; border-bottom: 1px solid var(--border); border-radius: 0; }
        body.tpl-zen .ce, body.tpl-zen .sx { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; }
        body.tpl-zen .sx { border: none; border-bottom: 1px solid var(--border); border-radius: 0; }
        body.tpl-zen footer p { font-family: 'Zen Kaku Gothic New', sans-serif; font-weight: 300; letter-spacing: 0.35em; }
        body.tpl-zen .hero { min-height: 90vh; }
        body.tpl-zen section { padding: 6rem 2rem; }

        /* --- STREETWEAR --- */
        body.tpl-street { font-family: 'Barlow Condensed', sans-serif; }
        body.tpl-street .n-logo { font-family: 'Permanent Marker', cursive; letter-spacing: 0.08em; font-size: 1.2rem; text-transform: none; }
        body.tpl-street .n-links a { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; letter-spacing: 0.15em; font-size: 0.7rem; }
        body.tpl-street .h-sub { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; letter-spacing: 0.25em; }
        body.tpl-street .h-title { font-family: 'Permanent Marker', cursive; font-weight: 400; letter-spacing: 0.04em; font-size: clamp(2.6rem, 10vw, 5rem); text-transform: uppercase; line-height: 1; transform: rotate(-2deg); }
        body.tpl-street .h-tag { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; letter-spacing: 0.2em; }
        body.tpl-street .h-desc { font-family: 'Barlow Condensed', sans-serif; font-style: normal; font-weight: 300; font-size: 1.1rem; }
        body.tpl-street .st { font-family: 'Permanent Marker', cursive; font-weight: 400; letter-spacing: 0.02em; font-size: clamp(1.6rem, 5vw, 2.6rem); transform: rotate(-1deg); }
        body.tpl-street .sl { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; }
        body.tpl-street .tki { font-family: 'Permanent Marker', cursive; font-size: 0.75rem; letter-spacing: 0.15em; }
        body.tpl-street .at { font-family: 'Barlow Condensed', sans-serif; font-weight: 300; font-size: 1.1rem; }
        body.tpl-street .sn { font-family: 'Permanent Marker', cursive; }
        body.tpl-street .slb { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; }
        body.tpl-street .snn { font-family: 'Permanent Marker', cursive; letter-spacing: 0.08em; font-size: 0.85rem; }
        body.tpl-street .sd, body.tpl-street .cd { font-family: 'Barlow Condensed', sans-serif; font-style: normal; font-weight: 300; }
        body.tpl-street .stg { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; border-width: 2px; }
        body.tpl-street .ba, body.tpl-street .bb { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; letter-spacing: 0.18em; font-size: 0.72rem; border-radius: 0; border-width: 2px; transform: rotate(-1deg); }
        body.tpl-street .fs { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 0.72rem; border-width: 2px; }
        body.tpl-street .sc { border: 2px solid var(--border); background: var(--bg2); transform: rotate(-0.5deg); transition: all 0.3s; }
        body.tpl-street .sc:hover { transform: rotate(0deg); }
        body.tpl-street .gi { border-width: 2px; }
        body.tpl-street .col-tab { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; }
        body.tpl-street .fg input, body.tpl-street .fg textarea { font-family: 'Barlow Condensed', sans-serif; font-weight: 300; }
        body.tpl-street .ce, body.tpl-street .sx { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; }
        body.tpl-street footer p { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; }

        /* === LIGHT THEME OVERRIDES === */
        body.light-theme { --glow: 0,0,0; }
        body.light-theme nav { background: rgba(244,242,239,0.9); border-bottom-color: var(--border); }
        body.light-theme .n-links.open { background: rgba(244,242,239,0.98); }
        body.light-theme .menu-t span { background: var(--text); }
        body.light-theme .hero::before { background: radial-gradient(ellipse at 50% 30%, rgba(0,0,0,0.03) 0%, transparent 60%); }
        body.light-theme .pt { background: rgba(0,0,0,0.06); }
        body.light-theme .ba { background: rgba(0,0,0,0.06); color: var(--bright); border-color: rgba(0,0,0,0.1); }
        body.light-theme .ba:hover { background: rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.18); }
        body.light-theme .bb { border-color: rgba(0,0,0,0.06); }
        body.light-theme .bb:hover { border-color: rgba(0,0,0,0.15); }
        body.light-theme .ticker::before { background: linear-gradient(90deg, var(--bg), transparent); }
        body.light-theme .ticker::after { background: linear-gradient(-90deg, var(--bg), transparent); }
        body.light-theme .sc { background: var(--bg2); }
        body.light-theme .sc:hover { background: var(--bg3); border-color: rgba(0,0,0,0.08); }
        body.light-theme .gi:hover { border-color: rgba(0,0,0,0.12); }
        body.light-theme .gp { color: var(--dim); }
        body.light-theme .gi:hover .gp { color: var(--text); }
        body.light-theme .fg input, body.light-theme .fg textarea { border-color: var(--border); }
        body.light-theme .fg input:focus, body.light-theme .fg textarea:focus { border-color: rgba(0,0,0,0.2); }
        body.light-theme .fs { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); color: var(--bright); }
        body.light-theme .fs:hover { background: rgba(0,0,0,0.1); }
        body.light-theme .sx:hover { border-color: rgba(0,0,0,0.15); }
        body.light-theme .editable:hover { box-shadow: 0 0 0 1px rgba(0,0,0,0.06); }
        body.light-theme .editable:focus { box-shadow: 0 0 0 2px rgba(0,0,0,0.1); background: rgba(0,0,0,0.015); }
        body.light-theme .col-tab:hover { border-color: rgba(0,0,0,0.12); }
        body.light-theme .col-tab.active { border-color: rgba(0,0,0,0.25); background: rgba(0,0,0,0.03); }
        body.light-theme .lb { background: rgba(255,255,255,0.92); }
        body.light-theme .sigil circle, body.light-theme .sigil polygon,
        body.light-theme .sigil line, body.light-theme .sigil rect,
        body.light-theme .sigil path, body.light-theme .sigil ellipse { stroke: rgba(0,0,0,0.12); }

        /* === THEME NUANCE SLIDERS === */
        .nuance-panel {
            margin-top: 0.6rem; padding: 0.8rem; border: 1px solid var(--border);
            border-radius: 5px;
        }
        .nuance-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.6rem; }
        .nuance-row:last-child { margin-bottom: 0; }
        .nuance-label {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.46rem; letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--dim); min-width: 70px;
        }
        .nuance-slider {
            -webkit-appearance: none; appearance: none; flex: 1; height: 3px;
            background: var(--border); outline: none; border-radius: 3px;
        }
        .nuance-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px;
            border-radius: 50%; background: var(--text); cursor: pointer;
            border: 2px solid var(--bg); box-shadow: 0 0 0 1px var(--border);
        }
        .nuance-slider::-moz-range-thumb {
            width: 14px; height: 14px; border-radius: 50%;
            background: var(--text); cursor: pointer;
            border: 2px solid var(--bg); box-shadow: 0 0 0 1px var(--border);
        }
        .nuance-val {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.08em;
            color: var(--dim); min-width: 32px; text-align: right;
        }
        .nuance-reset {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.46rem; letter-spacing: 0.12em; text-transform: uppercase;
            padding: 0.35rem 0.6rem; border: 1px solid var(--border);
            background: transparent; color: var(--dim); cursor: pointer;
            border-radius: 3px; transition: all 0.3s; margin-top: 0.4rem;
            display: inline-flex; align-items: center; gap: 0.3rem;
        }
        .nuance-reset:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .nuance-preview {
            display: flex; gap: 3px; margin-top: 0.5rem; margin-bottom: 0.3rem;
        }
        .nuance-preview-dot {
            width: 20px; height: 20px; border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.08); transition: background 0.3s;
        }

        /* === CUSTOM BODY SECTIONS === */
        .custom-sections-area { margin-top: 0; }
        .custom-section-block {
            border-top: 1px solid var(--border); padding: 5rem 2rem;
            position: relative; z-index: 1;
        }
        .csb-inner {
            max-width: 660px; margin: 0 auto;
            display: flex; gap: 2rem; align-items: flex-start;
        }
        .csb-inner.layout-left { flex-direction: row; }
        .csb-inner.layout-right { flex-direction: row-reverse; }
        .csb-inner.layout-top { flex-direction: column; align-items: center; text-align: center; }
        .csb-img-wrap {
            flex: 0 0 220px; aspect-ratio: 1; overflow: hidden;
            border: 1px solid var(--border); background: var(--bg2);
            position: relative; cursor: pointer; transition: border 0.3s;
        }
        .csb-inner.layout-top .csb-img-wrap { flex: 0 0 auto; width: 100%; max-width: 500px; aspect-ratio: 16/9; }
        .csb-inner.layout-textonly { flex-direction: column; align-items: center; text-align: center; }
        .csb-inner.layout-textonly .csb-img-wrap { display: none; }
        .csb-inner.layout-textonly .csb-text { max-width: 600px; }
        .csb-img-wrap:hover { border-color: rgba(255,255,255,0.12); }
        .csb-img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .csb-img-placeholder {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: var(--dim);
            gap: 0.4rem; font-family: 'Josefin Sans', sans-serif;
            font-size: 0.5rem; letter-spacing: 0.15em; text-transform: uppercase;
        }
        .csb-img-placeholder svg { width: 28px; height: 28px; opacity: 0.3; }
        .csb-img-wrap input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .csb-text { flex: 1; min-width: 0; }
        .csb-title {
            font-family: 'Cinzel', serif; font-size: 1.3rem; font-weight: 500;
            color: var(--bright); letter-spacing: 0.08em; margin-bottom: 0.8rem;
            line-height: 1.3;
        }
        .csb-desc {
            font-family: 'Cormorant Garamond', serif; font-size: 1rem; font-weight: 300;
            color: var(--text); line-height: 1.8;
        }
        .csb-actions {
            position: absolute; top: 1rem; right: 1rem;
            display: flex; gap: 0.3rem; opacity: 0; transition: opacity 0.3s; z-index: 2;
        }
        .custom-section-block:hover .csb-actions { opacity: 1; }
        .csb-act-btn {
            background: rgba(10,10,10,0.9); border: 1px solid var(--border);
            color: var(--dim); font-size: 0.6rem; width: 26px; height: 26px;
            border-radius: 4px; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .csb-act-btn:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }
        .csb-act-btn.del:hover { border-color: rgba(200,100,100,0.4); color: #c87070; }

        /* Custom sections panel controls */
        .csb-panel-item {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.6rem; border: 1px solid var(--border); border-radius: 4px;
            margin-bottom: 0.4rem; transition: background 0.2s;
        }
        .csb-panel-item:hover { background: rgba(255,255,255,0.02); }
        .csb-panel-thumb {
            width: 36px; height: 36px; border-radius: 3px; overflow: hidden;
            border: 1px solid var(--border); flex-shrink: 0;
            background: var(--bg2); display: flex; align-items: center; justify-content: center;
        }
        .csb-panel-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .csb-panel-thumb svg { width: 16px; height: 16px; color: var(--dim); opacity: 0.4; }
        .csb-panel-info { flex: 1; min-width: 0; }
        .csb-panel-name {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.5rem; letter-spacing: 0.1em; color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .csb-panel-layout {
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.42rem; letter-spacing: 0.08em; color: var(--dim);
            margin-top: 1px;
        }
        .csb-panel-btns { display: flex; gap: 0.2rem; flex-shrink: 0; }
        .csb-panel-btn {
            background: none; border: 1px solid var(--border); color: var(--dim);
            font-size: 0.55rem; width: 22px; height: 22px; border-radius: 3px;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .csb-panel-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
        .csb-panel-btn.del:hover { border-color: rgba(200,100,100,0.4); color: #c87070; }
        .csb-add-btn {
            display: flex; align-items: center; justify-content: center;
            gap: 0.4rem; padding: 0.65rem; cursor: pointer;
            border: 1px dashed var(--border); border-radius: 4px;
            transition: all 0.3s;
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.48rem; letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--dim); margin-top: 0.3rem;
        }
        .csb-add-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); background: rgba(255,255,255,0.02); }
        .csb-add-btn svg { width: 12px; height: 12px; }
        .csb-empty {
            padding: 0.8rem; text-align: center;
            font-family: 'Josefin Sans', sans-serif; font-weight: 200;
            font-size: 0.44rem; letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--dim); opacity: 0.5;
        }

        /* Layout picker modal */
        .layout-picker-bg {
            position: fixed; inset: 0; z-index: 10003; background: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center;
        }
        .layout-picker-bg.show { display: flex; }
        .layout-picker-box {
            background: var(--bg2); border: 1px solid var(--border);
            padding: 1.5rem; border-radius: 6px; width: 320px; max-width: 90vw;
        }
        .layout-picker-title {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--bright); margin-bottom: 1rem;
        }
        .layout-opts { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
        .layout-opt {
            padding: 0.8rem 0.5rem; border: 1px solid var(--border); border-radius: 5px;
            cursor: pointer; text-align: center; transition: all 0.3s;
        }
        .layout-opt:hover { border-color: rgba(255,255,255,0.15); }
        .layout-opt-icon { font-size: 1.4rem; margin-bottom: 0.3rem; }
        .layout-opt-name {
            font-family: 'Josefin Sans', sans-serif; font-weight: 300;
            font-size: 0.48rem; letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--text);
        }

        @media (max-width: 768px) {
            .csb-inner { flex-direction: column !important; }
            .csb-img-wrap { flex: 0 0 auto; width: 100%; aspect-ratio: 16/9; }
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            nav { padding: 0.8rem 1.2rem; }
            .n-links { display: none; }
            .menu-t { display: flex; }
            .n-links.open {
                display: flex; flex-direction: column;
                position: absolute; top: 100%; left: 0; right: 0;
                background: rgba(10,10,10,0.97); padding: 1.5rem 2rem;
                border-bottom: 1px solid var(--border); gap: 1rem;
            }
            section { padding: 3.5rem 1.5rem; }
            .a-stats { gap: 1.5rem; }
            .sn { font-size: 1.6rem; }
            .tp { width: 290px; right: -300px; }
            .edit-toolbar { bottom: 0.8rem; right: 0.8rem; }
            .collection-tabs { gap: 0.35rem; }
        }

        /* === V2: PANEL TABS === */
        .tp-tabs { display:flex; gap:0; border-bottom:1px solid var(--border); margin:-0.5rem -1.3rem 1rem; padding:0 1.3rem; }
        .tp-tab {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.15em; text-transform:uppercase;
            color:var(--dim); padding:0.6rem 0.55rem; cursor:pointer;
            border-bottom:1px solid transparent; transition:color 0.2s, border-color 0.2s;
            margin-bottom:-1px; white-space:nowrap;
        }
        .tp-tab:hover { color:var(--text); }
        .tp-tab.active { color:var(--bright); border-bottom-color:rgba(255,255,255,0.4); }
        .tp-pane { display:none; }
        .tp-pane.active { display:block; }
        .tp-mini-label {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.15em; text-transform:uppercase;
            color:var(--dim); margin:0.8rem 0 0.5rem; opacity:0.7;
        }
        .tp-choice-row { display:flex; gap:0.25rem; flex-wrap:wrap; margin-bottom:0.5rem; }
        .tp-chip {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.1em; text-transform:uppercase;
            padding:0.35rem 0.55rem; border:1px solid var(--border);
            background:transparent; color:var(--dim); cursor:pointer;
            border-radius:2px; transition:border-color 0.2s, color 0.2s;
        }
        .tp-chip:hover { border-color:rgba(255,255,255,0.12); color:var(--text); }
        .tp-chip.active { border-color:rgba(255,255,255,0.25); color:var(--bright); }

        /* === V2: HERO LAYOUTS === */
        .hero.hero-split { flex-direction:row; text-align:left; padding:0; gap:0; }
        .hero.hero-split .hero-text { flex:1; padding:6rem 3rem 4rem; display:flex; flex-direction:column; justify-content:center; }
        .hero.hero-split .hero-media { flex:1; min-height:100vh; background:var(--bg2); position:relative; overflow:hidden; }
        .hero.hero-split .hero-media img { width:100%; height:100%; object-fit:cover; }
        .hero.hero-split .hero-media .hero-media-placeholder {
            width:100%; height:100%; display:flex; align-items:center; justify-content:center;
            color:var(--dim); font-family:'Josefin Sans',sans-serif; font-size:0.5rem;
            letter-spacing:0.2em; text-transform:uppercase; flex-direction:column; gap:0.5rem;
        }
        .hero.hero-split .hero-media .hero-media-placeholder svg { width:32px; height:32px; opacity:0.2; }
        .hero.hero-split .hero-logo-wrap { margin-bottom:1.5rem; align-self:flex-start; }
        .hero.hero-split .h-btns { align-items:flex-start; flex-direction:row; gap:0.5rem; }
        .hero.hero-fullscreen { padding:0; }
        .hero.hero-fullscreen .hero-bg-media {
            position:absolute; inset:0; z-index:0;
            background:var(--bg2);
        }
        .hero.hero-fullscreen .hero-bg-media img { width:100%; height:100%; object-fit:cover; }
        .hero.hero-fullscreen .hero-overlay {
            position:absolute; inset:0; z-index:1;
            background:linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0.7));
        }
        .hero.hero-fullscreen .hero-logo-wrap,
        .hero.hero-fullscreen .h-sub,
        .hero.hero-fullscreen .h-title,
        .hero.hero-fullscreen .h-tag,
        .hero.hero-fullscreen .h-desc,
        .hero.hero-fullscreen .h-btns { position:relative; z-index:2; }
        .hero.hero-minimal { padding:8rem 2rem 6rem; }
        .hero.hero-minimal .hero-logo-wrap,
        .hero.hero-minimal .h-sub,
        .hero.hero-minimal .h-desc,
        .hero.hero-minimal .h-btns { display:none; }
        .hero.hero-minimal .h-title { font-size:clamp(3.5rem,14vw,8rem); letter-spacing:0.02em; margin-bottom:0.2rem; }
        .hero.hero-minimal .h-tag { font-size:clamp(0.7rem,2vw,1rem); letter-spacing:0.5em; opacity:0.5; }

        /* === V2: GALLERY LAYOUTS === */
        .gal.gal-masonry {
            display:block; columns:var(--gal-cols,2);
            column-gap:4px;
        }
        .gal.gal-masonry .gi {
            aspect-ratio:auto; break-inside:avoid; margin-bottom:4px;
            display:block;
        }
        .gal.gal-masonry .gi img { height:auto; }
        .gal.gal-hscroll {
            display:flex; gap:4px; overflow-x:auto; overflow-y:hidden;
            scroll-snap-type:x mandatory; padding-bottom:0.5rem;
            grid-template-columns:none !important;
        }
        .gal.gal-hscroll::-webkit-scrollbar { height:3px; }
        .gal.gal-hscroll::-webkit-scrollbar-track { background:var(--border); }
        .gal.gal-hscroll::-webkit-scrollbar-thumb { background:var(--dim); border-radius:3px; }
        .gal.gal-hscroll .gi {
            flex:0 0 70vw; max-width:500px; scroll-snap-align:center;
            aspect-ratio:4/3;
        }
        .gal.gal-showcase {
            display:flex; flex-direction:column; gap:1.5rem;
            grid-template-columns:none !important;
        }
        .gal.gal-showcase .gi {
            aspect-ratio:16/9; border:none; background:none;
        }
        .gal.gal-list {
            display:flex; flex-direction:column; gap:0;
            grid-template-columns:none !important;
        }
        .gal.gal-list .gi {
            aspect-ratio:auto; height:3.5rem; border:none;
            border-bottom:1px solid var(--border); display:flex;
            align-items:center; overflow:visible; position:relative;
        }
        .gal.gal-list .gi img {
            position:absolute; right:0; top:50%; transform:translateY(-50%);
            width:200px; height:140px; object-fit:cover; opacity:0;
            transition:opacity 0.4s; pointer-events:none; z-index:10;
            border:1px solid var(--border);
        }
        .gal.gal-list .gi:hover img { opacity:1; }
        .gal.gal-list .gi .gp { align-items:flex-start; justify-content:center; }

        /* === V2: HOVER EFFECTS === */
        .hover-overlay .gi::after {
            content:''; position:absolute; inset:0; background:rgba(0,0,0,0.6);
            opacity:0; transition:opacity 0.4s; pointer-events:none;
        }
        .hover-overlay .gi:hover::after { opacity:1; }
        .hover-bw .gi img { filter:grayscale(100%); transition:filter 0.5s, transform 0.5s; }
        .hover-bw .gi:hover img { filter:grayscale(0%); }
        .hover-blur .gi img { filter:blur(3px); transition:filter 0.5s, transform 0.5s; }
        .hover-blur .gi:hover img { filter:blur(0); }
        .hover-border .gi { border:2px solid transparent; }
        .hover-border .gi:hover { border-color:var(--accent); }

        /* === V2: SCROLL ANIMATIONS === */
        .scroll-anim [data-anim] { opacity:0; transform:translateY(18px); transition:opacity 0.6s ease, transform 0.6s ease; }
        .scroll-anim [data-anim].anim-in { opacity:1; transform:translateY(0); }
        .scroll-anim [data-anim="slide-left"] { transform:translateX(-18px); }
        .scroll-anim [data-anim="slide-left"].anim-in { transform:translateX(0); }
        .scroll-anim [data-anim="slide-right"] { transform:translateX(18px); }
        .scroll-anim [data-anim="slide-right"].anim-in { transform:translateX(0); }
        .scroll-anim [data-anim="scale"] { transform:scale(0.97); }
        .scroll-anim [data-anim="scale"].anim-in { transform:scale(1); }

        /* === V2: CURSOR DOT === */
        .cursor-dot {
            position:fixed; width:5px; height:5px; background:var(--bright);
            border-radius:50%; pointer-events:none; z-index:99999;
            transition:transform 0.12s ease, opacity 0.2s;
            mix-blend-mode:difference; opacity:0;
        }
        .cursor-dot.visible { opacity:1; }
        .cursor-ring {
            position:fixed; width:28px; height:28px;
            border:0.5px solid var(--bright); border-radius:50%;
            pointer-events:none; z-index:99998;
            transition:transform 0.06s ease, width 0.2s, height 0.2s, opacity 0.2s;
            mix-blend-mode:difference; opacity:0;
            transform:translate(-50%,-50%);
        }
        .cursor-ring.visible { opacity:0.35; }
        .cursor-ring.hover { width:42px; height:42px; opacity:0.6; }

        /* === V2: AUDIO PLAYER === */
        .audio-player {
            position:fixed; bottom:1rem; left:1rem; z-index:9998;
            display:none; align-items:center; gap:0.4rem;
            padding:0.4rem 0.6rem; background:rgba(10,10,10,0.9);
            backdrop-filter:blur(12px); border:1px solid var(--border);
            border-radius:3px;
        }
        .audio-player.active { display:flex; }
        .audio-btn {
            background:none; border:none; color:var(--dim);
            cursor:pointer; font-size:0.65rem; padding:0.15rem;
            transition:color 0.2s; line-height:1;
        }
        .audio-btn:hover { color:var(--bright); }
        .audio-title {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.38rem; letter-spacing:0.1em; text-transform:uppercase;
            color:var(--dim); max-width:80px; overflow:hidden;
            text-overflow:ellipsis; white-space:nowrap;
        }
        .audio-progress {
            width:40px; height:1.5px; background:var(--border);
            border-radius:1px; overflow:hidden; cursor:pointer;
        }
        .audio-progress-fill { height:100%; background:var(--dim); width:0; transition:width 0.1s linear; }

        /* === V2: PRESET GRID === */
        .preset-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.35rem; }
        .preset-card {
            padding:0.5rem 0.35rem; border:1px solid var(--border); border-radius:3px;
            cursor:pointer; transition:border-color 0.3s; text-align:center;
        }
        .preset-card:hover { border-color:rgba(255,255,255,0.12); }
        .preset-card-icon { font-size:0.9rem; margin-bottom:0.15rem; }
        .preset-card-name {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--dim);
        }

        /* === V2: CONFIRM MODAL === */
        .v2-confirm-bg {
            position:fixed; inset:0; z-index:10004; background:rgba(0,0,0,0.6);
            display:none; align-items:center; justify-content:center;
        }
        .v2-confirm-bg.show { display:flex; }
        .v2-confirm-box {
            background:var(--bg2); border:1px solid var(--border);
            padding:1.5rem; border-radius:4px; width:300px; max-width:90vw;
            text-align:center;
        }
        .v2-confirm-icon { font-size:1.6rem; margin-bottom:0.4rem; }
        .v2-confirm-title {
            font-family:'Josefin Sans',sans-serif; font-weight:300; font-size:0.6rem;
            color:var(--bright); letter-spacing:0.15em; margin-bottom:0.3rem; text-transform:uppercase;
        }
        .v2-confirm-desc {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.06em; color:var(--dim);
            line-height:1.4; margin-bottom:0.6rem;
        }
        .v2-confirm-warn {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.38rem; color:rgba(200,100,100,0.7); margin-bottom:0.8rem;
            line-height:1.3;
        }
        .v2-confirm-btns { display:flex; gap:0.4rem; }
        .v2-confirm-btn {
            font-family:'Josefin Sans',sans-serif; font-weight:300;
            font-size:0.44rem; letter-spacing:0.12em; text-transform:uppercase;
            padding:0.5rem 0.7rem; border:1px solid var(--border);
            background:transparent; color:var(--text); cursor:pointer;
            transition:border-color 0.3s; flex:1; border-radius:2px;
        }
        .v2-confirm-btn:hover { border-color:rgba(255,255,255,0.2); }
        .v2-confirm-btn.go { background:rgba(255,255,255,0.04); }

        /* === V2: NEW TEMPLATE OVERRIDES === */
        body.tpl-editorial .n-logo { font-family:'Libre Baskerville',serif; letter-spacing:0.2em; font-weight:700; }
        body.tpl-editorial .n-links a { font-family:'DM Sans',sans-serif; font-weight:400; letter-spacing:0.15em; }
        body.tpl-editorial .h-sub { font-family:'DM Sans',sans-serif; font-weight:400; letter-spacing:0.35em; }
        body.tpl-editorial .h-title { font-family:'Libre Baskerville',serif; font-weight:700; letter-spacing:0.03em; }
        body.tpl-editorial .h-tag { font-family:'DM Sans',sans-serif; font-weight:300; letter-spacing:0.25em; }
        body.tpl-editorial .h-desc { font-family:'Libre Baskerville',serif; font-style:italic; }
        body.tpl-editorial .st { font-family:'Libre Baskerville',serif; font-weight:700; letter-spacing:0.02em; }
        body.tpl-editorial .sl { font-family:'DM Sans',sans-serif; }
        body.tpl-editorial .tki { font-family:'DM Sans',sans-serif; font-weight:300; }
        body.tpl-editorial .at { font-family:'Libre Baskerville',serif; font-size:1.05rem; line-height:2; }
        body.tpl-editorial .sn { font-family:'Libre Baskerville',serif; }
        body.tpl-editorial .slb,.snn,.sd,.stg,.cd,.ce,.sx { font-family:'DM Sans',sans-serif; }
        body.tpl-editorial .ba,body.tpl-editorial .bb { font-family:'DM Sans',sans-serif; font-weight:400; letter-spacing:0.2em; border-radius:0; }
        body.tpl-editorial .fs { font-family:'DM Sans',sans-serif; border-radius:0; }
        body.tpl-editorial .sc { border-radius:0; border-left:2px solid var(--accent); border-top:0; border-right:0; border-bottom:0; }
        body.tpl-editorial .col-tab,body.tpl-editorial .fg input,body.tpl-editorial .fg textarea { font-family:'DM Sans',sans-serif; }
        body.tpl-editorial footer p { font-family:'DM Sans',sans-serif; }

        body.tpl-retro .n-logo { font-family:'Abril Fatface',serif; letter-spacing:0.15em; font-weight:400; }
        body.tpl-retro .n-links a { font-family:'Source Sans 3',sans-serif; font-weight:400; letter-spacing:0.12em; }
        body.tpl-retro .h-sub { font-family:'Source Sans 3',sans-serif; letter-spacing:0.3em; }
        body.tpl-retro .h-title { font-family:'Abril Fatface',serif; font-weight:400; letter-spacing:0.04em; }
        body.tpl-retro .h-tag { font-family:'Source Sans 3',sans-serif; letter-spacing:0.3em; font-weight:300; }
        body.tpl-retro .h-desc { font-family:'Source Sans 3',sans-serif; font-weight:300; font-style:normal; }
        body.tpl-retro .st { font-family:'Abril Fatface',serif; font-weight:400; letter-spacing:0.03em; }
        body.tpl-retro .sl { font-family:'Source Sans 3',sans-serif; }
        body.tpl-retro .tki { font-family:'Abril Fatface',serif; font-weight:400; font-size:0.7rem; }
        body.tpl-retro .at { font-family:'Source Sans 3',sans-serif; font-size:1.05rem; }
        body.tpl-retro .sn { font-family:'Abril Fatface',serif; }
        body.tpl-retro .slb { font-family:'Source Sans 3',sans-serif; }
        body.tpl-retro .snn { font-family:'Source Sans 3',sans-serif; font-weight:600; }
        body.tpl-retro .sd,.stg,.cd { font-family:'Source Sans 3',sans-serif; }
        body.tpl-retro .ba,body.tpl-retro .bb { font-family:'Source Sans 3',sans-serif; font-weight:400; letter-spacing:0.2em; border-radius:20px; }
        body.tpl-retro .fs { font-family:'Source Sans 3',sans-serif; border-radius:20px; }
        body.tpl-retro .sc { border-radius:12px; }
        body.tpl-retro .gi { border-radius:8px; }
        body.tpl-retro .col-tab { font-family:'Source Sans 3',sans-serif; border-radius:20px; }
        body.tpl-retro footer p { font-family:'Source Sans 3',sans-serif; }

        body.tpl-neo .n-logo { font-family:'Syne',sans-serif; letter-spacing:0.12em; font-weight:700; }
        body.tpl-neo .n-links a { font-family:'Syne',sans-serif; font-weight:400; letter-spacing:0.1em; }
        body.tpl-neo .h-sub { font-family:'Syne',sans-serif; font-weight:500; letter-spacing:0.3em; }
        body.tpl-neo .h-title { font-family:'Syne',sans-serif; font-weight:800; letter-spacing:0.02em; }
        body.tpl-neo .h-tag { font-family:'Syne',sans-serif; font-weight:400; letter-spacing:0.2em; }
        body.tpl-neo .h-desc { font-family:'Syne',sans-serif; font-weight:400; font-style:normal; }
        body.tpl-neo .st { font-family:'Syne',sans-serif; font-weight:700; letter-spacing:0.02em; }
        body.tpl-neo .sl { font-family:'Syne',sans-serif; font-weight:500; }
        body.tpl-neo .tki { font-family:'Syne',sans-serif; font-weight:500; }
        body.tpl-neo .at { font-family:'Syne',sans-serif; font-weight:400; font-size:1rem; line-height:1.8; }
        body.tpl-neo .sn { font-family:'Syne',sans-serif; font-weight:700; }
        body.tpl-neo .slb { font-family:'Syne',sans-serif; }
        body.tpl-neo .snn { font-family:'Syne',sans-serif; font-weight:600; }
        body.tpl-neo .sd,.cd { font-family:'Syne',sans-serif; }
        body.tpl-neo .ba,body.tpl-neo .bb { font-family:'Syne',sans-serif; font-weight:500; letter-spacing:0.15em; border-radius:6px; }
        body.tpl-neo .fs { font-family:'Syne',sans-serif; border-radius:6px; }
        body.tpl-neo .sc { border-radius:10px; }
        body.tpl-neo .gi { border-radius:8px; }
        body.tpl-neo .col-tab { font-family:'Syne',sans-serif; border-radius:6px; }
        body.tpl-neo footer p { font-family:'Syne',sans-serif; }

        body.tpl-organic .n-logo { font-family:'Fraunces',serif; letter-spacing:0.1em; font-weight:400; font-style:italic; }
        body.tpl-organic .n-links a { font-family:'Karla',sans-serif; font-weight:400; letter-spacing:0.12em; }
        body.tpl-organic .h-sub { font-family:'Karla',sans-serif; letter-spacing:0.3em; }
        body.tpl-organic .h-title { font-family:'Fraunces',serif; font-weight:300; letter-spacing:0.02em; font-style:italic; font-size:clamp(2.6rem,10vw,5rem); }
        body.tpl-organic .h-tag { font-family:'Fraunces',serif; font-weight:300; letter-spacing:0.2em; font-style:italic; }
        body.tpl-organic .h-desc { font-family:'Karla',sans-serif; font-weight:300; font-style:normal; }
        body.tpl-organic .st { font-family:'Fraunces',serif; font-weight:400; letter-spacing:0.02em; font-style:italic; }
        body.tpl-organic .sl { font-family:'Karla',sans-serif; }
        body.tpl-organic .tki { font-family:'Fraunces',serif; font-weight:300; font-style:italic; }
        body.tpl-organic .at { font-family:'Karla',sans-serif; font-size:1.05rem; line-height:1.9; }
        body.tpl-organic .sn { font-family:'Fraunces',serif; font-style:italic; }
        body.tpl-organic .slb { font-family:'Karla',sans-serif; }
        body.tpl-organic .snn { font-family:'Karla',sans-serif; font-weight:600; }
        body.tpl-organic .sd,.cd { font-family:'Karla',sans-serif; }
        body.tpl-organic .ba,body.tpl-organic .bb { font-family:'Karla',sans-serif; letter-spacing:0.18em; border-radius:30px; }
        body.tpl-organic .fs { font-family:'Karla',sans-serif; border-radius:30px; }
        body.tpl-organic .sc { border-radius:16px; border:none; background:var(--bg2); }
        body.tpl-organic .gi { border-radius:12px; }
        body.tpl-organic .col-tab { font-family:'Karla',sans-serif; border-radius:20px; }
        body.tpl-organic footer p { font-family:'Karla',sans-serif; }

        body.tpl-grunge .n-logo { font-family:'Rubik Mono One',monospace; letter-spacing:0.05em; font-size:0.9rem; }
        body.tpl-grunge .n-links a { font-family:'Roboto Mono',monospace; font-weight:400; letter-spacing:0.08em; text-transform:uppercase; }
        body.tpl-grunge .h-sub { font-family:'Roboto Mono',monospace; letter-spacing:0.25em; }
        body.tpl-grunge .h-title { font-family:'Rubik Mono One',monospace; font-weight:400; letter-spacing:0.02em; text-transform:uppercase; font-size:clamp(2rem,8vw,4rem); }
        body.tpl-grunge .h-tag { font-family:'Roboto Mono',monospace; letter-spacing:0.15em; }
        body.tpl-grunge .h-desc { font-family:'Roboto Mono',monospace; font-style:normal; font-size:0.9rem; }
        body.tpl-grunge .st { font-family:'Rubik Mono One',monospace; font-weight:400; letter-spacing:0.02em; font-size:clamp(1.3rem,4vw,2rem); text-transform:uppercase; }
        body.tpl-grunge .sl { font-family:'Roboto Mono',monospace; }
        body.tpl-grunge .tki { font-family:'Rubik Mono One',monospace; font-size:0.55rem; }
        body.tpl-grunge .at { font-family:'Roboto Mono',monospace; font-size:0.95rem; }
        body.tpl-grunge .sn { font-family:'Rubik Mono One',monospace; }
        body.tpl-grunge .slb { font-family:'Roboto Mono',monospace; }
        body.tpl-grunge .snn { font-family:'Roboto Mono',monospace; font-weight:500; }
        body.tpl-grunge .sd,.cd { font-family:'Roboto Mono',monospace; }
        body.tpl-grunge .ba,body.tpl-grunge .bb { font-family:'Roboto Mono',monospace; font-weight:500; letter-spacing:0.1em; border-radius:0; border:2px solid; }
        body.tpl-grunge .fs { font-family:'Roboto Mono',monospace; border-radius:0; }
        body.tpl-grunge .sc { border-radius:0; border:2px solid var(--border); }
        body.tpl-grunge .gi { border-radius:0; }
        body.tpl-grunge .col-tab { font-family:'Roboto Mono',monospace; border-radius:0; }
        body.tpl-grunge footer p { font-family:'Roboto Mono',monospace; }



        /* === V2: BACKGROUND IMAGE === */
        #bgImgLayer {
            position:fixed; inset:0; z-index:0; pointer-events:none;
            display:none; overflow:hidden;
        }
        #bgImgLayer.active { display:block; }
        #bgImgLayer img {
            width:100%; height:100%; display:block;
        }
        /* Modes */
        #bgImgLayer.bgimg-cover img { object-fit:cover; }
        #bgImgLayer.bgimg-contain img { object-fit:contain; }
        #bgImgLayer.bgimg-fixed { position:fixed; }
        #bgImgLayer.bgimg-scroll { position:absolute; height:auto; min-height:100%; }
        #bgImgLayer.bgimg-parallax { position:fixed; }
        #bgImgLayer.bgimg-parallax img { transform:scale(1.15); transition:transform 0.1s linear; }
        #bgImgLayer.bgimg-tile img { display:none; }
        #bgImgLayer.bgimg-tile {
            background-repeat:repeat; background-size:auto;
        }

        /* Panel controls for bg image */
        .bgimg-zone {
            border:1px dashed var(--border); border-radius:4px;
            padding:0.8rem; text-align:center; cursor:pointer;
            transition:border-color 0.2s; position:relative; margin-top:0.3rem;
        }
        .bgimg-zone:hover { border-color:rgba(255,255,255,0.15); }
        .bgimg-zone svg { width:22px; height:22px; color:var(--dim); margin-bottom:0.3rem; opacity:0.5; }
        .bgimg-zone .luz-text { display:block; }
        .bgimg-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; }
        .bgimg-preview {
            display:none; align-items:center; gap:0.6rem;
            padding:0.5rem; border:1px solid var(--border); border-radius:4px;
            margin-top:0.3rem;
        }
        .bgimg-preview.active { display:flex; }
        .bgimg-preview img {
            width:42px; height:42px; object-fit:cover; border-radius:3px;
            background:rgba(255,255,255,0.03);
        }
        .bgimg-preview-info { flex:1; min-width:0; }
        .bgimg-preview-name {
            font-family:'Josefin Sans',sans-serif; font-weight:300;
            font-size:0.46rem; letter-spacing:0.08em; color:var(--text);
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:120px;
        }
        .bgimg-controls { display:none; margin-top:0.5rem; }
        .bgimg-controls.active { display:block; }
        .bgimg-slider-row { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; }
        .bgimg-slider-label {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.1em; color:var(--dim);
            min-width:45px; text-transform:uppercase;
        }


        /* === V2d: SLOT DELETE BUTTON === */
        .gi-del {
            position:absolute; top:4px; right:4px; z-index:3;
            width:20px; height:20px; border-radius:50%;
            background:rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.15);
            color:rgba(255,255,255,0.5); font-size:0.55rem; cursor:pointer;
            display:flex; align-items:center; justify-content:center;
            opacity:0; transition:opacity 0.2s, color 0.2s, border-color 0.2s;
            line-height:1;
        }
        .gi:hover .gi-del { opacity:1; }
        .gi-del:hover { color:#ff6060; border-color:rgba(255,100,100,0.5); background:rgba(40,0,0,0.9); }

        /* === V2d: COLLECTION COVER CARDS === */
        .col-covers {
            display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr));
            gap:12px; margin-top:1rem;
        }
        .col-cover-card {
            position:relative; aspect-ratio:3/4; background:var(--bg2);
            border:1px solid var(--border); overflow:hidden; cursor:pointer;
            transition:border-color 0.3s, transform 0.3s;
        }
        .col-cover-card:hover { border-color:rgba(255,255,255,0.15); transform:translateY(-2px); }
        .col-cover-card img {
            width:100%; height:100%; object-fit:cover; display:block;
            transition:transform 0.5s;
        }
        .col-cover-card:hover img { transform:scale(1.04); }
        .col-cover-card .col-cover-info {
            position:absolute; bottom:0; left:0; right:0;
            padding:1.5rem 1rem 1rem;
            background:linear-gradient(transparent, rgba(0,0,0,0.85));
        }
        .col-cover-card .col-cover-name {
            font-family:'Josefin Sans',sans-serif; font-weight:300;
            font-size:0.6rem; letter-spacing:0.2em; text-transform:uppercase;
            color:#fff;
        }
        .col-cover-card .col-cover-count {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.15em; color:rgba(255,255,255,0.5);
            margin-top:0.2rem;
        }
        .col-cover-card .col-cover-empty {
            width:100%; height:100%; display:flex; align-items:center;
            justify-content:center; color:var(--dim);
        }
        .col-cover-card .col-cover-empty svg { width:32px; height:32px; opacity:0.2; }
        /* Cover upload in editor */
        .col-cover-upload {
            margin-bottom:0.6rem; display:flex; align-items:center; gap:0.5rem;
        }
        .col-cover-upload .col-cover-thumb {
            width:36px; height:48px; object-fit:cover; border-radius:2px;
            border:1px solid var(--border);
        }
        .col-cover-upload label {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.1em; color:var(--dim);
            cursor:pointer; border:1px solid var(--border); padding:0.25rem 0.5rem;
            border-radius:2px; transition:border-color 0.2s;
        }
        .col-cover-upload label:hover { border-color:rgba(255,255,255,0.15); color:var(--text); }
        .col-cover-upload input { display:none; }
        /* Back button in expanded collection */
        .col-back-btn {
            background:none; border:1px solid var(--border); color:var(--dim);
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.48rem; letter-spacing:0.15em; text-transform:uppercase;
            padding:0.4rem 0.8rem; border-radius:2px; cursor:pointer;
            transition:all 0.2s; margin-bottom:1rem;
        }
        .col-back-btn:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }

        /* === V2d: PREVIEW MODE === */
        body.preview-mode .edit-toolbar,
        body.preview-mode .save-badge,
        body.preview-mode .save-confirm,
        body.preview-mode .tp,
        body.preview-mode .ov,
        body.preview-mode .col-tab-add,
        body.preview-mode .grid-controls,
        body.preview-mode .col-actions,
        body.preview-mode .csb-actions,
        body.preview-mode .gi-del,
        body.preview-mode .gu,
        body.preview-mode .gp,
        body.preview-mode .col-cover-upload,
        body.preview-mode .modal-bg,
        body.preview-mode .soc-picker-bg,
        body.preview-mode .layout-picker-bg,
        body.preview-mode .v2-confirm-bg { display:none !important; }
        body.preview-mode [contenteditable] {
            cursor:default !important; outline:none !important;
            -webkit-user-modify:read-only !important;
        }
        body.preview-mode .editable:hover { background:none !important; }
        body.preview-mode .gi:not(.gi-has-img) { display:none !important; }
        .preview-bar {
            position:fixed; top:0; left:0; right:0; z-index:10000;
            background:rgba(0,0,0,0.92); backdrop-filter:blur(10px);
            border-bottom:1px solid rgba(255,255,255,0.08);
            padding:0.5rem 1.2rem; display:none; align-items:center; gap:1rem;
        }
        body.preview-mode .preview-bar { display:flex; }
        .preview-bar-label {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.46rem; letter-spacing:0.2em; text-transform:uppercase;
            color:rgba(255,255,255,0.5);
        }
        .preview-bar-dot {
            width:6px; height:6px; border-radius:50%; background:#40c870;
            animation:previewPulse 2s ease-in-out infinite;
        }
        @keyframes previewPulse { 0%,100%{opacity:1;}50%{opacity:0.3;} }
        .preview-bar-exit {
            margin-left:auto; background:none; border:1px solid rgba(255,255,255,0.15);
            color:rgba(255,255,255,0.6); font-family:'Josefin Sans',sans-serif;
            font-weight:200; font-size:0.42rem; letter-spacing:0.15em;
            text-transform:uppercase; padding:0.35rem 0.8rem; border-radius:2px;
            cursor:pointer; transition:all 0.2s;
        }
        .preview-bar-exit:hover { border-color:rgba(255,255,255,0.3); color:#fff; }

        /* === V2d: EXTRA CUSTOMIZATION — Card corners, spacing, etc === */
        .tp-mini-row { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; }
        .tp-mini-label {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; letter-spacing:0.1em; text-transform:uppercase;
            color:var(--dim); min-width:65px;
        }
        .tp-mini-val {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.42rem; color:var(--dim); min-width:32px; text-align:right;
        }
        /* Card corner radius variations */
        body.cards-sharp .sc, body.cards-sharp .gi { border-radius:0; }
        body.cards-round .sc, body.cards-round .gi { border-radius:8px; }
        body.cards-pill .sc, body.cards-pill .gi { border-radius:20px; }
        body.cards-round .gi img, body.cards-pill .gi img { border-radius:inherit; }
        /* Nav style variations */
        body.nav-solid nav { background:var(--bg2) !important; backdrop-filter:none !important; border-bottom:1px solid var(--border); }
        body.nav-hidden nav { display:none !important; }
        body.nav-minimal nav { background:transparent !important; border:none !important; backdrop-filter:none !important; }
        body.nav-minimal nav a { color:var(--dim); }
        /* Section spacing */
        body.spacing-compact section { padding:3rem 2rem; }
        body.spacing-wide section { padding:7rem 2rem; }
        /* Gallery gap */
        body.galgap-none .gal { gap:0; }
        body.galgap-small .gal { gap:2px; }
        body.galgap-medium .gal { gap:8px; }
        body.galgap-large .gal { gap:16px; }
        /* Scroll to top button */
        .scroll-top-btn {
            position:fixed; bottom:1.5rem; right:1.5rem; z-index:90;
            width:36px; height:36px; border-radius:50%;
            background:rgba(var(--accent-rgb,128,128,128),0.2); border:1px solid var(--border);
            color:var(--dim); cursor:pointer; display:none;
            align-items:center; justify-content:center;
            transition:all 0.3s; backdrop-filter:blur(8px);
        }
        .scroll-top-btn.visible { display:flex; }
        .scroll-top-btn:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }
        .scroll-top-btn svg { width:16px; height:16px; }
        body.preview-mode .scroll-top-btn.visible { display:flex; }

        /* === V2: PEDAGOGICAL HINTS === */
        .tp-hint {
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.38rem; letter-spacing:0.04em; color:var(--dim);
            line-height:1.4; margin:-0.2rem 0 0.5rem; opacity:0.55;
            font-style:italic;
        }
        .tp-opt[title] { position:relative; }
        .tp-opt[title]:hover::after {
            content:attr(title); position:absolute; bottom:calc(100% + 4px); left:50%;
            transform:translateX(-50%); padding:0.3rem 0.5rem;
            background:rgba(0,0,0,0.9); color:var(--text); border:1px solid var(--border);
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.38rem; letter-spacing:0.05em; white-space:nowrap;
            border-radius:2px; z-index:10; pointer-events:none;
        }
        .tp-chip[title]:hover::after {
            content:attr(title); position:absolute; bottom:calc(100% + 4px); left:50%;
            transform:translateX(-50%); padding:0.3rem 0.5rem;
            background:rgba(0,0,0,0.9); color:var(--text); border:1px solid var(--border);
            font-family:'Josefin Sans',sans-serif; font-weight:200;
            font-size:0.38rem; letter-spacing:0.05em; white-space:nowrap;
            border-radius:2px; z-index:10; pointer-events:none;
        }
        .tp-chip { position:relative; }

        /* === V2: RESPONSIVE ADDITIONS === */
        @media (max-width:768px) {
            .hero.hero-split { flex-direction:column; }
            .hero.hero-split .hero-text { padding:5rem 1.5rem 2rem; min-height:auto; }
            .hero.hero-split .hero-media { min-height:50vh; flex:0 0 auto; }
            .hero.hero-split .h-btns { flex-direction:column; }
            .hero.hero-minimal .h-title { font-size:clamp(2.5rem,12vw,5rem); }
            .gal.gal-hscroll .gi { flex:0 0 85vw; }
            .tp-tabs { overflow-x:auto; -webkit-overflow-scrolling:touch; }
            .audio-player { left:0.6rem; bottom:0.6rem; }
            .preset-grid { grid-template-columns:1fr 1fr; }
        }

    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<!-- V2: Cursor -->
<div class="cursor-dot" id="cursorDot"></div>
<div class="cursor-ring" id="cursorRing"></div>

<!-- V2: Audio Player -->
<div class="audio-player" id="audioPlayer">
    <button class="audio-btn" id="audioPlayBtn" onclick="toggleAudio()">▶</button>
    <div class="audio-title" id="audioTitle">—</div>
    <div class="audio-progress" id="audioProgress" onclick="seekAudio(event)">
        <div class="audio-progress-fill" id="audioFill"></div>
    </div>
    <button class="audio-btn" id="audioRemoveBtn" onclick="removeAudio()" title="Retirer">✕</button>
    <audio id="audioEl"></audio>
</div>

<!-- BACKGROUND LAYER -->
<div class="preview-bar" id="previewBar">
    <div class="preview-bar-dot"></div>
    <span class="preview-bar-label">Mode Aperçu — Vue visiteur</span>
    <button class="preview-bar-exit" onclick="exitPreview()">✕ Quitter l'aperçu</button>
</div>
<button class="scroll-top-btn" id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>
</button>
<div id="bgLayer"></div>

<!-- ONBOARDING -->
<div class="onboard-bg" id="onboardBg" style="display:none;">
    <div class="onboard-box">
        <svg class="onboard-sigil" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="0.5" opacity="0.4">
            <rect x="30" y="30" width="140" height="140" rx="8"/>
            <circle cx="100" cy="100" r="50"/>
            <circle cx="100" cy="100" r="6"/>
        </svg>
        <div class="onboard-title">FOLYO</div>
        <div class="onboard-sub">Créez votre portfolio. Un fichier. Zéro code.</div>
        <div class="onboard-steps">
            <div class="onboard-step">
                <div class="onboard-num">1</div>
                <div class="onboard-step-text">Cliquez sur <strong>⚙ Personnaliser</strong> en bas à droite pour ouvrir le panneau d'édition (thèmes, couleurs, polices, layouts).</div>
            </div>
            <div class="onboard-step">
                <div class="onboard-num">2</div>
                <div class="onboard-step-text"><strong>Cliquez directement sur les textes</strong> du site pour les modifier. Tout est éditable : titres, descriptions, stats.</div>
            </div>
            <div class="onboard-step">
                <div class="onboard-num">5</div>
                <div class="onboard-step-text">Ajoutez vos œuvres dans l'onglet <strong>Portfolio</strong>. Créez des collections, uploadez vos images.</div>
            </div>
            <div class="onboard-step">
                <div class="onboard-num">4</div>
                <div class="onboard-step-text">Quand c'est prêt, cliquez <strong>📦 Exporter ZIP</strong> pour télécharger votre site complet, prêt à déployer sur GitHub Pages. Hébergez-le n'importe où.</div>
            </div>
        </div>
        <button class="onboard-go" onclick="closeOnboard()">✦ COMMENCER</button>
        <button class="onboard-skip" onclick="closeOnboard()">Ne plus afficher</button>
    </div>
</div>


<div id="bgImgLayer"><img id="bgImgEl" src="" alt=""></div>

<!-- NAV -->
<nav>
    <a href="#" class="n-logo" id="navLogo"><span class="editable" contenteditable="true">FOLYO</span></a>
    <ul class="n-links" id="nLinks">
        <li><a href="#portfolio">Portfolio</a></li>
        <!-- dynamic nav links injected by page manager -->
        <li><a href="#about">À propos</a></li>
        <li><a href="#services">Services</a></li>
        <li><a href="#contact">Contact</a></li>
    </ul>
    <div class="menu-t" onclick="document.getElementById('nLinks').classList.toggle('open')">
        <span></span><span></span><span></span>
    </div>
</nav>

<!-- HERO -->
<section class="hero" id="hero">
    <div class="ptc" id="ptc"></div>
    <div class="hero-logo-wrap" id="heroLogoWrap">
        <svg class="sigil" id="defaultSigil" viewBox="0 0 200 200" fill="none">
            <rect x="30" y="30" width="140" height="140" rx="8" stroke="rgba(200,200,200,0.12)" stroke-width="0.8"/>
            <circle cx="100" cy="100" r="50" stroke="rgba(200,200,200,0.18)" stroke-width="1"/>
            <circle cx="100" cy="100" r="30" stroke="rgba(200,200,200,0.1)" stroke-width="0.5"/>
            <circle cx="100" cy="100" r="6" stroke="rgba(200,200,200,0.15)" stroke-width="0.8" fill="none"/>
            <line x1="100" y1="30" x2="100" y2="50" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/>
            <line x1="100" y1="150" x2="100" y2="170" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/>
            <line x1="30" y1="100" x2="50" y2="100" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/>
            <line x1="150" y1="100" x2="170" y2="100" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/>
        </svg>
    </div>
    <p class="h-sub"><span class="d">◆</span> <span class="editable" contenteditable="true">CREATIVE STUDIO</span> <span class="d">◆</span></p>
    <h1 class="h-title editable" contenteditable="true">FOLYO</h1>
    <p class="h-tag editable" contenteditable="true">BUILD DIFFERENT. STAND OUT.</p>
    <p class="h-desc editable" contenteditable="true">Un site à votre image en quelques minutes. Design premium, export clé en main, déploiement instantané. Pas de compromis, pas de templates génériques — juste votre vision, amplifiée.</p>
    <div class="h-btns">
        <a href="#contact" class="ba editable" contenteditable="true">LANCER UN PROJET</a>
        <a href="#portfolio" class="bb editable" contenteditable="true">DÉCOUVRIR LE TRAVAIL</a>
    </div>
    <div class="hero-media" id="heroMedia" style="display:none;">
        <div class="hero-media-placeholder" id="heroMediaPlaceholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            <span>Importer une image hero</span>
            <input type="file" accept="image/*" class="gu" onchange="handleHeroMedia(event)">
        </div>
        <img id="heroMediaImg" src="" alt="" style="display:none;">
    </div>
</section>

<!-- TICKER -->
<div class="ticker">
    <div class="tkt" id="tkt">
        <span class="tki">STRATEGY <span class="d">◆</span></span>
        <span class="tki">DESIGN <span class="d">◆</span></span>
        <span class="tki">BRANDING <span class="d">◆</span></span>
        <span class="tki">VISION <span class="d">◆</span></span>
        <span class="tki">CRAFT <span class="d">◆</span></span>
        <span class="tki">IMPACT <span class="d">◆</span></span>
        <span class="tki">BOLD <span class="d">◆</span></span>
        <span class="tki">EXECUTE <span class="d">◆</span></span>
        <span class="tki">STRATEGY <span class="d">◆</span></span>
        <span class="tki">DESIGN <span class="d">◆</span></span>
        <span class="tki">BRANDING <span class="d">◆</span></span>
        <span class="tki">VISION <span class="d">◆</span></span>
        <span class="tki">CRAFT <span class="d">◆</span></span>
        <span class="tki">IMPACT <span class="d">◆</span></span>
        <span class="tki">BOLD <span class="d">◆</span></span>
        <span class="tki">EXECUTE <span class="d">◆</span></span>
    </div>
</div>

<!-- PORTFOLIO -->
<section class="ps" id="portfolio">
    <div class="cw">
        <p class="sl" data-anim="fade"><span class="d">◆</span> PORTFOLIO</p>
        <h2 class="st editable" contenteditable="true" data-anim="fade">SELECTED WORK</h2>
        <div class="collection-tabs" id="colTabs"></div>
        <div id="colContent"></div>
    </div>
</section>

<!-- ABOUT -->
<section class="as" id="about">
    <div class="cw">
        <p class="sl" data-anim="fade"><span class="d">◆</span> À PROPOS</p>
        <h2 class="st editable" contenteditable="true" data-anim="fade">À PROPOS</h2>
        <p class="at"><span class="editable" contenteditable="true">Studio créatif indépendant. On conçoit des identités qui marquent, des visuels qui convertissent, et des expériences qui restent.</span></p>
        <p class="at"><span class="editable" contenteditable="true">Notre approche : rigueur stratégique, exécution sans concession, et une allergie profonde au générique. Chaque projet est traité comme s'il allait redéfinir les standards.</span></p>
        <div class="a-stats" data-anim="fade">
            <div><div class="sn editable" contenteditable="true">120+</div><div class="slb">PROJETS</div></div>
            <div><div class="sn editable" contenteditable="true">5</div><div class="slb">ANS</div></div>
            <div><div class="sn editable" contenteditable="true">100%</div><div class="slb">CLIENTS SATISFAITS</div></div>
        </div>
    </div>
</section>

<!-- SERVICES -->
<section class="ss" id="services">
    <div class="cw">
        <p class="sl" data-anim="fade"><span class="d">◆</span> SERVICES</p>
        <h2 class="st editable" contenteditable="true" data-anim="fade">NOS SERVICES</h2>
        <div class="sg">
            <div class="sc" data-anim="fade">
                <div class="si">◉</div>
                <div class="snn editable" contenteditable="true">DIRECTION ARTISTIQUE</div>
                <div class="sd editable" contenteditable="true">Création d'illustrations originales. Noir & blanc, couleur, techniques mixtes.</div>
                <span class="stg editable" contenteditable="true">Sur mesure</span>
            </div>
            <div class="sc" data-anim="fade">
                <div class="si">▲</div>
                <div class="snn editable" contenteditable="true">DESIGN & PRODUCTION</div>
                <div class="sd editable" contenteditable="true">Web design, supports print, motion. Du concept à la livraison, on gère.</div>
                <span class="stg editable" contenteditable="true">Sur devis</span>
            </div>
            <div class="sc" data-anim="fade">
                <div class="si">⬡</div>
                <div class="snn editable" contenteditable="true">STRATÉGIE DIGITALE</div>
                <div class="sd editable" contenteditable="true">Positionnement, contenu, déploiement. On transforme votre présence en avantage compétitif.</div>
                <span class="stg editable" contenteditable="true">Nous contacter</span>
            </div>
        </div>
    </div>
</section>

<!-- CUSTOM BODY SECTIONS -->
<div id="customSectionsArea" class="custom-sections-area"></div>

<!-- CONTACT -->
<section class="cs" id="contact">
    <div class="cw">
        <p class="sl" data-anim="fade"><span class="d">◆</span> CONTACT</p>
        <h2 class="st editable" contenteditable="true" data-anim="fade">PARLONS PROJET</h2>
        <p class="cd editable" contenteditable="true">Un brief, une idée, une ambition ? On répond sous 24h. Pas de chatbot, pas de formulaire sans fin — juste une vraie conversation.</p>
        <form id="contactForm" onsubmit="handleFormSubmit(event)">
            <input type="hidden" name="access_key" id="formAccessKey" value="">
            <input type="hidden" name="_subject" id="formSubjectHidden" value="Nouveau message portfolio">
            <div class="fg"><input type="text" name="name" id="formName" placeholder="Votre nom" required></div>
            <div class="fg"><input type="email" name="email" id="formEmail" placeholder="Votre email" required></div>
            <div class="fg"><input type="text" name="subject" id="formSubject" placeholder="Sujet"></div>
            <div class="fg"><textarea name="message" id="formMessage" placeholder="Votre message..."></textarea></div>
            <button class="fs" type="submit" id="formSubmitBtn">ENVOYER →</button>
        </form>
        <p class="ce editable" contenteditable="true"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="22414d4c56434156624f434547474b4c490c414d4f">[email&#160;protected]</a></p>
        <div class="cx" id="socialLinks"></div>
        <div class="quick-links-bar" id="quickLinksBar"></div>
    </div>
</section>

<!-- TOAST -->
<div class="form-toast" id="formToast">
    <div class="form-toast-icon" id="toastIcon">✓</div>
    <div>
        <div class="form-toast-text" id="toastText">Message envoyé !</div>
        <div class="form-toast-sub" id="toastSub"></div>
    </div>
</div>

<!-- SOCIAL ICON PICKER -->
<div class="soc-picker-bg" id="socPickerBg" onclick="if(event.target===this)closeSocPicker()">
    <div class="soc-picker-box">
        <div class="soc-picker-title">Choisir une icône</div>
        <div class="soc-picker-grid" id="socPickerGrid"></div>
        <div class="soc-picker-custom">
            <input type="text" id="socPickerCustom" placeholder="Emoji personnalisé…" maxlength="4">
            <button onclick="pickCustomIcon()">OK</button>
        </div>
    </div>
</div>

<!-- LAYOUT PICKER MODAL -->
<div class="layout-picker-bg" id="layoutPickerBg" onclick="if(event.target===this)closeLayoutPicker()">
    <div class="layout-picker-box">
        <div class="layout-picker-title">Disposition de la section</div>
        <div class="layout-opts">
            <div class="layout-opt" onclick="pickLayout('left')">
                <div class="layout-opt-icon">◧</div>
                <div class="layout-opt-name">Image gauche</div>
            </div>
            <div class="layout-opt" onclick="pickLayout('right')">
                <div class="layout-opt-icon">◨</div>
                <div class="layout-opt-name">Image droite</div>
            </div>
            <div class="layout-opt" onclick="pickLayout('top')">
                <div class="layout-opt-icon">⬒</div>
                <div class="layout-opt-name">Image haut</div>
            </div>
            <div class="layout-opt" onclick="pickLayout('textonly')" style="grid-column:1/-1;">
                <div class="layout-opt-icon">¶</div>
                <div class="layout-opt-name">Bloc de texte seul</div>
            </div>
        </div>
    </div>
</div>

<!-- V2: Preset Confirm Modal -->
<div class="v2-confirm-bg" id="presetConfirmBg" onclick="if(event.target===this)closePresetConfirm()">
    <div class="v2-confirm-box">
        <div class="v2-confirm-icon" id="presetConfirmIcon"></div>
        <div class="v2-confirm-title" id="presetConfirmTitle"></div>
        <div class="v2-confirm-desc" id="presetConfirmDesc"></div>
        <div class="v2-confirm-warn">⚠ Textes, couleurs et paramètres actuels seront remplacés.</div>
        <div class="v2-confirm-btns">
            <button class="v2-confirm-btn" onclick="closePresetConfirm()">Annuler</button>
            <button class="v2-confirm-btn go" onclick="confirmPresetApply()">Appliquer</button>
        </div>
    </div>
</div>

<footer><p class="editable" contenteditable="true">© <span id="footerYear">2025</span> FOLYO — Tous droits réservés. Built different.</p></footer>

<!-- THEME PANEL -->
<div class="tp" id="tp">
    <button class="tp-close" onclick="closeTP()">✕</button>
    <div class="tp-title">PERSONNALISATION</div>

    <!-- TABS -->
    <div class="tp-tabs">
        <div class="tp-tab active" onclick="switchTab('style')">Style</div>
        <div class="tp-tab" onclick="switchTab('layout')">Layout</div>
        <div class="tp-tab" onclick="switchTab('anim')">Anim.</div>
        <div class="tp-tab" onclick="switchTab('preset')">Preset</div>
        <div class="tp-tab" onclick="switchTab('config')">Config</div>
    </div>

    <!-- ====== TAB: STYLE ====== -->
    <div class="tp-pane active" id="pane-style">
        <!-- Template Selector -->
        <div class="tp-label">Template</div>
        <div class="tp-hint">Change la typographie et le caractère visuel global de votre site.</div>
        <div class="tpl-selector">
            <div class="tpl-scroll" id="tplScroll"></div>
        </div>

        <!-- Logo Section -->
        <div class="tp-label">Logo</div>
        <div class="logo-upload-zone" id="logoUploadZone">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <span class="luz-text">Importer un logo</span>
            <input type="file" accept="image/png,image/jpeg,image/svg+xml,image/webp,image/gif" id="logoFileInput">
        </div>
        <div class="logo-preview-wrap" id="logoPreview">
            <img id="logoPreviewImg" src="" alt="Logo">
            <div class="logo-preview-info">
                <div class="logo-preview-name" id="logoPreviewName"></div>
                <div class="logo-preview-size" id="logoPreviewSize"></div>
            </div>
            <button class="logo-remove" onclick="removeLogo()" title="Supprimer">✕</button>
        </div>

        <!-- Background -->
        <div class="tp-label" style="margin-top:1.5rem;">Fond</div>
        <div class="tp-hint">Ajoute une texture ou un effet de lumière derrière le contenu.</div>
        <div class="tp-grid" id="bgGrid"></div>
        <div class="bgfx-controls" id="bgfxControls">
            <div class="tp-label" style="margin-top:0;">Couleur</div>
            <div class="bgfx-row">
                <input type="color" class="bgfx-color-input" id="bgfxColorPicker" value="#888888">
                <input type="text" class="bgfx-hex" id="bgfxHexInput" value="#888888" maxlength="7" spellcheck="false">
                <button class="bgfx-auto-btn active" id="bgfxAutoBtn" onclick="toggleBgfxAuto()">⟳ Auto</button>
            </div>
            <div class="bgfx-row"><div class="bgfx-swatches" id="bgfxSwatches"></div></div>
            <div class="tp-label">Intensité</div>
            <div class="bgfx-row bgfx-intensity-row">
                <span class="bgfx-slider-label" id="bgfxIntVal">100%</span>
                <input type="range" class="bgfx-slider" id="bgfxIntSlider" min="10" max="100" value="100">
            </div>
        </div>


        <!-- Background Image -->
        <div class="tp-label" style="margin-top:1.2rem;">Image de fond</div>
        <div class="tp-hint">Photo ou texture en arrière-plan. Se combine avec les effets ci-dessus.</div>
        <div class="bgimg-zone" id="bgImgZone">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            <span class="luz-text">Importer une image</span>
            <input type="file" accept="image/*" id="bgImgInput" onchange="handleBgImgUpload(event)">
        </div>
        <div class="bgimg-preview" id="bgImgPreview">
            <img id="bgImgThumb" src="" alt="">
            <div class="bgimg-preview-info">
                <div class="bgimg-preview-name" id="bgImgName"></div>
            </div>
            <button class="logo-remove" onclick="removeBgImg()" title="Supprimer">✕</button>
        </div>
        <div class="bgimg-controls" id="bgImgControls">
            <div class="tp-mini-label">Mode d'affichage</div>
            <div class="tp-hint">Cover = remplit l'écran · Contenir = image entière visible · Fixe = ne bouge pas au scroll · Scroll = défile avec la page · Parallaxe = léger décalage au scroll · Mosaïque = image répétée</div>
            <div class="tp-choice-row" id="bgImgModeRow"></div>
            <div class="tp-mini-label">Opacité</div>
            <div class="bgimg-slider-row">
                <span class="bgimg-slider-label" id="bgImgOpVal">30%</span>
                <input type="range" class="bgfx-slider" id="bgImgOpSlider" min="5" max="100" value="30" oninput="setBgImgOpacity(this.value)">
            </div>
            <div class="tp-mini-label">Luminosité</div>
            <div class="bgimg-slider-row">
                <span class="bgimg-slider-label" id="bgImgBrVal">100%</span>
                <input type="range" class="bgfx-slider" id="bgImgBrSlider" min="10" max="200" value="100" oninput="setBgImgBrightness(this.value)">
            </div>
            <div class="tp-mini-label">Flou</div>
            <div class="bgimg-slider-row">
                <span class="bgimg-slider-label" id="bgImgBlVal">0px</span>
                <input type="range" class="bgfx-slider" id="bgImgBlSlider" min="0" max="30" value="0" oninput="setBgImgBlur(this.value)">
            </div>
        </div>

        <!-- Themes -->
        <div class="tp-label" style="margin-top:1.5rem;">Ambiance</div>
        <div class="tp-hint">Palette de couleurs complète : fond, texte, accent.</div>
        <div class="tp-grid" id="tpg"></div>

        <!-- Nuances -->
        <div class="nuance-panel" id="nuancePanel">
            <div class="tp-label" style="margin-top:0;">Nuances</div>
            <div class="tp-hint">Ajustez finement les couleurs de l'ambiance choisie ci-dessus.</div>
            <div class="nuance-preview" id="nuancePreview"></div>
            <div class="nuance-row">
                <span class="nuance-label">Teinte</span>
                <input type="range" class="nuance-slider" id="nuanceHue" min="-180" max="180" value="0">
                <span class="nuance-val" id="nuanceHueVal">0°</span>
            </div>
            <div class="nuance-row">
                <span class="nuance-label">Saturation</span>
                <input type="range" class="nuance-slider" id="nuanceSat" min="-100" max="100" value="0">
                <span class="nuance-val" id="nuanceSatVal">0%</span>
            </div>
            <div class="nuance-row">
                <span class="nuance-label">Luminosité</span>
                <input type="range" class="nuance-slider" id="nuanceLum" min="-50" max="50" value="0">
                <span class="nuance-val" id="nuanceLumVal">0%</span>
            </div>
            <div class="nuance-row">
                <span class="nuance-label">Contraste</span>
                <input type="range" class="nuance-slider" id="nuanceCon" min="-50" max="50" value="0">
                <span class="nuance-val" id="nuanceConVal">0%</span>
            </div>
            <button class="nuance-reset" onclick="resetNuance()">⟳ Réinitialiser</button>
        </div>

        <!-- Advanced Color Overrides -->
        <div class="tp-label" style="margin-top:1.5rem;">Couleurs avancées</div>
        <div class="tp-hint">Remplacez individuellement chaque couleur de l'ambiance. Cliquez ⟳ pour revenir au thème.</div>
        <div class="adv-color-row">
            <span class="adv-color-label">Fond</span>
            <input type="color" class="adv-color-input" id="advColBg" value="#0a0a0a" oninput="setAdvColor('bg',this.value)">
            <input type="text" class="adv-color-hex" id="advColBgHex" value="#0a0a0a" maxlength="7" oninput="setAdvColorHex('bg',this.value)">
            <button class="adv-color-reset" onclick="resetAdvColor('bg')" title="Reset">⟳</button>
        </div>
        <div class="adv-color-row">
            <span class="adv-color-label">Fond 2</span>
            <input type="color" class="adv-color-input" id="advColBg2" value="#111111" oninput="setAdvColor('bg2',this.value)">
            <input type="text" class="adv-color-hex" id="advColBg2Hex" value="#111111" maxlength="7" oninput="setAdvColorHex('bg2',this.value)">
            <button class="adv-color-reset" onclick="resetAdvColor('bg2')" title="Reset">⟳</button>
        </div>
        <div class="adv-color-row">
            <span class="adv-color-label">Texte</span>
            <input type="color" class="adv-color-input" id="advColText" value="#c8c8c8" oninput="setAdvColor('text',this.value)">
            <input type="text" class="adv-color-hex" id="advColTextHex" value="#c8c8c8" maxlength="7" oninput="setAdvColorHex('text',this.value)">
            <button class="adv-color-reset" onclick="resetAdvColor('text')" title="Reset">⟳</button>
        </div>
        <div class="adv-color-row">
            <span class="adv-color-label">Clair</span>
            <input type="color" class="adv-color-input" id="advColBright" value="#e8e8e8" oninput="setAdvColor('bright',this.value)">
            <input type="text" class="adv-color-hex" id="advColBrightHex" value="#e8e8e8" maxlength="7" oninput="setAdvColorHex('bright',this.value)">
            <button class="adv-color-reset" onclick="resetAdvColor('bright')" title="Reset">⟳</button>
        </div>
        <div class="adv-color-row">
            <span class="adv-color-label">Accent</span>
            <input type="color" class="adv-color-input" id="advColAccent" value="#888888" oninput="setAdvColor('accent',this.value)">
            <input type="text" class="adv-color-hex" id="advColAccentHex" value="#888888" maxlength="7" oninput="setAdvColorHex('accent',this.value)">
            <button class="adv-color-reset" onclick="resetAdvColor('accent')" title="Reset">⟳</button>
        </div>
        <div class="adv-color-row">
            <span class="adv-color-label">Discret</span>
            <input type="color" class="adv-color-input" id="advColDim" value="#555555" oninput="setAdvColor('dim',this.value)">
            <input type="text" class="adv-color-hex" id="advColDimHex" value="#555555" maxlength="7" oninput="setAdvColorHex('dim',this.value)">
            <button class="adv-color-reset" onclick="resetAdvColor('dim')" title="Reset">⟳</button>
        </div>
        <div class="adv-color-row">
            <span class="adv-color-label">Bordure</span>
            <input type="color" class="adv-color-input" id="advColBorder" value="#1e1e1e" oninput="setAdvColor('border',this.value)">
            <input type="text" class="adv-color-hex" id="advColBorderHex" value="#1e1e1e" maxlength="7" oninput="setAdvColorHex('border',this.value)">
            <button class="adv-color-reset" onclick="resetAdvColor('border')" title="Reset">⟳</button>
        </div>
        <button class="nuance-reset" onclick="resetAllAdvColors()" style="margin-top:0.3rem;">⟳ Réinitialiser toutes les couleurs</button>

        <!-- Typography -->
        <div class="tp-label" style="margin-top:1.5rem;">Typographie avancée</div>
        <div class="tp-hint">Police personnalisée pour le corps du texte et les titres, indépendamment du template.</div>
        <div class="typo-row">
            <span class="typo-label">Corps</span>
            <select class="typo-select" id="typoBodySelect" onchange="setTypoBody(this.value)">
                <option value="">— Selon template —</option>
                <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                <option value="'Libre Baskerville', serif">Libre Baskerville</option>
                <option value="'Fraunces', serif">Fraunces</option>
                <option value="'DM Sans', sans-serif">DM Sans</option>
                <option value="'Karla', sans-serif">Karla</option>
                <option value="'Nunito Sans', sans-serif">Nunito Sans</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Source Sans 3', sans-serif">Source Sans 3</option>
                <option value="'Roboto Mono', monospace">Roboto Mono</option>
            </select>
        </div>
        <div class="typo-row">
            <span class="typo-label">Titres</span>
            <select class="typo-select" id="typoHeadSelect" onchange="setTypoHead(this.value)">
                <option value="">— Selon template —</option>
                <option value="'Cinzel', serif">Cinzel</option>
                <option value="'Cinzel Decorative', serif">Cinzel Decorative</option>
                <option value="'Abril Fatface', serif">Abril Fatface</option>
                <option value="'Bebas Neue', sans-serif">Bebas Neue</option>
                <option value="'Syne', sans-serif">Syne</option>
                <option value="'Rubik Mono One', sans-serif">Rubik Mono One</option>
                <option value="'Josefin Sans', sans-serif">Josefin Sans</option>
                <option value="'Caveat', cursive">Caveat</option>
            </select>
        </div>
        <div class="tp-mini-row" style="margin-top:0.5rem;">
            <span class="tp-mini-label">Taille texte</span>
            <input type="range" class="bgfx-slider" id="typoSizeSlider" min="80" max="140" value="100" oninput="setTypoSize(this.value)">
            <span class="tp-mini-val" id="typoSizeVal">100%</span>
        </div>
        <div class="tp-mini-row">
            <span class="tp-mini-label">Interligne</span>
            <input type="range" class="bgfx-slider" id="typoLineSlider" min="120" max="220" value="170" oninput="setTypoLine(this.value)">
            <span class="tp-mini-val" id="typoLineVal">1.7</span>
        </div>
    </div>

    <!-- ====== TAB: LAYOUT ====== -->
    <div class="tp-pane" id="pane-layout">
        <div class="tp-label">Hero</div>
        <div class="tp-hint">Disposition de la section d'accueil (première chose que le visiteur voit).</div>
        <div class="tp-choice-row" id="heroLayoutRow"></div>

        <div class="tp-label">Galerie</div>
        <div class="tp-hint">Comment vos images sont organisées dans le portfolio.</div>
        <div class="tp-choice-row" id="galLayoutRow"></div>

        <div class="tp-label">Sections personnalisées</div>
        <div id="csbPanelList"></div>
        <div class="csb-add-btn" onclick="openLayoutPicker()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Ajouter une section
        </div>

        <div class="tp-label" style="margin-top:1.5rem;">Style des cartes</div>
        <div class="tp-hint">Forme des coins sur les cartes de services et la galerie.</div>
        <div class="tp-choice-row" id="cardStyleRow"></div>

        <div class="tp-label" style="margin-top:1rem;">Style de navigation</div>
        <div class="tp-hint">Apparence de la barre de navigation en haut de page.</div>
        <div class="tp-choice-row" id="navStyleRow"></div>

        <div class="tp-label" style="margin-top:1rem;">Espacement sections</div>
        <div class="tp-hint">Distance entre chaque section du site.</div>
        <div class="tp-choice-row" id="spacingRow"></div>

        <div class="tp-label" style="margin-top:1rem;">Écart galerie</div>
        <div class="tp-hint">Espace entre les images dans la grille.</div>
        <div class="tp-choice-row" id="galGapRow"></div>

        <div class="tp-label" style="margin-top:1rem;">Titre Hero</div>
        <div class="tp-hint">Taille et espacement des lettres du titre principal.</div>
        <div class="tp-mini-row">
            <span class="tp-mini-label">Taille</span>
            <input type="range" class="bgfx-slider" id="heroSizeSlider" min="60" max="200" value="100" oninput="setHeroSize(this.value)">
            <span class="tp-mini-val" id="heroSizeVal">100%</span>
        </div>
        <div class="tp-mini-row">
            <span class="tp-mini-label">Lettres</span>
            <input type="range" class="bgfx-slider" id="heroSpacingSlider" min="-5" max="40" value="5" oninput="setHeroSpacing(this.value)">
            <span class="tp-mini-val" id="heroSpacingVal">5px</span>
        </div>

        <div class="tp-label" style="margin-top:1rem;">Options</div>
        <div class="tp-hint">Éléments supplémentaires du site.</div>
        <div class="tp-choice-row">
            <button class="tp-chip" id="scrollTopToggle" onclick="toggleScrollTop()">↑ Scroll to top</button>
        </div>

    </div>

    <!-- ====== TAB: ANIM ====== -->
    <div class="tp-pane" id="pane-anim">
        <div class="tp-label">Animations au scroll</div>
        <div class="tp-hint">Les éléments apparaissent progressivement quand le visiteur descend la page.</div>
        <div class="tp-choice-row" id="scrollAnimRow"></div>

        <div class="tp-label">Effet hover galerie</div>
        <div class="tp-hint">Réaction visuelle quand la souris passe sur une image.</div>
        <div class="tp-choice-row" id="hoverFxRow"></div>

        <div class="tp-label">Curseur</div>
        <div class="tp-hint">Remplace le curseur standard par un effet custom (desktop uniquement).</div>
        <div class="tp-choice-row" id="cursorFxRow"></div>

        <div class="tp-label" style="margin-top:1.5rem;">Musique / Audio</div>
        <div class="logo-upload-zone" id="audioUploadZone">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
            <span class="luz-text">Importer un MP3</span>
            <input type="file" accept="audio/*" id="audioFileInput" onchange="handleAudioUpload(event)">
        </div>
    </div>

    <!-- ====== TAB: PRESET ====== -->
    <div class="tp-pane" id="pane-preset">
        <div class="tp-label">Presets Métier</div>
        <div class="tp-hint">Un clic = votre site se transforme pour correspondre à votre activité. Textes, couleurs, icônes, tout change.</div>
        <div class="preset-grid" id="presetGrid"></div>
    </div>

    <!-- ====== TAB: CONFIG ====== -->
    <div class="tp-pane" id="pane-config">
        <!-- Email -->
        <div class="tp-label">Formulaire de Contact</div>
        <div class="tp-hint">Configurez comment les visiteurs peuvent vous contacter.</div>
        <div class="mail-cfg">
            <div class="tp-label" style="margin-top:0;">Email</div>
            <div class="mail-row">
                <input type="email" class="mail-input" id="mailTo" placeholder="votre@email.com" spellcheck="false">
            </div>
            <div class="tp-label">Méthode</div>
            <div class="mail-row mail-mode-btns">
                <button class="mail-mode-btn active" data-mode="mailto" onclick="setMailMode('mailto')">✉ Mailto</button>
                <button class="mail-mode-btn" data-mode="formspree" onclick="setMailMode('formspree')">⚡ Formspree</button>
                <button class="mail-mode-btn" data-mode="web3forms" onclick="setMailMode('web3forms')">🌐 Web3Forms</button>
            </div>
            <div class="mail-hint" id="mailHintMailto">Ouvre le client mail du visiteur.</div>
            <div class="mail-extra" id="mailExtraFormspree">
                <div class="tp-label" style="margin-top:0;">Formspree ID</div>
                <div class="mail-row">
                    <input type="text" class="mail-input" id="mailFormspreeId" placeholder="xrgvkwyz" spellcheck="false" maxlength="20">
                </div>
                <div class="mail-hint"><a href="https://formspree.io" target="_blank">formspree.io</a></div>
            </div>
            <div class="mail-extra" id="mailExtraWeb3">
                <div class="tp-label" style="margin-top:0;">Clé Web3Forms</div>
                <div class="mail-row">
                    <input type="text" class="mail-input" id="mailWeb3Key" placeholder="votre-clé" spellcheck="false" maxlength="50">
                </div>
                <div class="mail-hint"><a href="https://web3forms.com" target="_blank">web3forms.com</a></div>
            </div>
            <div class="mail-status" id="mailStatus">
                <div class="mail-dot off" id="mailDot"></div>
                <div><div class="mail-status-text" id="mailStatusText">Non configuré</div></div>
            </div>
        </div>

        <!-- Social Links -->
        <div class="tp-label" style="margin-top:1.5rem;">Réseaux</div>
        <div class="soc-cfg">
            <div class="soc-list" id="socList"></div>
            <div class="soc-add" onclick="addSocialLink()">+ Ajouter</div>
        </div>

        <!-- Quick Links -->
        <div class="tp-label" style="margin-top:1.5rem;">Liens rapides</div>
        <div class="tp-hint">Boutons cliquables affichés sous la section contact (boutique, Linktree, portfolio externe…).</div>
        <div class="qlinks-cfg">
            <div id="qlinkList"></div>
            <div class="qlink-add" onclick="addQuickLink()">+ Ajouter un lien</div>
        </div>

        <!-- Rituels Créatifs / Service Blocks -->
        <div class="tp-label" style="margin-top:1.5rem;">Rituels créatifs / Services</div>
        <div class="tp-hint">Gérez les blocs de services affichés sur le site. Ajoutez, réorganisez ou supprimez.</div>
        <div class="svc-cfg">
            <div id="svcList"></div>
            <div class="svc-add" onclick="addServiceBlock()">+ Ajouter un service</div>
        </div>



        <!-- Pages du site -->
        <div class="tp-label" style="margin-top:1.5rem;">Pages du site</div>
        <div class="tp-hint">Créez et gérez les pages de votre site. L'export ZIP contiendra toutes les pages avec la navigation inter-pages.</div>
        <div id="pageManagerList" class="section-reorder-cfg"></div>
        <div style="margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="svc-add" onclick="addPagePrompt()" style="flex:1;min-width:120px;">+ Nouvelle page</button>
            <button class="svc-add" onclick="exportZip()" style="flex:1;min-width:120px;background:var(--accent);color:var(--bg);">📦 Exporter ZIP</button>
        </div>

        <!-- Add Page Modal -->
        <div id="addPageModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:20000;display:none;align-items:center;justify-content:center;">
            <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1.5rem;width:90%;max-width:400px;">
                <div style="font-size:0.8rem;font-weight:600;color:var(--bright);margin-bottom:1rem;">Créer une page</div>
                <div style="margin-bottom:0.8rem;">
                    <label style="font-size:0.5rem;color:var(--dim);display:block;margin-bottom:0.3rem;">Nom de la page</label>
                    <input id="newPageName" type="text" placeholder="Ma nouvelle page" style="width:100%;padding:0.4rem 0.6rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.55rem;">
                </div>
                <div style="margin-bottom:1rem;">
                    <label style="font-size:0.5rem;color:var(--dim);display:block;margin-bottom:0.3rem;">Type</label>
                    <div id="pageTypeGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;">
                        <button class="page-type-btn" data-type="portfolio" onclick="selectPageType('portfolio')" style="padding:0.6rem;background:var(--bg);border:2px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:center;font-size:0.5rem;">
                            <div style="font-size:1.2rem;margin-bottom:0.2rem;">🎨</div>
                            <div style="font-weight:600;">Portfolio</div>
                            <div style="color:var(--dim);font-size:0.4rem;">Collections d'images</div>
                        </button>
                        <button class="page-type-btn" data-type="boutique" onclick="selectPageType('boutique')" style="padding:0.6rem;background:var(--bg);border:2px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:center;font-size:0.5rem;">
                            <div style="font-size:1.2rem;margin-bottom:0.2rem;">🛒</div>
                            <div style="font-weight:600;">Boutique</div>
                            <div style="color:var(--dim);font-size:0.4rem;">Produits + Stripe</div>
                        </button>
                        <button class="page-type-btn" data-type="landing" onclick="selectPageType('landing')" style="padding:0.6rem;background:var(--bg);border:2px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:center;font-size:0.5rem;">
                            <div style="font-size:1.2rem;margin-bottom:0.2rem;">🚀</div>
                            <div style="font-weight:600;">Landing</div>
                            <div style="color:var(--dim);font-size:0.4rem;">Hero + CTA</div>
                        </button>
                        <button class="page-type-btn" data-type="libre" onclick="selectPageType('libre')" style="padding:0.6rem;background:var(--bg);border:2px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:center;font-size:0.5rem;">
                            <div style="font-size:1.2rem;margin-bottom:0.2rem;">📝</div>
                            <div style="font-weight:600;">Libre</div>
                            <div style="color:var(--dim);font-size:0.4rem;">Blocs texte/image</div>
                        </button>
                    </div>
                </div>
                <div style="display:flex;gap:0.5rem;">
                    <button onclick="closeAddPageModal()" style="flex:1;padding:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--dim);cursor:pointer;font-size:0.5rem;">Annuler</button>
                    <button id="confirmAddPageBtn" onclick="confirmAddPage()" style="flex:1;padding:0.5rem;background:var(--accent);border:none;border-radius:6px;color:var(--bg);cursor:pointer;font-size:0.5rem;font-weight:600;" disabled>Créer</button>
                </div>
            </div>
        </div>

        <!-- SEO -->
        <div class="tp-label" style="margin-top:1.5rem;">SEO & Partage</div>
        <div class="tp-hint">Optimisez l'apparence de votre site dans Google et sur les réseaux sociaux.</div>
        <div class="seo-cfg">
            <div class="tp-mini-label">Titre du site</div>
            <input class="seo-field" id="seoTitle" placeholder="FOLYO — L'Encre Prend Vie" oninput="updateSEO()" maxlength="70">
            <div class="tp-mini-label">Description</div>
            <textarea class="seo-textarea" id="seoDesc" placeholder="Mon portfolio créatif..." oninput="updateSEO()" maxlength="160"></textarea>
            <div class="tp-mini-label">URL du site</div>
            <input class="seo-field" id="seoUrl" placeholder="https://monsite.com" oninput="updateSEO()" maxlength="100">
            <div class="tp-mini-label">Image de partage (URL)</div>
            <input class="seo-field" id="seoOgImage" placeholder="https://monsite.com/preview.jpg" oninput="updateSEO()" maxlength="200">
            <div class="tp-mini-label" style="margin-top:0.5rem;">Aperçu Google</div>
            <div class="seo-preview">
                <div class="seo-preview-title" id="seoPreviewTitle">FOLYO — Portfolio Builder</div>
                <div class="seo-preview-url" id="seoPreviewUrl">monsite.com</div>
                <div class="seo-preview-desc" id="seoPreviewDesc">Mon portfolio créatif.</div>
            </div>
        </div>

        <!-- Section Order -->
        <div class="tp-label" style="margin-top:1.5rem;">Ordre des sections</div>
        <div class="tp-hint">Réorganisez les sections principales du site par glisser-déposer ou avec les flèches.</div>
        <div class="section-reorder-cfg" id="sectionReorderList"></div>

        <!-- Export/Import JSON -->
        <div class="tp-label" style="margin-top:1.5rem;">Sauvegarde données</div>
        <div class="tp-hint">Exportez vos données (textes, thème, images) en JSON pour les sauvegarder ou les transférer. Indépendant du navigateur.</div>
        <div class="json-btns">
            <button class="json-btn" onclick="exportJSON()">↓ Exporter JSON</button>
            <label class="json-btn import">↑ Importer JSON<input type="file" accept=".json" onchange="importJSON(event)"></label>
        </div>

        <!-- À Propos -->
        <div class="tp-label" style="margin-top:1.5rem;">À propos</div>
        <div class="tp-hint">Éditez le titre, les textes et les statistiques de la section « À propos ».</div>
        <div class="about-cfg" id="aboutCfg">
            <div class="tp-mini-label">Titre</div>
            <input class="about-field" id="aboutCfgTitle" placeholder="Titre de la section..." oninput="syncAboutFromPanel()">
            <div class="tp-mini-label">Paragraphe 1</div>
            <textarea class="about-textarea" id="aboutCfgP1" placeholder="Premier paragraphe..." oninput="syncAboutFromPanel()"></textarea>
            <div class="tp-mini-label">Paragraphe 2</div>
            <textarea class="about-textarea" id="aboutCfgP2" placeholder="Deuxième paragraphe..." oninput="syncAboutFromPanel()"></textarea>
            <div class="tp-mini-label" style="margin-top:0.4rem;">Statistiques</div>
            <div id="aboutStatsList"></div>
        </div>
    </div>
</div>

<!-- LIGHTBOX -->
<div class="lb" id="lb" onclick="this.classList.remove('show')"><img id="lbi" src="" alt=""></div>

<!-- OVERLAY -->
<div class="ov" id="ov" onclick="closeTP()"></div>

<!-- MODAL for Collection Name -->
<div class="modal-bg" id="colModal">
    <div class="modal-box">
        <div class="modal-title" id="modalTitle">NOUVELLE COLLECTION</div>
        <input class="modal-input" id="colNameInput" placeholder="Nom de la collection..." maxlength="40">
        <input class="modal-input" id="colDescInput" placeholder="Description (optionnel)..." maxlength="120">
        <div class="modal-btns">
            <button class="modal-btn" onclick="closeColModal()">Annuler</button>
            <button class="modal-btn primary" id="modalConfirm" onclick="confirmColModal()">Créer</button>
        </div>
    </div>
</div>

<!-- TOOLBAR -->
<div class="edit-toolbar">
    <button class="tb" onclick="openTP()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Personnaliser
    </button>
    <button class="tb" onclick="enterPreview()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Aperçu
    </button>
    <button class="tb" onclick="exportZip()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Exporter ZIP
    </button>
    <div class="tb-group">
        <button class="tb-sm" onclick="manualSave()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Sauvegarder
        </button>
        <button class="tb-sm danger" onclick="confirmReset()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 105.42-8.28L1 10"/></svg>
            Reset
        </button>
    </div>
    <div class="tb-undo-group">
        <button class="tb-ur" id="undoBtn" onclick="undo()" disabled title="Annuler (Ctrl+Z)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 105.42-8.28L1 10"/></svg>
        </button>
        <button class="tb-ur" id="redoBtn" onclick="redo()" disabled title="Rétablir (Ctrl+Y)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-5.42-8.28L23 10"/></svg>
        </button>
    </div>
</div>

<!-- SAVE BADGE -->
<div class="save-badge" id="saveBadge"><div class="save-badge-dot"></div> Sauvegarde auto</div>
<!-- SAVE CONFIRM -->
<div class="save-confirm" id="saveConfirm">
    <div>
        <div class="save-confirm-text" id="saveConfirmText">✓ Sauvegardé</div>
        <div class="save-confirm-sub" id="saveConfirmSub"></div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// =============================================
// THEMES
// =============================================
const TH=[
    // — TRÈS GLAUQUE —
    {n:'Nécromancie',bg:'#050304',bg2:'#0a0607',bg3:'#0f090a',text:'#9a7070',dim:'#4a2525',bright:'#c88080',accent:'#6b1a1a',border:'#180808'},
    {n:'Abysses',bg:'#020306',bg2:'#050810',bg3:'#080c16',text:'#7088a0',dim:'#2a3a50',bright:'#90a8c0',accent:'#1a3058',border:'#0a1020'},
    {n:'Peste Noire',bg:'#060504',bg2:'#0c0b08',bg3:'#12100c',text:'#8a8060',dim:'#4a4530',bright:'#b0a878',accent:'#5a5020',border:'#1a1808'},
    {n:'Crypte',bg:'#040404',bg2:'#080808',bg3:'#0c0c0c',text:'#787878',dim:'#333333',bright:'#a0a0a0',accent:'#4a4a4a',border:'#111111'},
    {n:'Sang Ancien',bg:'#0c0808',bg2:'#140e0e',bg3:'#1a1212',text:'#c8b8b8',dim:'#6a4a4a',bright:'#e8d8d8',accent:'#8b3a3a',border:'#251515'},
    {n:'Vaudou',bg:'#080506',bg2:'#100a0c',bg3:'#180e12',text:'#b89898',dim:'#5a3040',bright:'#d8a8b0',accent:'#7a2848',border:'#201018'},
    // — SOMBRE —
    {n:'Obsidienne',bg:'#0a0a0a',bg2:'#111111',bg3:'#161616',text:'#c8c8c8',dim:'#555',bright:'#e8e8e8',accent:'#888',border:'#1e1e1e'},
    {n:'Forêt Noire',bg:'#070b07',bg2:'#0e140e',bg3:'#131a13',text:'#b8c8b8',dim:'#4a6a4a',bright:'#d8e8d8',accent:'#3a7a3a',border:'#152015'},
    {n:'Océan Profond',bg:'#070a0e',bg2:'#0c1018',bg3:'#10151e',text:'#b8c8d8',dim:'#4a5a6a',bright:'#d0e0f0',accent:'#3a5a8b',border:'#121a28'},
    {n:'Améthyste',bg:'#0b080e',bg2:'#120e18',bg3:'#17121e',text:'#c8b8d8',dim:'#5a4a6a',bright:'#e0d0f0',accent:'#6a3a8b',border:'#1a1228'},
    {n:'Crépuscule',bg:'#0e0a0c',bg2:'#161015',bg3:'#1c141a',text:'#d0b8c8',dim:'#6a4a5a',bright:'#e8d0e0',accent:'#8b4a6a',border:'#221525'},
    {n:'Encre & Or',bg:'#0a0908',bg2:'#121010',bg3:'#181514',text:'#c8bc9c',dim:'#6a6040',bright:'#e8dcb0',accent:'#a08530',border:'#221e12'},
    // — MOYEN —
    {n:'Cendre',bg:'#0e0e0e',bg2:'#151515',bg3:'#1b1b1b',text:'#aaaaaa',dim:'#505050',bright:'#d0d0d0',accent:'#707070',border:'#202020'},
    {n:'Ivoire Sombre',bg:'#121110',bg2:'#1a1918',bg3:'#201f1e',text:'#c8c4b8',dim:'#6a6860',bright:'#e8e4d8',accent:'#8a8470',border:'#252320'},
    {n:'Brume',bg:'#0c0d0e',bg2:'#141618',bg3:'#1a1d20',text:'#a0aab4',dim:'#506068',bright:'#c8d4de',accent:'#607888',border:'#1a2028'},
    {n:'Cuivre Ancien',bg:'#0e0b08',bg2:'#161210',bg3:'#1e1815',text:'#c0a888',dim:'#6a5838',bright:'#dcc4a0',accent:'#8a6830',border:'#241c10'},
    {n:'Jade Noir',bg:'#080c0a',bg2:'#0e1612',bg3:'#141e18',text:'#98c0a8',dim:'#406850',bright:'#b8e0c8',accent:'#308858',border:'#122018'},
    {n:'Nocturne',bg:'#08080e',bg2:'#0e0e18',bg3:'#141422',text:'#a8a8d0',dim:'#4a4a70',bright:'#c8c8f0',accent:'#5858a0',border:'#141430'},
    // — DOUX / ÉLÉGANT —
    {n:'Parchemin',bg:'#13120f',bg2:'#1c1b16',bg3:'#24231d',text:'#c8c0a8',dim:'#706848',bright:'#e8e0c0',accent:'#988850',border:'#2a2818'},
    {n:'Rosée Noire',bg:'#0c080a',bg2:'#161014',bg3:'#1e161c',text:'#d0b0c0',dim:'#6a4858',bright:'#f0d0e0',accent:'#a06080',border:'#261828'},
    {n:'Lune Bleue',bg:'#080a10',bg2:'#0e1220',bg3:'#141a2c',text:'#a0b8d8',dim:'#4a6080',bright:'#c0d8f8',accent:'#5080b8',border:'#142040'},
    {n:'Argent',bg:'#101012',bg2:'#18181c',bg3:'#202025',text:'#b8b8c4',dim:'#5a5a68',bright:'#d8d8e8',accent:'#7878a0',border:'#222230'},
    // — CLAIR / INVERSÉ —
    {n:'Marbre Blanc',bg:'#f4f2ef',bg2:'#eae7e2',bg3:'#dfdbd5',text:'#3a3530',dim:'#9a9488',bright:'#1a1815',accent:'#6a6358',border:'#d8d4cc'},
    {n:'Papier Crème',bg:'#f8f5ee',bg2:'#f0ebdf',bg3:'#e8e2d4',text:'#4a4235',dim:'#a89a85',bright:'#2a2218',accent:'#8a7a60',border:'#e0d8c8'},
    {n:'Glacier',bg:'#f0f4f8',bg2:'#e4eaf0',bg3:'#d8dfe8',text:'#2a3545',dim:'#8898a8',bright:'#101e30',accent:'#4a6a8a',border:'#ccd4de'},
    {n:'Aube Rose',bg:'#f8f2f4',bg2:'#f0e8ec',bg3:'#e8dee4',text:'#3a2830',dim:'#a08890',bright:'#1e1018',accent:'#8a5a6a',border:'#e0d2d8'},
    // — SATURÉS / JEWEL TONES —
    {n:'Rubis Imperial',bg:'#0c0406',bg2:'#160810',bg3:'#1e0c14',text:'#e8a0a0',dim:'#7a3040',bright:'#ffc0c0',accent:'#c8284a',border:'#2a0c18'},
    {n:'Émeraude',bg:'#020c08',bg2:'#041810',bg3:'#062418',text:'#80d8a8',dim:'#2a6848',bright:'#a0f8c8',accent:'#10a860',border:'#0a2818'},
    {n:'Saphir Royal',bg:'#04060e',bg2:'#080e1e',bg3:'#0c142a',text:'#88b8f0',dim:'#2a4878',bright:'#a8d8ff',accent:'#2868c8',border:'#0c1830'},
    {n:'Topaze Dorée',bg:'#0e0a04',bg2:'#1c1408',bg3:'#28200c',text:'#f0d080',dim:'#7a6828',bright:'#ffe8a0',accent:'#d8a820',border:'#2a2008'},
    {n:'Opale Violette',bg:'#0a040e',bg2:'#160820',bg3:'#200c30',text:'#c890f0',dim:'#5a2880',bright:'#e0b0ff',accent:'#9040d8',border:'#1a0c30'},
    {n:'Corail Vif',bg:'#0e0604',bg2:'#1c0c08',bg3:'#2a120c',text:'#f8a888',dim:'#885030',bright:'#ffc8a8',accent:'#e86840',border:'#2a1408'},
    // — NÉON / ELECTRIC —
    {n:'Néon Menthe',bg:'#020e0c',bg2:'#041c18',bg3:'#062a24',text:'#60f8d8',dim:'#208868',bright:'#80ffe8',accent:'#00d8a8',border:'#082820'},
    {n:'Néon Rose',bg:'#0e020a',bg2:'#1c0418',bg3:'#2a0824',text:'#ff70c8',dim:'#882060',bright:'#ff98e0',accent:'#e81890',border:'#280818'},
    {n:'Cyber Violet',bg:'#08020e',bg2:'#10041c',bg3:'#18082a',text:'#b870ff',dim:'#5820a0',bright:'#d098ff',accent:'#8830e8',border:'#180830'},
    {n:'Électrique Bleu',bg:'#020610',bg2:'#040e20',bg3:'#081430',text:'#60a8ff',dim:'#204880',bright:'#88c8ff',accent:'#1878f0',border:'#0c1830'},
    // — CHAUDS / WARM LUXURY —
    {n:'Moka Mousse',bg:'#100c08',bg2:'#1c1610',bg3:'#282018',text:'#d8b898',dim:'#806848',bright:'#f0d4b0',accent:'#a87840',border:'#2a2010'},
    {n:'Terracotta',bg:'#100806',bg2:'#1c100c',bg3:'#281810',text:'#e0a888',dim:'#885838',bright:'#f8c8a8',accent:'#c86830',border:'#2a180c'},
    {n:'Bordeaux Velours',bg:'#0c0406',bg2:'#18080c',bg3:'#240c12',text:'#d89898',dim:'#704040',bright:'#f0b8b8',accent:'#982838',border:'#280c14'},
    // — NATURE / ORGANIQUE —
    {n:'Mousse Profonde',bg:'#060a06',bg2:'#0c180c',bg3:'#122012',text:'#a8d0a0',dim:'#4a7840',bright:'#c8f0c0',accent:'#489038',border:'#142818'},
    {n:'Aurore Boréale',bg:'#020a0e',bg2:'#041820',bg3:'#062430',text:'#80e0d0',dim:'#206858',bright:'#a0fff0',accent:'#18b8a0',border:'#082820'}
];
let cTH=6;

function applyTH(i){
    const t=TH[i],r=document.documentElement.style;
    ['bg','bg2','bg3','text','dim','bright','accent','border'].forEach(k=>r.setProperty('--'+k,t[k]));
    cTH=i;
    document.querySelectorAll('#tpg .tp-opt').forEach((e,j)=>e.classList.toggle('active',j===i));
    // Toggle light-theme class for light/inverted themes (index 22+)
    document.body.classList.toggle('light-theme', i >= 22);
    // Sync bgfx in auto mode
    if(bgfxAuto) syncBgfxFromTheme();
}
function buildTP(){
    const g=document.getElementById('tpg');
    const cats=[
        {label:'Très Glauque',start:0,end:6},
        {label:'Sombre',start:6,end:12},
        {label:'Moyen',start:12,end:18},
        {label:'Doux / Élégant',start:18,end:22},
        {label:'Clair / Inversé',start:22,end:26},
        {label:'Saturés / Jewel',start:26,end:32},
        {label:'Néon / Electric',start:32,end:36},
        {label:'Chauds / Warm',start:36,end:39},
        {label:'Nature / Organique',start:39,end:41}
    ];
    cats.forEach(cat=>{
        const lbl=document.createElement('div');
        lbl.style.cssText='grid-column:1/-1;font-family:Josefin Sans,sans-serif;font-weight:200;font-size:0.48rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--dim);margin-top:0.6rem;margin-bottom:0.1rem;opacity:0.6;';
        lbl.textContent=cat.label;
        g.appendChild(lbl);
        for(let i=cat.start;i<cat.end;i++){
            const t=TH[i],e=document.createElement('div');
            e.className='tp-opt'+(i===6?' active':'');
            e.innerHTML=`<div class="tp-dots"><div class="tp-dot" style="background:${t.bg}"></div><div class="tp-dot" style="background:${t.accent}"></div><div class="tp-dot" style="background:${t.bright}"></div></div><div class="tp-opt-name">${t.n}</div>`;
            e.title=t.n;
            e.onclick=()=>applyTH(i);
            g.appendChild(e);
        }
    });
}
function openTP(){document.getElementById('tp').classList.add('open');document.getElementById('ov').classList.add('show');}
function closeTP(){document.getElementById('tp').classList.remove('open');document.getElementById('ov').classList.remove('show');}

// =============================================
// TEMPLATES
// =============================================
const TPLS=[
    {
        id:'',n:'Mystique',icon:'🔮',desc:'Occulte, ésotérique, sombre',
        fonts:null, // default fonts already loaded
        deco:['◆','✦','◆'],
        bars:['#2a2035','#6a3a8b','#e0d0f0'],
        sigil:`<circle cx="100" cy="100" r="70" stroke="rgba(200,200,200,0.15)" stroke-width="0.8"/><circle cx="100" cy="100" r="50" stroke="rgba(200,200,200,0.1)" stroke-width="0.5"/><polygon points="100,35 155,130 45,130" stroke="rgba(200,200,200,0.18)" stroke-width="0.8" fill="none"/><polygon points="100,165 45,70 155,70" stroke="rgba(200,200,200,0.18)" stroke-width="0.8" fill="none"/><line x1="100" y1="25" x2="100" y2="175" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/><line x1="25" y1="100" x2="175" y2="100" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/><circle cx="100" cy="100" r="8" stroke="rgba(200,200,200,0.12)" stroke-width="0.8" fill="none"/>`
    },
    {
        id:'tpl-pro',n:'Professionnel',icon:'💼',desc:'Épuré, corporate, moderne',
        fonts:'Inter:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600;700',
        deco:['—','→','—'],
        bars:['#1a1a2e','#607888','#d0d0d0'],
        sigil:`<rect x="40" y="40" width="120" height="120" rx="12" stroke="rgba(200,200,200,0.15)" stroke-width="1" fill="none"/><rect x="60" y="60" width="80" height="80" rx="8" stroke="rgba(200,200,200,0.1)" stroke-width="0.8" fill="none"/><line x1="100" y1="55" x2="100" y2="145" stroke="rgba(200,200,200,0.08)" stroke-width="0.5"/><line x1="55" y1="100" x2="145" y2="100" stroke="rgba(200,200,200,0.08)" stroke-width="0.5"/><circle cx="100" cy="100" r="6" stroke="rgba(200,200,200,0.12)" stroke-width="1" fill="none"/>`
    },
    {
        id:'tpl-art',n:'Artistique',icon:'🎨',desc:'Galerie, italique, raffiné',
        fonts:'Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&family=Lora:ital,wght@0,400;0,600;1,400;1,600',
        deco:['~','✽','~'],
        bars:['#1a1520','#8b4a6a','#f0d0e0'],
        sigil:`<ellipse cx="100" cy="100" rx="65" ry="75" stroke="rgba(200,200,200,0.14)" stroke-width="0.8" fill="none"/><path d="M60,50 Q100,20 140,50 Q160,100 140,150 Q100,180 60,150 Q40,100 60,50" stroke="rgba(200,200,200,0.1)" stroke-width="0.6" fill="none"/><path d="M80,65 Q100,45 120,65 Q130,100 120,135 Q100,155 80,135 Q70,100 80,65" stroke="rgba(200,200,200,0.08)" stroke-width="0.5" fill="none"/><circle cx="100" cy="100" r="4" fill="rgba(200,200,200,0.1)"/>`
    },
    {
        id:'tpl-cyber',n:'Cyberpunk',icon:'⚡',desc:'Néon, futuriste, glitch',
        fonts:'Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono',
        deco:['//','⟫','//'],
        bars:['#0a1020','#3a5a8b','#90a8c0'],
        sigil:`<polygon points="100,25 175,75 175,140 100,175 25,140 25,75" stroke="rgba(200,200,200,0.18)" stroke-width="0.8" fill="none"/><polygon points="100,45 155,78 155,130 100,158 45,130 45,78" stroke="rgba(200,200,200,0.1)" stroke-width="0.5" fill="none"/><line x1="100" y1="25" x2="100" y2="175" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/><line x1="25" y1="107" x2="175" y2="107" stroke="rgba(200,200,200,0.06)" stroke-width="0.5"/><rect x="92" y="92" width="16" height="16" stroke="rgba(200,200,200,0.12)" stroke-width="0.8" fill="none"/>`
    },
    {
        id:'tpl-roman',n:'Romantique',icon:'🌹',desc:'Élégant, fluide, poétique',
        fonts:'Cormorant+Infant:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400;1,500;1,600&family=EB+Garamond:ital,wght@0,400;0,500;1,400;1,500',
        deco:['❧','✿','❧'],
        bars:['#1a1018','#a06080','#f0d0e0'],
        sigil:`<circle cx="100" cy="100" r="70" stroke="rgba(200,200,200,0.12)" stroke-width="0.5" fill="none"/><path d="M100,30 C130,50 150,80 150,100 C150,130 130,160 100,170 C70,160 50,130 50,100 C50,80 70,50 100,30Z" stroke="rgba(200,200,200,0.1)" stroke-width="0.6" fill="none"/><ellipse cx="100" cy="90" rx="25" ry="30" stroke="rgba(200,200,200,0.08)" stroke-width="0.5" fill="none"/><circle cx="100" cy="85" r="5" fill="rgba(200,200,200,0.06)"/><path d="M100,115 Q100,140 100,155" stroke="rgba(200,200,200,0.06)" stroke-width="0.5" fill="none"/>`
    },
    {
        id:'tpl-brut',n:'Brutaliste',icon:'🔩',desc:'Brut, massif, typographique',
        fonts:'Bebas+Neue&family=Space+Mono:wght@400;700',
        deco:['▌','■','▌'],
        bars:['#151515','#707070','#d0d0d0'],
        sigil:`<rect x="30" y="30" width="140" height="140" stroke="rgba(200,200,200,0.2)" stroke-width="2" fill="none"/><rect x="50" y="50" width="100" height="100" stroke="rgba(200,200,200,0.12)" stroke-width="2" fill="none"/><line x1="30" y1="30" x2="170" y2="170" stroke="rgba(200,200,200,0.06)" stroke-width="1.5"/><line x1="170" y1="30" x2="30" y2="170" stroke="rgba(200,200,200,0.06)" stroke-width="1.5"/><rect x="88" y="88" width="24" height="24" fill="rgba(200,200,200,0.08)"/>`
    },
    {
        id:'tpl-zen',n:'Japonisant',icon:'🎋',desc:'Zen, minimal, wabi-sabi',
        fonts:'Noto+Serif+Display:wght@300;400;500&family=Zen+Kaku+Gothic+New:wght@300;400;500',
        deco:['·','—','·'],
        bars:['#101510','#406850','#b8e0c8'],
        sigil:`<circle cx="100" cy="100" r="70" stroke="rgba(200,200,200,0.1)" stroke-width="0.4" fill="none"/><circle cx="100" cy="80" r="35" stroke="rgba(200,200,200,0.08)" stroke-width="0.4" fill="none"/><circle cx="100" cy="120" r="35" stroke="rgba(200,200,200,0.08)" stroke-width="0.4" fill="none"/><circle cx="100" cy="80" r="3" fill="rgba(200,200,200,0.06)"/><circle cx="100" cy="120" r="3" fill="rgba(200,200,200,0.06)"/><line x1="100" y1="28" x2="100" y2="172" stroke="rgba(200,200,200,0.04)" stroke-width="0.3"/>`
    },
    {
        id:'tpl-street',n:'Streetwear',icon:'🔥',desc:'Urbain, graffiti, audacieux',
        fonts:'Permanent+Marker&family=Barlow+Condensed:wght@300;400;600;700',
        deco:['//','×','//'],
        bars:['#1a1510','#c87040','#e8dcb0'],
        sigil:`<circle cx="100" cy="100" r="68" stroke="rgba(200,200,200,0.15)" stroke-width="1.5" fill="none" stroke-dasharray="8 4"/><path d="M55,55 L145,145 M145,55 L55,145" stroke="rgba(200,200,200,0.12)" stroke-width="1.5"/><circle cx="100" cy="100" r="30" stroke="rgba(200,200,200,0.1)" stroke-width="1.2" fill="none"/><circle cx="100" cy="100" r="10" fill="rgba(200,200,200,0.06)" stroke="rgba(200,200,200,0.1)" stroke-width="0.8"/>`
    },
    {
        id:'tpl-editorial',n:'Éditorial',icon:'📰',desc:'Magazine, presse, raffiné',
        fonts:null,
        deco:['—','·','—'],
        bars:['#1a1520','#506a80','#d8d0c0'],
        sigil:`<rect x="35" y="45" width="130" height="110" stroke="rgba(200,200,200,0.12)" stroke-width="0.6" fill="none"/><line x1="50" y1="70" x2="150" y2="70" stroke="rgba(200,200,200,0.08)" stroke-width="0.4"/><line x1="50" y1="90" x2="130" y2="90" stroke="rgba(200,200,200,0.06)" stroke-width="0.4"/><line x1="50" y1="110" x2="140" y2="110" stroke="rgba(200,200,200,0.06)" stroke-width="0.4"/><line x1="50" y1="130" x2="120" y2="130" stroke="rgba(200,200,200,0.05)" stroke-width="0.4"/>`
    },
    {
        id:'tpl-retro',n:'Rétro',icon:'📻',desc:'Vintage, chaleureux, arrondi',
        fonts:null,
        deco:['✶','●','✶'],
        bars:['#1a1510','#a07040','#e8d0a0'],
        sigil:`<circle cx="100" cy="100" r="65" stroke="rgba(200,200,200,0.12)" stroke-width="0.8" fill="none"/><circle cx="100" cy="100" r="45" stroke="rgba(200,200,200,0.08)" stroke-width="0.5" fill="none"/><circle cx="100" cy="100" r="25" stroke="rgba(200,200,200,0.06)" stroke-width="0.4" fill="none"/><circle cx="100" cy="100" r="8" fill="rgba(200,200,200,0.05)"/><line x1="100" y1="35" x2="100" y2="55" stroke="rgba(200,200,200,0.08)" stroke-width="0.4"/>`
    },
    {
        id:'tpl-neo',n:'Néo-Grotesque',icon:'◎',desc:'Tech, organique, futur doux',
        fonts:null,
        deco:['↗','⬡','↗'],
        bars:['#101520','#4a6a90','#a0c0e0'],
        sigil:`<circle cx="100" cy="100" r="60" stroke="rgba(200,200,200,0.14)" stroke-width="0.8" fill="none"/><path d="M100,40 L150,75 L150,125 L100,160 L50,125 L50,75Z" stroke="rgba(200,200,200,0.08)" stroke-width="0.5" fill="none"/><circle cx="100" cy="100" r="20" stroke="rgba(200,200,200,0.06)" stroke-width="0.4" fill="none"/><circle cx="100" cy="100" r="4" fill="rgba(200,200,200,0.08)"/>`
    },
    {
        id:'tpl-organic',n:'Organique',icon:'🌿',desc:'Nature, doux, artisanal',
        fonts:null,
        deco:['~','❦','~'],
        bars:['#101510','#5a8050','#c0e0b0'],
        sigil:`<ellipse cx="100" cy="100" rx="55" ry="65" stroke="rgba(200,200,200,0.1)" stroke-width="0.5" fill="none"/><path d="M100,40 Q130,70 120,100 Q110,130 100,160 Q90,130 80,100 Q70,70 100,40" stroke="rgba(200,200,200,0.08)" stroke-width="0.5" fill="none"/><circle cx="100" cy="90" r="8" stroke="rgba(200,200,200,0.06)" stroke-width="0.4" fill="none"/><path d="M92,90 Q100,75 108,90" stroke="rgba(200,200,200,0.06)" stroke-width="0.3" fill="none"/>`
    },
    {
        id:'tpl-grunge',n:'Grunge',icon:'💀',desc:'Brut, punk, monospace',
        fonts:null,
        deco:['▮','×','▮'],
        bars:['#151010','#804040','#c0a0a0'],
        sigil:`<rect x="35" y="35" width="130" height="130" stroke="rgba(200,200,200,0.18)" stroke-width="2" fill="none"/><line x1="35" y1="35" x2="165" y2="165" stroke="rgba(200,200,200,0.1)" stroke-width="1.5"/><line x1="165" y1="35" x2="35" y2="165" stroke="rgba(200,200,200,0.1)" stroke-width="1.5"/><circle cx="100" cy="100" r="20" stroke="rgba(200,200,200,0.08)" stroke-width="1.5" fill="none"/>`
    }
];
let cTPL=0;
const loadedFonts=new Set();

function loadTplFonts(fontsStr){
    if(!fontsStr || loadedFonts.has(fontsStr)) return;
    loadedFonts.add(fontsStr);
    const link=document.createElement('link');
    link.rel='stylesheet';
    link.href=`https://fonts.googleapis.com/css2?family=${fontsStr}&display=swap`;
    document.head.appendChild(link);
}

function applyTPL(i){
    const tpl=TPLS[i];
    const prev=TPLS[cTPL];
    cTPL=i;

    // Load fonts
    if(tpl.fonts) loadTplFonts(tpl.fonts);

    // Remove previous template class, add new
    if(prev.id) document.body.classList.remove(prev.id);
    if(tpl.id) document.body.classList.add(tpl.id);

    // Update sigil (only if no custom logo)
    if(!logoData){
        const sigil=document.getElementById('defaultSigil');
        if(sigil) sigil.innerHTML=tpl.sigil;
    }

    // Update decorators
    document.querySelectorAll('.d').forEach((el,idx)=>{
        if(idx%3===0) el.textContent=tpl.deco[0];
        else if(idx%3===1) el.textContent=tpl.deco[2];
        else el.textContent=tpl.deco[1];
    });
    // Update submit button decorator
    const fsBtn=document.querySelector('.fs');
    if(fsBtn){
        const txt=fsBtn.textContent.trim();
        const words=txt.split(/\s+/).filter(w=>w.length>1);
        const mainWord=words.length?words[words.length-1]:'ENVOYER';
        fsBtn.textContent=tpl.deco[1]+' '+mainWord;
    }

    // Active state on cards
    document.querySelectorAll('.tpl-card').forEach((c,j)=>c.classList.toggle('active',j===i));
}

function buildTplSelector(){
    const scroll=document.getElementById('tplScroll');
    TPLS.forEach((tpl,i)=>{
        const card=document.createElement('div');
        card.className='tpl-card'+(i===0?' active':'');
        card.innerHTML=`
            <div class="tpl-card-icon">${tpl.icon}</div>
            <div class="tpl-card-name">${tpl.n}</div>
            <div class="tpl-card-desc">${tpl.desc}</div>
            <div class="tpl-card-bar">
                <span style="background:${tpl.bars[0]}"></span>
                <span style="background:${tpl.bars[1]}"></span>
                <span style="background:${tpl.bars[2]}"></span>
            </div>`;
        card.onclick=()=>applyTPL(i);
        scroll.appendChild(card);
    });
}

// =============================================
// BACKGROUNDS
// =============================================
const BGS=[
    {id:'none',    n:'Aucun',         icon:'○', desc:'Fond uni, pas d\'effet'},
    {id:'brume',   n:'Brume',         icon:'☁', desc:'Halos doux et diffus'},
    {id:'vignette',n:'Vignette',      icon:'◉', desc:'Bords assombris, focus central'},
    {id:'grain',   n:'Grain',         icon:'▒', desc:'Texture granuleuse style film'},
    {id:'grille',  n:'Grille',        icon:'▦', desc:'Quadrillage fin technique'},
    {id:'constellations',n:'Étoiles', icon:'✦', desc:'Points lumineux dispersés'},
    {id:'fumee',   n:'Fumée',         icon:'♨', desc:'Volutes animées flottantes'},
    {id:'runes',   n:'Runes',         icon:'⛤', desc:'Symboles géométriques'},
    {id:'eclats',  n:'Éclats',        icon:'✧', desc:'Taches de lumière éparses'},
    {id:'nebulose',n:'Nébulose',      icon:'◎', desc:'Nuage coloré flou'},
    {id:'tissu',   n:'Tissu',         icon:'▤', desc:'Trame textile fine'},
    {id:'aurora',  n:'Aurora',        icon:'🌈', desc:'Aurore boréale animée'},
    {id:'plasma',  n:'Plasma',        icon:'💫', desc:'Orbes lumineux pulsants'},
    {id:'rayons',  n:'Rayons',        icon:'☀', desc:'Faisceaux depuis le centre'},
    {id:'bokeh',   n:'Bokeh',         icon:'◌', desc:'Cercles de lumière flous'},
    {id:'toile',   n:'Toile',         icon:'🖌', desc:'Texture peinte, coups de pinceau'}
];
let cBG=0;
let bgfxColor='#888888';
let bgfxAuto=true;
let bgfxIntensity=100;

const BGFX_SWATCHES=[
    '#ffffff','#c8c8c8','#888888','#8b3a3a','#c44040',
    '#e86850','#ff4060','#d4a030','#ffe040','#a08530',
    '#3a7a3a','#40a870','#00d8a8','#10c8c8','#3a5a8b',
    '#5080b8','#1878f0','#6a3a8b','#a060d0','#9040d8',
    '#8b4a6a','#c87090','#e81890','#ff70c8','#d4aa78',
    '#50e8d0','#c86830','#e86840'
];

function hexToRgb(hex){
    const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return {r,g,b};
}

function applyBgfxColor(col){
    bgfxColor = col;
    document.documentElement.style.setProperty('--bgfx', col);
    // Update picker + hex field
    document.getElementById('bgfxColorPicker').value = col;
    document.getElementById('bgfxHexInput').value = col;
    // Update swatch active states
    document.querySelectorAll('.bgfx-swatch').forEach(s=>{
        s.classList.toggle('active', s.dataset.c === col.toLowerCase());
    });
    // Regenerate SVG-based backgrounds if active
    const activeId = BGS[cBG]?.id;
    if(['grain','grille','runes','tissu','toile'].includes(activeId)){
        generateSvgBg(activeId, col);
    }
}

function generateSvgBg(id, col){
    const rgb = hexToRgb(col);
    const layer = document.getElementById('bgLayer');
    let svg='';
    if(id==='grain'){
        // Noise grain with color tint
        svg=`<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/><feColorMatrix type='matrix' values='0 0 0 0 ${rgb.r/255} 0 0 0 0 ${rgb.g/255} 0 0 0 0 ${rgb.b/255} 0 0 0 0.06 0'/></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>`;
    } else if(id==='grille'){
        svg=`<svg xmlns='http://www.w3.org/2000/svg' width='60' height='60'><path d='M60 0v60M0 60h60' fill='none' stroke='rgba(${rgb.r},${rgb.g},${rgb.b},0.06)' stroke-width='0.5'/></svg>`;
    } else if(id==='runes'){
        svg=`<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'><g fill='none' stroke='rgba(${rgb.r},${rgb.g},${rgb.b},0.04)' stroke-width='0.5'><path d='M40 10L40 70'/><path d='M10 40L70 40'/><circle cx='40' cy='40' r='18'/><path d='M22 22L58 58'/><path d='M58 22L22 58'/></g></svg>`;
    } else if(id==='tissu'){
        svg=`<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20'><path d='M0 10h20M10 0v20' fill='none' stroke='rgba(${rgb.r},${rgb.g},${rgb.b},0.025)' stroke-width='0.6'/></svg>`;
    }
    if(id==='toile'){
        svg=`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><filter id='t'><feTurbulence type='turbulence' baseFrequency='0.015' numOctaves='3' seed='2'/><feDisplacementMap in='SourceGraphic' scale='8'/></filter><g filter='url(%23t)' opacity='0.04'><rect x='20' y='30' width='160' height='2' fill='rgba(${rgb.r},${rgb.g},${rgb.b},0.8)' rx='1'/><rect x='10' y='70' width='180' height='1.5' fill='rgba(${rgb.r},${rgb.g},${rgb.b},0.6)' rx='1'/><rect x='30' y='110' width='140' height='2.5' fill='rgba(${rgb.r},${rgb.g},${rgb.b},0.7)' rx='1'/><rect x='15' y='150' width='170' height='1' fill='rgba(${rgb.r},${rgb.g},${rgb.b},0.5)' rx='1'/><rect x='40' y='180' width='120' height='2' fill='rgba(${rgb.r},${rgb.g},${rgb.b},0.6)' rx='1'/></g></svg>`;
    }
    if(svg){
        layer.style.backgroundImage = `url("data:image/svg+xml,${encodeURIComponent(svg)}")`;
        layer.style.backgroundRepeat = 'repeat';
    }
}

function applyBG(i){
    cBG=i;
    const layer = document.getElementById('bgLayer');
    // Reset inline bg styles from SVG generation
    layer.style.backgroundImage='';
    layer.style.backgroundRepeat='';
    // Remove all bg- classes from body
    document.body.className = document.body.className.replace(/\bbg-\S+/g,'').trim();
    if(BGS[i].id !== 'none'){
        document.body.classList.add('bg-'+BGS[i].id);
        // Generate SVG if needed
        if(['grain','grille','runes','tissu','toile'].includes(BGS[i].id)){
            generateSvgBg(BGS[i].id, bgfxColor);
        }
    }
    document.querySelectorAll('.bg-opt').forEach((e,j)=>e.classList.toggle('active',j===i));
    // Show/hide color controls
    document.getElementById('bgfxControls').classList.toggle('active', BGS[i].id !== 'none');
}

function toggleBgfxAuto(){
    bgfxAuto = !bgfxAuto;
    document.getElementById('bgfxAutoBtn').classList.toggle('active', bgfxAuto);
    if(bgfxAuto) syncBgfxFromTheme();
}

function syncBgfxFromTheme(){
    if(!bgfxAuto) return;
    const t = TH[cTH];
    const col = (nuanceHue||nuanceSat||nuanceLum||nuanceCon) ? adjustColor(t.accent, nuanceHue, nuanceSat, nuanceLum, nuanceCon) : t.accent;
    applyBgfxColor(col);
}

function setIntensity(val){
    bgfxIntensity = val;
    document.documentElement.style.setProperty('--bgfx-o', val/100);
    document.getElementById('bgfxIntVal').textContent = val+'%';
}

function buildBGGrid(){
    const g=document.getElementById('bgGrid');
    BGS.forEach((bg,i)=>{
        const e=document.createElement('div');
        e.className='tp-opt bg-opt'+(i===0?' active':'');
        e.innerHTML=`<div style="font-size:1.1rem;line-height:1;opacity:0.5;">${bg.icon}</div><div class="tp-opt-name">${bg.n}</div>`;
        e.onclick=()=>applyBG(i);
        g.appendChild(e);
    });
    // Build swatches
    const sw = document.getElementById('bgfxSwatches');
    BGFX_SWATCHES.forEach(c=>{
        const s=document.createElement('div');
        s.className='bgfx-swatch';
        s.style.background=c;
        s.dataset.c=c.toLowerCase();
        s.onclick=()=>{ bgfxAuto=false; document.getElementById('bgfxAutoBtn').classList.remove('active'); applyBgfxColor(c); };
        sw.appendChild(s);
    });
    // Wire up color picker
    document.getElementById('bgfxColorPicker').addEventListener('input', function(e){
        bgfxAuto=false; document.getElementById('bgfxAutoBtn').classList.remove('active');
        applyBgfxColor(e.target.value);
    });
    // Wire up hex input
    document.getElementById('bgfxHexInput').addEventListener('input', function(e){
        let v = e.target.value;
        if(/^#[0-9a-fA-F]{6}$/.test(v)){
            bgfxAuto=false; document.getElementById('bgfxAutoBtn').classList.remove('active');
            applyBgfxColor(v);
        }
    });
    // Wire up intensity slider
    document.getElementById('bgfxIntSlider').addEventListener('input', function(e){
        setIntensity(parseInt(e.target.value));
    });
}

// =============================================
// LOGO IMPORT
// =============================================
let logoData = null;
let logoFileName = '';

document.getElementById('logoFileInput').addEventListener('change', function(e){
    const f = e.target.files[0];
    if(!f) return;
    const maxSize = 5 * 1024 * 1024; // 5MB
    if(f.size > maxSize){ alert('Fichier trop volumineux (max 5Mo)'); return; }

    logoFileName = f.name;
    const reader = new FileReader();
    reader.onload = function(ev){
        logoData = ev.target.result;
        applyLogo(logoData);
        // Show preview
        document.getElementById('logoPreviewImg').src = logoData;
        document.getElementById('logoPreviewName').textContent = logoFileName;
        document.getElementById('logoPreviewSize').textContent = (f.size / 1024).toFixed(1) + ' Ko';
        document.getElementById('logoPreview').classList.add('active');
        document.getElementById('logoUploadZone').style.display = 'none';
        scheduleAutoSave();
    };
    reader.readAsDataURL(f);
});

function applyLogo(src){
    const wrap = document.getElementById('heroLogoWrap');
    const sigil = document.getElementById('defaultSigil');
    // Remove previous custom logo if exists
    const prev = wrap.querySelector('.hero-logo-img');
    if(prev) prev.remove();

    if(src){
        sigil.style.display = 'none';
        const img = document.createElement('img');
        img.className = 'hero-logo-img';
        img.src = src;
        img.alt = 'Logo';
        wrap.appendChild(img);
        // Also add to nav
        let navImg = document.querySelector('.nav-logo-img');
        if(!navImg){
            navImg = document.createElement('img');
            navImg.className = 'nav-logo-img';
            document.getElementById('navLogo').prepend(navImg);
        }
        navImg.src = src;
    } else {
        sigil.style.display = '';
        const navImg = document.querySelector('.nav-logo-img');
        if(navImg) navImg.remove();
    }
}

function removeLogo(){
    logoData = null;
    logoFileName = '';
    applyLogo(null);
    document.getElementById('logoPreview').classList.remove('active');
    document.getElementById('logoUploadZone').style.display = '';
    document.getElementById('logoFileInput').value = '';
    scheduleAutoSave();
}

// =============================================
// COLLECTIONS SYSTEM
// =============================================
let collections = [
    { id: 'main', name: 'Toutes les Œuvres', desc: '', images: new Array(8).fill(null), gridCols: 2, cover: null }
];
let activeCol = 0;
let modalMode = 'create'; // 'create' or 'edit'
let editingColIndex = -1;

function renderColTabs(){
    const tabs = document.getElementById('colTabs');
    tabs.innerHTML = '';
    collections.forEach((col, i) => {
        const btn = document.createElement('button');
        btn.className = 'col-tab' + (i === activeCol ? ' active' : '');
        btn.textContent = col.name;
        btn.onclick = () => { activeCol = i; renderColTabs(); renderColContent(); scheduleAutoSave(); };
        tabs.appendChild(btn);
    });
    // Add collection button
    const addBtn = document.createElement('button');
    addBtn.className = 'col-tab-add';
    addBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Collection`;
    addBtn.onclick = () => openColModal('create');
    tabs.appendChild(addBtn);
}

function renderColContent(){
    const wrap = document.getElementById('colContent');
    const col = collections[activeCol];
    let html = '';

    // Cover upload (if multiple collections)
    if(collections.length > 1){
        html += `<div class="col-cover-upload">`;
        if(col.cover) html += `<img class="col-cover-thumb" src="${col.cover}" alt="Cover">`;
        html += `<label>📷 ${col.cover ? 'Changer la' : 'Ajouter une'} cover<input type="file" accept="image/*" onchange="handleCoverUpload(event,${activeCol})"></label>`;
        if(col.cover) html += `<button class="col-act-btn del" onclick="removeCover(${activeCol})" title="Supprimer la cover" style="margin-left:0.3rem;">✕</button>`;
        html += `</div>`;
    }

    // Collection header with actions
    html += `<div class="col-header">`;
    html += `<span class="col-name">${col.desc || ''}</span>`;
    html += `<div class="col-actions" style="margin-left:auto;">`;
    html += `<button class="col-act-btn" onclick="openColModal('edit')" title="Renommer">✎</button>`;
    if(activeCol > 0){
        html += `<button class="col-act-btn del" onclick="deleteCollection(${activeCol})" title="Supprimer cette collection">✕</button>`;
    }
    html += `</div></div>`;

    // Grid size controls
    html += `<div class="grid-controls">`;
    html += `<span class="grid-label">Grille :</span>`;
    [2,3,4].forEach(n => {
        html += `<button class="grid-btn${col.gridCols===n?' active':''}" onclick="setGridCols(${n})">${n}×${n}</button>`;
    });
    html += `<button class="grid-btn" onclick="addSlots()" title="Ajouter des emplacements" style="margin-left:0.5rem;">+ Slots</button>`;
    html += `</div>`;

    // Gallery grid
    html += `<div class="gal" id="gal" style="grid-template-columns:repeat(${col.gridCols},1fr);">`;
    html += `</div>`;
    wrap.innerHTML = html;
    buildGallery();
}

function buildGallery(){
    const col = collections[activeCol];
    const g = document.getElementById('gal');
    if(!g) return;
    g.innerHTML = '';
    for(let i = 0; i < col.images.length; i++){
        const d = document.createElement('div');
        d.className = 'gi' + (col.images[i] ? ' gi-has-img' : '');
        // Delete button on every slot
        const delBtn = document.createElement('button');
        delBtn.className = 'gi-del';
        delBtn.innerHTML = '✕';
        delBtn.title = col.images[i] ? 'Supprimer cette image' : 'Supprimer cet emplacement';
        delBtn.onclick = (e) => {
            e.stopPropagation();
            if(col.images[i]){
                col.images[i] = null; buildGallery(); scheduleAutoSave();
            } else {
                col.images.splice(i, 1); buildGallery(); scheduleAutoSave();
            }
        };
        d.appendChild(delBtn);
        if(col.images[i]){
            const img = document.createElement('img');
            img.src = col.images[i];
            img.alt = 'Œuvre '+(i+1);
            d.appendChild(img);
            d.onclick = (e) => {
                if(e.target.classList.contains('gi-del')) return;
                document.getElementById('lbi').src = col.images[i];
                document.getElementById('lb').classList.add('show');
            };
        } else {
            d.innerHTML += `<div class="gp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Ajouter</div><input type="file" class="gu" accept="image/*" data-col="${activeCol}" data-i="${i}">`;
            d.querySelector('input').addEventListener('change', handleGalleryUpload);
        }
        g.appendChild(d);
    }
}

function compressImage(dataUrl, maxW, quality){
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const c = document.createElement('canvas');
            let w = img.width, h = img.height;
            if(w > maxW){ h = Math.round(h * maxW / w); w = maxW; }
            c.width = w; c.height = h;
            c.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(c.toDataURL('image/jpeg', quality));
        };
        img.onerror = () => resolve(dataUrl);
        img.src = dataUrl;
    });
}

function handleGalleryUpload(e){
    const f = e.target.files[0]; if(!f) return;
    const ci = parseInt(e.target.dataset.col);
    const ii = parseInt(e.target.dataset.i);
    const r = new FileReader();
    r.onload = async ev => {
        const compressed = await compressImage(ev.target.result, 1200, 0.7);
        collections[ci].images[ii] = compressed;
        buildGallery();
        scheduleAutoSave();
    };
    r.readAsDataURL(f);
}

function setGridCols(n){
    collections[activeCol].gridCols = n;
    renderColContent();
    scheduleAutoSave();
}

function addSlots(){
    const col = collections[activeCol];
    const toAdd = col.gridCols;
    for(let i = 0; i < toAdd; i++) col.images.push(null);
    renderColContent();
    scheduleAutoSave();
}

function deleteCollection(index){
    if(!confirm(`Supprimer la collection "${collections[index].name}" et toutes ses images ?`)) return;
    collections.splice(index, 1);
    if(activeCol >= collections.length) activeCol = collections.length - 1;
    renderColTabs();
    renderColContent();
    scheduleAutoSave();
}

// Modal
function openColModal(mode){
    modalMode = mode;
    const modal = document.getElementById('colModal');
    const nameInput = document.getElementById('colNameInput');
    const descInput = document.getElementById('colDescInput');
    const title = document.getElementById('modalTitle');
    const confirm = document.getElementById('modalConfirm');

    if(mode === 'edit'){
        title.textContent = 'MODIFIER LA COLLECTION';
        confirm.textContent = 'Enregistrer';
        nameInput.value = collections[activeCol].name;
        descInput.value = collections[activeCol].desc || '';
        editingColIndex = activeCol;
    } else {
        title.textContent = 'NOUVELLE COLLECTION';
        confirm.textContent = 'Créer';
        nameInput.value = '';
        descInput.value = '';
        editingColIndex = -1;
    }
    modal.classList.add('show');
    setTimeout(() => nameInput.focus(), 100);
}

function closeColModal(){
    document.getElementById('colModal').classList.remove('show');
}

function confirmColModal(){
    const name = document.getElementById('colNameInput').value.trim();
    if(!name){ alert('Veuillez entrer un nom.'); return; }
    const desc = document.getElementById('colDescInput').value.trim();

    if(modalMode === 'create'){
        collections.push({
            id: 'col_' + Date.now(),
            name: name,
            desc: desc,
            images: new Array(8).fill(null),
            gridCols: 2
        });
        activeCol = collections.length - 1;
    } else {
        collections[editingColIndex].name = name;
        collections[editingColIndex].desc = desc;
    }
    closeColModal();
    renderColTabs();
    renderColContent();
    scheduleAutoSave();
}

// Enter key in modal
document.getElementById('colNameInput').addEventListener('keydown', e => { if(e.key === 'Enter') confirmColModal(); });
document.getElementById('colDescInput').addEventListener('keydown', e => { if(e.key === 'Enter') confirmColModal(); });

// =============================================
// SOCIAL LINKS MANAGER
// =============================================
const SOC_ICONS = [
    '📷','📸','🎵','♪','🎬','▶','🐦','🦋','💼','🔗',
    '🌐','💬','📌','🎮','🛒','📧','📱','🎨','✍','📝',
    '👾','🤖','💻','📺','🎧','☕','🏠','⭐','🔔','💎',
    '🎯','🧿','🔮','🕯️','🌙','☀','✦','◆','♠','♦',
    '🖤','💀','👁','🐍','🦇','🕸','⚡','🔥','💫','🌀',
    '🪬','⛤','☽','☾','⚗','🧬','🎭','🖊️','🖋','✒',
    '📐','📏','🧠','💡','🎪','🎤','🎸','🥁','🎹','🎻',
    '📖','📚','🗝','🗡','⚔','🛡','👑','💰','🏆','🎖',
    '🌿','🍂','🌸','🌺','🪷','🍀','🌲','🦊','🐺','🦅',
    '🌊','❄','🌈','💜','💙','💚','❤','🧡','💛','🤍',
    '♾','∞','◎','◉','▲','▼','◇','⬡','⬢','⟐',
    '🛸','🪐','🌍','🗺','✈','🚀','⚓','🏔','🏝','🎋',
    '🍷','🍵','🎂','🍕','🧁','🎁','💌','🪶','🧿','♟'
];

let socLinks = [
    { icon: '📷', label: '@VOTREPSEUDO', url: 'https://instagram.com/' },
    { icon: '♪', label: 'TIKTOK', url: 'https://tiktok.com/' }
];
let socPickerTarget = -1; // index of link being edited
let qlinkPickerTarget = -1;
let svcIconPickerTarget = -1;

function renderSocPanel(){
    const list = document.getElementById('socList');
    if(!list) return;
    if(socLinks.length === 0){
        list.innerHTML = '<div class="soc-empty">Aucun lien — cliquez + pour ajouter</div>';
    } else {
        list.innerHTML = '';
        socLinks.forEach((link, i) => {
            const item = document.createElement('div');
            item.className = 'soc-item';
            item.innerHTML = `
                <button class="soc-icon-pick" data-i="${i}" onclick="openSocPicker(${i})">${link.icon}</button>
                <div class="soc-fields">
                    <input class="soc-field" value="${escH(link.label)}" placeholder="Libellé" data-i="${i}" data-f="label">
                    <input class="soc-field soc-field-url" value="${escH(link.url)}" placeholder="https://..." data-i="${i}" data-f="url">
                </div>
                <button class="soc-del" onclick="removeSocLink(${i})" title="Supprimer">✕</button>`;
            // Wire inputs
            item.querySelectorAll('.soc-field').forEach(inp => {
                inp.addEventListener('input', function(){
                    socLinks[parseInt(this.dataset.i)][this.dataset.f] = this.value;
                    renderSocLinks();
                    scheduleAutoSave();
                });
            });
            list.appendChild(item);
        });
    }
    renderSocLinks();
}

function escH(s){ return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function renderSocLinks(){
    const cx = document.getElementById('socialLinks');
    if(!cx) return;
    cx.innerHTML = '';
    socLinks.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url || '#';
        a.className = 'sx';
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = link.icon + ' ' + link.label;
        cx.appendChild(a);
    });
}

function addSocialLink(){
    socLinks.push({ icon: '🔗', label: '', url: '' });
    renderSocPanel();
    scheduleAutoSave();
    // Focus the new label field
    const fields = document.querySelectorAll('.soc-field[data-f="label"]');
    if(fields.length) fields[fields.length-1].focus();
}

function removeSocLink(i){
    socLinks.splice(i, 1);
    renderSocPanel();
    scheduleAutoSave();
}

// Icon picker
function openSocPicker(i){
    socPickerTarget = i;
    const grid = document.getElementById('socPickerGrid');
    grid.innerHTML = '';
    SOC_ICONS.forEach(icon => {
        const el = document.createElement('div');
        el.className = 'soc-picker-item';
        el.textContent = icon;
        el.onclick = () => pickSocIcon(icon);
        grid.appendChild(el);
    });
    document.getElementById('socPickerCustom').value = '';
    document.getElementById('socPickerBg').classList.add('show');
}

function closeSocPicker(){
    document.getElementById('socPickerBg').classList.remove('show');
    socPickerTarget = -1;
    qlinkPickerTarget = -1;
    svcIconPickerTarget = -1;
}

function pickSocIcon(icon){
    if(qlinkPickerTarget >= 0 && qlinkPickerTarget < quickLinks.length){
        quickLinks[qlinkPickerTarget].icon = icon;
        qlinkPickerTarget = -1;
        renderQuickLinksPanel();
        scheduleAutoSave();
        closeSocPicker();
        return;
    }
    if(svcIconPickerTarget >= 0 && svcIconPickerTarget < serviceBlocks.length){
        serviceBlocks[svcIconPickerTarget].icon = icon;
        svcIconPickerTarget = -1;
        renderServiceBlocksDOM();
        renderServicePanel();
        scheduleAutoSave();
        closeSocPicker();
        return;
    }
    if(socPickerTarget >= 0 && socPickerTarget < socLinks.length){
        socLinks[socPickerTarget].icon = icon;
        renderSocPanel();
        scheduleAutoSave();
    }
    closeSocPicker();
}

function pickCustomIcon(){
    const v = document.getElementById('socPickerCustom').value.trim();
    if(v) pickSocIcon(v);
}

// =============================================
// EMAIL / CONTACT FORM CONFIG
// =============================================
let mailMode = 'mailto';
let mailTo = '';
let mailFormspreeId = '';
let mailWeb3Key = '';

function setMailMode(mode){
    mailMode = mode;
    document.querySelectorAll('.mail-mode-btn').forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
    // Show/hide hints and extras
    document.getElementById('mailHintMailto').style.display = mode==='mailto'?'block':'none';
    document.getElementById('mailExtraFormspree').classList.toggle('show', mode==='formspree');
    document.getElementById('mailExtraWeb3').classList.toggle('show', mode==='web3forms');
    updateMailStatus();
}

function updateMailStatus(){
    const dot = document.getElementById('mailDot');
    const text = document.getElementById('mailStatusText');
    const email = document.getElementById('mailTo').value.trim();
    mailTo = email;

    if(mailMode==='mailto'){
        if(email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
            dot.className='mail-dot on';
            text.textContent='Mailto configuré → '+email;
        } else if(email){
            dot.className='mail-dot warn';
            text.textContent='Email invalide';
        } else {
            dot.className='mail-dot off';
            text.textContent='Entrez un email de réception';
        }
    } else if(mailMode==='formspree'){
        const fid = document.getElementById('mailFormspreeId').value.trim();
        mailFormspreeId = fid;
        if(fid.length >= 4){
            dot.className='mail-dot on';
            text.textContent='Formspree actif → ID: '+fid;
        } else {
            dot.className='mail-dot warn';
            text.textContent='Entrez votre Formspree ID';
        }
    } else if(mailMode==='web3forms'){
        const key = document.getElementById('mailWeb3Key').value.trim();
        mailWeb3Key = key;
        if(key.length >= 8 && email){
            dot.className='mail-dot on';
            text.textContent='Web3Forms actif → '+email;
        } else if(!email){
            dot.className='mail-dot warn';
            text.textContent='Entrez votre email ci-dessus';
        } else {
            dot.className='mail-dot warn';
            text.textContent='Entrez votre clé Web3Forms';
        }
    }
}

// Wire up inputs
document.getElementById('mailTo').addEventListener('input', updateMailStatus);
document.getElementById('mailFormspreeId').addEventListener('input', updateMailStatus);
document.getElementById('mailWeb3Key').addEventListener('input', updateMailStatus);

// Toast notification
function showToast(icon, text, sub, duration){
    const t=document.getElementById('formToast');
    document.getElementById('toastIcon').textContent=icon;
    document.getElementById('toastText').textContent=text;
    document.getElementById('toastSub').textContent=sub||'';
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), duration||3500);
}

// Form submit handler
function handleFormSubmit(e){
    e.preventDefault();
    const name = document.getElementById('formName').value.trim();
    const email = document.getElementById('formEmail').value.trim();
    const subject = document.getElementById('formSubject').value.trim() || 'Nouveau message';
    const message = document.getElementById('formMessage').value.trim();
    const btn = document.getElementById('formSubmitBtn');
    const origText = btn.textContent;

    if(!mailTo && mailMode==='mailto'){
        showToast('⚠', 'Email non configuré', 'Configurez l\'email dans le panneau Personnaliser', 4000);
        return;
    }

    if(mailMode==='mailto'){
        const body = `Nom: ${name}\nEmail: ${email}\n\n${message}`;
        const mailto = `mailto:${encodeURIComponent(mailTo)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailto, '_blank');
        showToast('✉', 'Client mail ouvert', 'Envoyez le message depuis votre application mail', 4000);
        document.getElementById('contactForm').reset();

    } else if(mailMode==='formspree'){
        if(!mailFormspreeId){ showToast('⚠','Formspree non configuré','Ajoutez votre Formspree ID dans Personnaliser',4000); return; }
        btn.textContent='Envoi...'; btn.disabled=true;
        fetch(`https://formspree.io/f/${mailFormspreeId}`,{
            method:'POST',
            headers:{'Content-Type':'application/json','Accept':'application/json'},
            body:JSON.stringify({name,email,subject,message,_replyto:email})
        }).then(r=>{
            if(r.ok){ showToast('✓','Message envoyé !','Via Formspree — Vous recevrez la réponse par email'); document.getElementById('contactForm').reset(); }
            else { r.json().then(d=>showToast('✕','Erreur Formspree',d.errors?.map(e=>e.message).join(', ')||'Vérifiez votre ID',5000)); }
        }).catch(()=>showToast('✕','Erreur réseau','Vérifiez votre connexion',4000))
        .finally(()=>{ btn.textContent=origText; btn.disabled=false; });

    } else if(mailMode==='web3forms'){
        if(!mailWeb3Key){ showToast('⚠','Web3Forms non configuré','Ajoutez votre clé d\'accès dans Personnaliser',4000); return; }
        btn.textContent='Envoi...'; btn.disabled=true;
        fetch('https://api.web3forms.com/submit',{
            method:'POST',
            headers:{'Content-Type':'application/json','Accept':'application/json'},
            body:JSON.stringify({access_key:mailWeb3Key,name,email,subject,message,from_name:name,replyto:email})
        }).then(r=>r.json()).then(d=>{
            if(d.success){ showToast('✓','Message envoyé !','Via Web3Forms — '+mailTo); document.getElementById('contactForm').reset(); }
            else { showToast('✕','Erreur Web3Forms',d.message||'Vérifiez votre clé',5000); }
        }).catch(()=>showToast('✕','Erreur réseau','Vérifiez votre connexion',4000))
        .finally(()=>{ btn.textContent=origText; btn.disabled=false; });
    }
}

// =============================================
// PARTICLES
// =============================================
function mkP(){
    const c=document.getElementById('ptc');
    for(let i=0;i<18;i++){
        const d=document.createElement('div');d.className='pt';
        d.style.left=Math.random()*100+'%';d.style.top=Math.random()*100+'%';
        d.style.animationDelay=Math.random()*8+'s';
        d.style.animationDuration=(6+Math.random()*6)+'s';
        c.appendChild(d);
    }
}

// =============================================
// DOWNLOAD
// =============================================

// =============================================
// PAGE MANAGER SYSTEM
// =============================================
const PAGE_ICONS = {portfolio:'🎨', boutique:'🛒', landing:'🚀', libre:'📝'};
const PAGE_LABELS = {portfolio:'Portfolio', boutique:'Boutique', landing:'Landing Page', libre:'Page libre'};
let sitePages = [];
let selectedPageType = null;

function loadPages(){
    try { sitePages = JSON.parse(localStorage.getItem('folyo-site-pages')||'[]'); } catch(e){ sitePages=[]; }
    renderPageList();
    updateNavLinks();
}

function savePages(){
    localStorage.setItem('folyo-site-pages', JSON.stringify(sitePages));
    renderPageList();
    updateNavLinks();
}

function renderPageList(){
    const el = document.getElementById('pageManagerList');
    if(!el) return;
    let h = '<div class="section-reorder-item" style="cursor:default;"><span class="section-reorder-handle">📄</span><span class="section-reorder-name" style="flex:1;">index.html <span style="color:var(--dim);font-size:0.38rem;"> — Page principale (ici)</span></span></div>';
    sitePages.forEach((p, i) => {
        h += `<div class="section-reorder-item" style="cursor:default;">
            <span class="section-reorder-handle">${PAGE_ICONS[p.type]||'📄'}</span>
            <span class="section-reorder-name" style="flex:1;">${escH(p.slug)}.html <span style="color:var(--dim);font-size:0.38rem;"> — ${escH(p.title)} (${PAGE_LABELS[p.type]||p.type})</span></span>
            <div class="section-reorder-arrows">
                <button class="section-reorder-arrow" onclick="editPageContent(${i})" title="Éditer le contenu">✏️</button>
                <button class="section-reorder-arrow" onclick="removePage(${i})" title="Supprimer">✕</button>
            </div>
        </div>`;
    });
    el.innerHTML = h;
}

function updateNavLinks(){
    const ul = document.getElementById('nLinks');
    if(!ul) return;
    // Keep anchors for sections on this page
    const localAnchors = ['#portfolio','#about','#services','#contact'];
    let linksHTML = '';
    localAnchors.forEach(a => {
        const label = a === '#portfolio' ? 'Portfolio' : a === '#about' ? 'À propos' : a === '#services' ? 'Services' : 'Contact';
        linksHTML += `<li><a href="${a}">${label}</a></li>`;
    });
    // Add dynamic page links
    sitePages.forEach(p => {
        linksHTML += `<li><a href="${p.slug}.html">${escH(p.title)}</a></li>`;
    });
    ul.innerHTML = linksHTML;
}

function addPagePrompt(){
    selectedPageType = null;
    const modal = document.getElementById('addPageModal');
    modal.style.display = 'flex';
    document.getElementById('newPageName').value = '';
    document.getElementById('confirmAddPageBtn').disabled = true;
    document.querySelectorAll('.page-type-btn').forEach(b => b.style.borderColor = 'var(--border)');
}

function closeAddPageModal(){
    document.getElementById('addPageModal').style.display = 'none';
}

function selectPageType(type){
    selectedPageType = type;
    document.querySelectorAll('.page-type-btn').forEach(b => {
        b.style.borderColor = b.dataset.type === type ? 'var(--accent)' : 'var(--border)';
    });
    document.getElementById('confirmAddPageBtn').disabled = false;
    if(!document.getElementById('newPageName').value.trim()){
        document.getElementById('newPageName').value = PAGE_LABELS[type] || type;
    }
}

function slugify(str){
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'') || 'page';
}

function confirmAddPage(){
    if(!selectedPageType) return;
    const name = document.getElementById('newPageName').value.trim() || PAGE_LABELS[selectedPageType];
    let slug = slugify(name);
    // Avoid collisions
    const existing = new Set(['index', ...sitePages.map(p=>p.slug)]);
    let base = slug, n = 2;
    while(existing.has(slug)){ slug = base + '-' + n; n++; }

    sitePages.push({
        slug: slug,
        title: name,
        type: selectedPageType,
        content: getDefaultContent(selectedPageType, name)
    });
    savePages();
    closeAddPageModal();
    showSaveConfirm('Page "'+name+'" créée !', 'Elle sera incluse dans l\'export ZIP.');
}

function removePage(idx){
    if(!confirm('Supprimer la page "'+sitePages[idx].title+'" ?')) return;
    sitePages.splice(idx,1);
    savePages();
}

function editPageContent(idx){
    const p = sitePages[idx];
    const editors = {
        portfolio: editPortfolioPage,
        boutique: editBoutiquePage,
        landing: editLandingPage,
        libre: editLibrePage
    };
    if(editors[p.type]) editors[p.type](idx);
}

// =============================================
// PAGE CONTENT EDITOR MODALS
// =============================================
function createPageEditorModal(title, bodyHTML, onSave){
    const overlay = document.createElement('div');
    overlay.className = 'page-editor-overlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:25000;display:flex;align-items:center;justify-content:center;overflow-y:auto;padding:1rem;';
    overlay.innerHTML = `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1.5rem;width:95%;max-width:600px;max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div style="font-size:0.75rem;font-weight:600;color:var(--bright);">${title}</div>
            <button onclick="this.closest('.page-editor-overlay').remove()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:1rem;">✕</button>
        </div>
        <div class="page-editor-body">${bodyHTML}</div>
        <div style="display:flex;gap:0.5rem;margin-top:1rem;">
            <button onclick="this.closest('.page-editor-overlay').remove()" style="flex:1;padding:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--dim);cursor:pointer;font-size:0.5rem;">Annuler</button>
            <button class="page-editor-save" style="flex:1;padding:0.5rem;background:var(--accent);border:none;border-radius:6px;color:var(--bg);cursor:pointer;font-size:0.5rem;font-weight:600;">Sauvegarder</button>
        </div>
    </div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('.page-editor-save').addEventListener('click', () => {
        onSave(overlay);
        overlay.remove();
    });
}

const editorFieldCSS = 'width:100%;padding:0.4rem 0.6rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.5rem;margin-bottom:0.5rem;';
const editorLabelCSS = 'font-size:0.45rem;color:var(--dim);margin-bottom:0.2rem;display:block;';

function editPortfolioPage(idx){
    const p = sitePages[idx];
    const c = p.content;
    createPageEditorModal('✏️ ' + p.title + ' (Portfolio)', `
        <label style="${editorLabelCSS}">Titre principal</label>
        <input id="peTitle" value="${escH(c.heroTitle||'')}" style="${editorFieldCSS}">
        <label style="${editorLabelCSS}">Sous-titre</label>
        <input id="peSub" value="${escH(c.heroSub||'')}" style="${editorFieldCSS}">
        <label style="${editorLabelCSS}">Description</label>
        <textarea id="peDesc" style="${editorFieldCSS}height:80px;">${escH(c.description||'')}</textarea>
        <label style="${editorLabelCSS}">Images (une URL par ligne, ou base64)</label>
        <textarea id="peImgs" style="${editorFieldCSS}height:100px;" placeholder="https://... ou collez des base64">${(c.images||[]).join('\\n')}</textarea>
        <label style="${editorLabelCSS}">Colonnes de grille</label>
        <input id="peCols" type="number" min="1" max="6" value="${c.gridCols||3}" style="${editorFieldCSS}width:60px;">
    `, (overlay) => {
        c.heroTitle = overlay.querySelector('#peTitle').value;
        c.heroSub = overlay.querySelector('#peSub').value;
        c.description = overlay.querySelector('#peDesc').value;
        c.images = overlay.querySelector('#peImgs').value.split('\\n').map(s=>s.trim()).filter(Boolean);
        c.gridCols = parseInt(overlay.querySelector('#peCols').value)||3;
        savePages();
    });
}

function editBoutiquePage(idx){
    const p = sitePages[idx];
    const c = p.content;
    createPageEditorModal('✏️ ' + p.title + ' (Boutique)', `
        <label style="${editorLabelCSS}">Titre de la boutique</label>
        <input id="peTitle" value="${escH(c.shopTitle||'')}" style="${editorFieldCSS}">
        <label style="${editorLabelCSS}">Description</label>
        <textarea id="peDesc" style="${editorFieldCSS}height:60px;">${escH(c.description||'')}</textarea>
        <div style="margin:0.5rem 0;font-size:0.5rem;color:var(--bright);font-weight:600;">Produits</div>
        <div id="peProducts"></div>
        <button onclick="addProductField()" style="margin-top:0.3rem;padding:0.3rem 0.8rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-size:0.45rem;">+ Produit</button>
    `, (overlay) => {
        c.shopTitle = overlay.querySelector('#peTitle').value;
        c.description = overlay.querySelector('#peDesc').value;
        c.products = [];
        overlay.querySelectorAll('.pe-product-row').forEach(row => {
            c.products.push({
                name: row.querySelector('.pe-pname').value,
                price: row.querySelector('.pe-pprice').value,
                image: row.querySelector('.pe-pimg').value,
                stripeLink: row.querySelector('.pe-pstripe').value
            });
        });
        savePages();
    });
    // Populate existing products
    const container = document.getElementById('peProducts');
    (c.products||[]).forEach(pr => addProductField(pr));
}

function addProductField(data){
    const container = document.getElementById('peProducts');
    if(!container) return;
    const d = data || {name:'',price:'',image:'',stripeLink:''};
    const row = document.createElement('div');
    row.className = 'pe-product-row';
    row.style.cssText = 'background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem;margin-bottom:0.4rem;';
    row.innerHTML = `
        <input class="pe-pname" value="${escH(d.name)}" placeholder="Nom" style="${editorFieldCSS}">
        <div style="display:flex;gap:0.3rem;">
            <input class="pe-pprice" value="${escH(d.price)}" placeholder="Prix (ex: 25€)" style="${editorFieldCSS}flex:1;">
            <input class="pe-pstripe" value="${escH(d.stripeLink)}" placeholder="Stripe Payment Link" style="${editorFieldCSS}flex:2;">
        </div>
        <input class="pe-pimg" value="${escH(d.image)}" placeholder="URL image" style="${editorFieldCSS}">
        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:0.7rem;">✕ Supprimer</button>
    `;
    container.appendChild(row);
}

function editLandingPage(idx){
    const p = sitePages[idx];
    const c = p.content;
    createPageEditorModal('✏️ ' + p.title + ' (Landing)', `
        <label style="${editorLabelCSS}">Titre Hero</label>
        <input id="peTitle" value="${escH(c.heroTitle||'')}" style="${editorFieldCSS}">
        <label style="${editorLabelCSS}">Sous-titre</label>
        <input id="peSub" value="${escH(c.heroSub||'')}" style="${editorFieldCSS}">
        <label style="${editorLabelCSS}">Texte CTA</label>
        <input id="peCTA" value="${escH(c.ctaText||'')}" style="${editorFieldCSS}">
        <label style="${editorLabelCSS}">Lien CTA</label>
        <input id="peCTALink" value="${escH(c.ctaLink||'')}" placeholder="https://..." style="${editorFieldCSS}">
        <label style="${editorLabelCSS}">Description</label>
        <textarea id="peDesc" style="${editorFieldCSS}height:80px;">${escH(c.description||'')}</textarea>
        <label style="${editorLabelCSS}">Image Hero (URL)</label>
        <input id="peImg" value="${escH(c.heroImage||'')}" placeholder="https://..." style="${editorFieldCSS}">
    `, (overlay) => {
        c.heroTitle = overlay.querySelector('#peTitle').value;
        c.heroSub = overlay.querySelector('#peSub').value;
        c.ctaText = overlay.querySelector('#peCTA').value;
        c.ctaLink = overlay.querySelector('#peCTALink').value;
        c.description = overlay.querySelector('#peDesc').value;
        c.heroImage = overlay.querySelector('#peImg').value;
        savePages();
    });
}

function editLibrePage(idx){
    const p = sitePages[idx];
    const c = p.content;
    createPageEditorModal('✏️ ' + p.title + ' (Page libre)', `
        <label style="${editorLabelCSS}">Titre</label>
        <input id="peTitle" value="${escH(c.pageTitle||'')}" style="${editorFieldCSS}">
        <div style="margin:0.5rem 0;font-size:0.5rem;color:var(--bright);font-weight:600;">Blocs de contenu</div>
        <div id="peBlocks"></div>
        <button onclick="addBlockField()" style="margin-top:0.3rem;padding:0.3rem 0.8rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-size:0.45rem;">+ Bloc</button>
    `, (overlay) => {
        c.pageTitle = overlay.querySelector('#peTitle').value;
        c.blocks = [];
        overlay.querySelectorAll('.pe-block-row').forEach(row => {
            c.blocks.push({
                type: row.querySelector('.pe-btype').value,
                heading: row.querySelector('.pe-bheading')?.value || '',
                text: row.querySelector('.pe-btext')?.value || '',
                image: row.querySelector('.pe-bimg')?.value || ''
            });
        });
        savePages();
    });
    const container = document.getElementById('peBlocks');
    (c.blocks||[]).forEach(bl => addBlockField(bl));
}

function addBlockField(data){
    const container = document.getElementById('peBlocks');
    if(!container) return;
    const d = data || {type:'text', heading:'', text:'', image:''};
    const row = document.createElement('div');
    row.className = 'pe-block-row';
    row.style.cssText = 'background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem;margin-bottom:0.4rem;';
    row.innerHTML = `
        <select class="pe-btype" style="${editorFieldCSS}">
            <option value="text" ${d.type==='text'?'selected':''}>Texte</option>
            <option value="image" ${d.type==='image'?'selected':''}>Image</option>
            <option value="text-image" ${d.type==='text-image'?'selected':''}>Texte + Image</option>
        </select>
        <input class="pe-bheading" value="${escH(d.heading)}" placeholder="Titre du bloc" style="${editorFieldCSS}">
        <textarea class="pe-btext" placeholder="Contenu texte" style="${editorFieldCSS}height:60px;">${escH(d.text)}</textarea>
        <input class="pe-bimg" value="${escH(d.image)}" placeholder="URL image (optionnel)" style="${editorFieldCSS}">
        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:0.7rem;">✕ Supprimer</button>
    `;
    container.appendChild(row);
}

// =============================================
// DEFAULT CONTENT FOR NEW PAGES
// =============================================
function getDefaultContent(type, title){
    if(type === 'portfolio') return {
        heroTitle: title, heroSub: 'Collections', description: 'Découvrez mes créations.',
        images: [], gridCols: 3
    };
    if(type === 'boutique') return {
        shopTitle: title, description: 'Retrouvez mes produits ici.',
        products: [{name:'Produit 1', price:'25€', image:'', stripeLink:''}]
    };
    if(type === 'landing') return {
        heroTitle: title, heroSub: 'Bienvenue', ctaText: 'Découvrir', ctaLink: '#',
        description: 'Décrivez votre projet ici.', heroImage: ''
    };
    if(type === 'libre') return {
        pageTitle: title,
        blocks: [{type:'text', heading:'Section 1', text:'Écrivez votre contenu ici.', image:''}]
    };
    return {};
}

// =============================================
// HTML TEMPLATES FOR EXPORT
// =============================================
function getPageThemeCSS(){
    const t = TH[cTH];
    const bake = (hex) => (nuanceHue||nuanceSat||nuanceLum||nuanceCon) ? adjustColor(hex, nuanceHue, nuanceSat, nuanceLum, nuanceCon) : hex;
    return `:root{--bg:${bake(t.bg)};--bg2:${bake(t.bg2)};--bg3:${bake(t.bg3)};--text:${bake(t.text)};--dim:${bake(t.dim)};--bright:${bake(t.bright)};--accent:${bake(t.accent)};--border:${bake(t.border)};}`;
}

function getBaseCSS(){
    return `*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
a{color:var(--accent);text-decoration:none;}a:hover{color:var(--bright);}
nav{display:flex;justify-content:space-between;align-items:center;padding:1.2rem 2rem;border-bottom:1px solid var(--border);}
.n-logo{font-size:0.8rem;font-weight:700;letter-spacing:0.15em;color:var(--bright);text-decoration:none;}
.n-links{display:flex;gap:2rem;list-style:none;}.n-links a{color:var(--dim);font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;text-decoration:none;}
.n-links a:hover{color:var(--bright);}
.hero{text-align:center;padding:4rem 2rem;}
.hero h1{font-size:2.5rem;font-weight:200;letter-spacing:0.3em;color:var(--bright);margin-bottom:0.5rem;}
.hero p{color:var(--dim);font-size:0.65rem;letter-spacing:0.15em;}
section{padding:3rem 2rem;max-width:1200px;margin:0 auto;}
.section-title{font-size:0.9rem;font-weight:600;color:var(--bright);margin-bottom:1.5rem;letter-spacing:0.1em;}
footer{text-align:center;padding:2rem;color:var(--dim);font-size:0.45rem;border-top:1px solid var(--border);}
@media(max-width:768px){nav{padding:1rem;}.n-links{gap:1rem;}.hero h1{font-size:1.5rem;}}`;
}

function buildNavHTML(allPages, currentSlug){
    let h = '<nav><a href="index.html" class="n-logo">'+escH(document.querySelector('#navLogo .editable')?.textContent||'FOLYO')+'</a><ul class="n-links">';
    h += '<li><a href="index.html"'+(currentSlug==='index'?' style="color:var(--bright)"':'')+'>Accueil</a></li>';
    allPages.forEach(p => {
        const active = p.slug === currentSlug ? ' style="color:var(--bright)"' : '';
        h += `<li><a href="${p.slug}.html"${active}>${escH(p.title)}</a></li>`;
    });
    h += '</ul></nav>';
    return h;
}

function buildPageHTML(page, allPages){
    const c = page.content;
    const nav = buildNavHTML(allPages, page.slug);
    const css = getPageThemeCSS() + getBaseCSS();
    let body = '';

    if(page.type === 'portfolio'){
        body = `<div class="hero"><h1>${escH(c.heroTitle||page.title)}</h1><p>${escH(c.heroSub||'')}</p></div>
        <section>${c.description?'<p style="color:var(--dim);margin-bottom:1.5rem;">'+escH(c.description)+'</p>':''}
        <div style="display:grid;grid-template-columns:repeat(${c.gridCols||3},1fr);gap:0.5rem;">
        ${(c.images||[]).filter(Boolean).map(img => '<div style="overflow:hidden;border-radius:4px;aspect-ratio:1;"><img src="'+escH(img)+'" style="width:100%;height:100%;object-fit:cover;cursor:pointer;" onclick="openLB(this.src)"></div>').join('')}
        </div></section>`;
    }
    else if(page.type === 'boutique'){
        let prods = '';
        (c.products||[]).forEach(pr => {
            prods += `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;overflow:hidden;">
                ${pr.image ? '<img src="'+escH(pr.image)+'" style="width:100%;aspect-ratio:1;object-fit:cover;">' : '<div style="width:100%;aspect-ratio:1;background:var(--bg3);display:flex;align-items:center;justify-content:center;color:var(--dim);">📷</div>'}
                <div style="padding:0.8rem;">
                    <div style="font-weight:600;color:var(--bright);margin-bottom:0.3rem;">${escH(pr.name)}</div>
                    <div style="color:var(--accent);font-size:0.7rem;margin-bottom:0.5rem;">${escH(pr.price)}</div>
                    ${pr.stripeLink ? '<a href="'+escH(pr.stripeLink)+'" target="_blank" style="display:inline-block;padding:0.4rem 1rem;background:var(--accent);color:var(--bg);border-radius:6px;font-size:0.5rem;font-weight:600;">Acheter</a>' : ''}
                </div>
            </div>`;
        });
        body = `<div class="hero"><h1>${escH(c.shopTitle||page.title)}</h1>${c.description?'<p>'+escH(c.description)+'</p>':''}</div>
        <section><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1.5rem;">${prods}</div></section>`;
    }
    else if(page.type === 'landing'){
        body = `<div class="hero" style="padding:6rem 2rem;${c.heroImage?'background-image:url('+escH(c.heroImage)+');background-size:cover;background-position:center;':''}">
            <h1>${escH(c.heroTitle||page.title)}</h1>
            <p style="margin-bottom:2rem;">${escH(c.heroSub||'')}</p>
            ${c.ctaText ? '<a href="'+escH(c.ctaLink||'#')+'" style="display:inline-block;padding:0.7rem 2rem;background:var(--accent);color:var(--bg);border-radius:8px;font-weight:600;font-size:0.6rem;letter-spacing:0.08em;">'+escH(c.ctaText)+'</a>' : ''}
        </div>
        ${c.description ? '<section><p style="max-width:700px;margin:0 auto;line-height:1.8;color:var(--dim);">'+escH(c.description)+'</p></section>' : ''}`;
    }
    else if(page.type === 'libre'){
        let blocks = '';
        (c.blocks||[]).forEach(bl => {
            if(bl.type === 'text'){
                blocks += `<div style="margin-bottom:2rem;">${bl.heading?'<h2 class="section-title">'+escH(bl.heading)+'</h2>':''}
                <p style="line-height:1.8;color:var(--dim);">${escH(bl.text)}</p></div>`;
            } else if(bl.type === 'image'){
                blocks += `<div style="margin-bottom:2rem;">${bl.heading?'<h2 class="section-title">'+escH(bl.heading)+'</h2>':''}
                ${bl.image?'<img src="'+escH(bl.image)+'" style="width:100%;border-radius:8px;">':''}</div>`;
            } else if(bl.type === 'text-image'){
                blocks += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;align-items:center;margin-bottom:2rem;">
                <div>${bl.heading?'<h2 class="section-title">'+escH(bl.heading)+'</h2>':''}<p style="line-height:1.8;color:var(--dim);">${escH(bl.text)}</p></div>
                <div>${bl.image?'<img src="'+escH(bl.image)+'" style="width:100%;border-radius:8px;">':''}</div></div>`;
            }
        });
        body = `<div class="hero"><h1>${escH(c.pageTitle||page.title)}</h1></div><section>${blocks}</section>`;
    }

    // Lightbox script
    const lbScript = `<script>function openLB(src){var o=document.createElement('div');o.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:10000;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';var i=document.createElement('img');i.src=src;i.style.cssText='max-width:92%;max-height:90vh;object-fit:contain;';o.appendChild(i);o.onclick=function(){o.remove();};document.body.appendChild(o);}</script>`;

    const fontLink = TPLS[cTPL].fonts ? `<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=${TPLS[cTPL].fonts}&display=swap">` : '';

    return `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>${escH(page.title)} — FOLYO</title>
${fontLink}
<style>${css}</style>
</head>
<body>
${nav}
${body}
<footer>© ${new Date().getFullYear()} — Créé avec FOLYO</footer>
${lbScript}
</body>
</html>`;
}

// =============================================
// EXPORT ZIP (replaces dl())
// =============================================
async function exportZip(){
    if(typeof JSZip === 'undefined'){
        alert('Erreur : JSZip non chargé. Vérifiez votre connexion internet.');
        return;
    }

    const zip = new JSZip();
    const siteName = (document.querySelector('#navLogo .editable')?.textContent||'folyo').trim().toLowerCase().replace(/[^a-z0-9]/g,'-');

    // Show progress
    showSaveConfirm('📦 Génération du ZIP...', 'Préparation des pages...');

    // 1. Export main page (index.html) using existing dl() logic
    const mainHTML = exportMainPage();
    zip.file('index.html', mainHTML);

    // 2. Export each additional page
    sitePages.forEach(p => {
        const pageHTML = buildPageHTML(p, sitePages);
        zip.file(p.slug + '.html', pageHTML);
    });

    // 3. README.md
    const readmePages = sitePages.map(p => `- **${p.slug}.html** — ${p.title} (${PAGE_LABELS[p.type]})`).join('\\n');
    zip.file('README.md', `# ${siteName.toUpperCase()}

Site généré avec **FOLYO** — Portfolio Builder.

## Pages

- **index.html** — Page principale
${readmePages}

## Déploiement

### GitHub Pages
1. Créez un repo sur GitHub
2. Uploadez tous les fichiers
3. Settings → Pages → Source: main → Save
4. Votre site est en ligne !

### Autre hébergeur
Uploadez tous les fichiers HTML à la racine de votre hébergement.

## Personnalisation
Rouvrez n'importe quel fichier .html dans votre navigateur pour le modifier avec l'éditeur FOLYO intégré.

---
Généré le ${new Date().toLocaleDateString('fr-FR')} avec [FOLYO](https://github.com/folyo)
`);

    // 4. deploy.sh
    zip.file('deploy.sh', `#!/bin/bash
# FOLYO — Script de déploiement GitHub Pages
# Usage: bash deploy.sh

set -e

echo "🎨 FOLYO — Déploiement"
echo "======================"

if [ ! -d .git ]; then
    git init
    echo "✓ Repo Git initialisé"
fi

git add -A
git commit -m "FOLYO site update — $(date +%Y-%m-%d)"

if ! git remote | grep -q origin; then
    echo ""
    echo "⚠ Pas de remote configuré."
    echo "Ajoutez-en un avec :"
    echo "  git remote add origin https://github.com/VOTRE_USER/VOTRE_REPO.git"
    echo "Puis relancez : bash deploy.sh"
    exit 1
fi

git push -u origin main
echo ""
echo "✅ Déployé ! Activez GitHub Pages dans Settings → Pages → Source: main"
`);

    // 5. .gitignore
    zip.file('.gitignore', `.DS_Store
Thumbs.db
*.swp
*~
`);

    // 6. _config.yml for GitHub Pages
    zip.file('_config.yml', 'theme: null\\n');

    // Generate and download
    try {
        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = siteName + '-site.zip';
        a.click();
        URL.revokeObjectURL(a.href);
        const pageCount = 1 + sitePages.length;
        showSaveConfirm('✅ ZIP exporté !', pageCount + ' page' + (pageCount>1?'s':'') + ' • README • deploy.sh');
    } catch(e) {
        alert('Erreur lors de la génération du ZIP : ' + e.message);
    }
}

// Export main page as clean HTML string (adapted from original dl())
function exportMainPage(){
    const c=document.documentElement.cloneNode(true);
    c.querySelectorAll('.edit-toolbar,.tp,.ov,.lb,.modal-bg,.form-toast,.save-badge,.save-confirm,.soc-picker-bg,.layout-picker-bg,.nuance-panel,.v2-confirm-bg,.cursor-dot,.cursor-ring,.audio-player,.preview-bar,.gi-del,.page-editor-overlay,#addPageModal').forEach(e=>e.remove());
    c.querySelectorAll('.bgfx-controls,.mail-cfg').forEach(e=>e.remove());
    c.querySelectorAll('[contenteditable]').forEach(e=>{e.removeAttribute('contenteditable');e.classList.remove('editable');});
    c.querySelectorAll('.gu').forEach(e=>e.remove());

    // Update nav links to include all pages
    const navUl = c.querySelector('#nLinks');
    if(navUl){
        let navH = '<li><a href="#portfolio">Portfolio</a></li><li><a href="#about">À propos</a></li><li><a href="#services">Services</a></li><li><a href="#contact">Contact</a></li>';
        sitePages.forEach(p => { navH += `<li><a href="${p.slug}.html">${escH(p.title)}</a></li>`; });
        navUl.innerHTML = navH;
    }

    // Bake contact form
    const form = c.querySelector('#contactForm');
    if(form){
        form.removeAttribute('onsubmit');
        if(mailMode==='mailto'){
            form.querySelectorAll('input[type=hidden]').forEach(e=>e.remove());
            form.setAttribute('data-mode','mailto');
            form.setAttribute('data-mailto', mailTo||'');
        } else if(mailMode==='formspree'){
            form.querySelectorAll('input[type=hidden]').forEach(e=>e.remove());
            form.setAttribute('action','https://formspree.io/f/'+mailFormspreeId);
            form.setAttribute('method','POST');
            form.setAttribute('data-mode','formspree');
        } else if(mailMode==='web3forms'){
            const ak=form.querySelector('#formAccessKey');
            if(ak) ak.value=mailWeb3Key;
            form.setAttribute('action','https://api.web3forms.com/submit');
            form.setAttribute('method','POST');
            form.setAttribute('data-mode','web3forms');
        }
    }

    c.querySelectorAll('.col-tab-add,.grid-controls,.col-actions,.csb-actions,.layout-picker-bg,.col-cover-upload').forEach(e=>e.remove());
    c.querySelectorAll('.csb-img-wrap input[type="file"]').forEach(e=>e.remove());
    c.querySelectorAll('.csb-img-wrap').forEach(wrap => { if(!wrap.querySelector('img')) wrap.remove(); });

    if(collections.length <= 1){
        const tabs = c.querySelector('.collection-tabs');
        if(tabs) tabs.remove();
    }

    // Build static gallery
    const colContent = c.querySelector('#colContent');
    if(colContent){
        let exportHTML = '';
        if(collections.length > 1){
            exportHTML += '<div class="col-covers" id="colCoversView">';
            collections.forEach((col, ci) => {
                const count = col.images.filter(Boolean).length;
                const coverSrc = col.cover || col.images.find(Boolean) || '';
                exportHTML += '<div class="col-cover-card" data-col="'+ci+'" onclick="openCol('+ci+')">';
                if(coverSrc) exportHTML += '<img src="'+coverSrc+'" alt="'+escH(col.name)+'">';
                else exportHTML += '<div class="col-cover-empty"></div>';
                exportHTML += '<div class="col-cover-info"><div class="col-cover-name">'+escH(col.name)+'</div><div class="col-cover-count">'+count+' œuvre'+(count!==1?'s':'')+'</div></div></div>';
            });
            exportHTML += '</div>';
        }
        collections.forEach((col, ci) => {
            const vis = collections.length <= 1 ? '' : 'display:none;';
            exportHTML += '<div class="col-page" id="col-'+ci+'" style="'+vis+'">';
            if(collections.length > 1) exportHTML += '<button class="col-back-btn" onclick="backToCovers()">← Retour</button>';
            if(col.desc) exportHTML += '<p class="col-desc">'+col.desc+'</p>';
            exportHTML += '<div class="gal" style="grid-template-columns:repeat('+col.gridCols+',1fr);">';
            col.images.forEach((img, i) => { if(img) exportHTML += '<div class="gi"><img src="'+img+'" alt="Œuvre '+(i+1)+'"></div>'; });
            exportHTML += '</div></div>';
        });
        colContent.innerHTML = exportHTML;
    }

    // Clean CSS
    const s=c.querySelector('style');
    if(s){
        s.textContent=s.textContent
            .replace(/\.editable\s*\{[^}]*\}/g,'')
            .replace(/\.editable:hover\s*\{[^}]*\}/g,'')
            .replace(/\.editable:focus\s*\{[^}]*\}/g,'');
    }

    // Bake theme
    const t=TH[cTH], b=c.querySelector('body');
    const bakeColor = (hex) => (nuanceHue||nuanceSat||nuanceLum||nuanceCon) ? adjustColor(hex, nuanceHue, nuanceSat, nuanceLum, nuanceCon) : hex;
    b.style.cssText=Object.entries({bg:bakeColor(t.bg),bg2:bakeColor(t.bg2),bg3:bakeColor(t.bg3),text:bakeColor(t.text),dim:bakeColor(t.dim),bright:bakeColor(t.bright),accent:bakeColor(t.accent),border:bakeColor(t.border),'bgfx':bgfxColor,'bgfx-o':bgfxIntensity/100}).map(([k,v])=>'--'+k+':'+v).join(';');
    if(TPLS[cTPL].id) b.classList.add(TPLS[cTPL].id);
    if(cTH >= 22) b.classList.add('light-theme');
    if(v2CardStyle!=='default') b.classList.add('cards-'+v2CardStyle);
    if(v2NavStyle!=='default') b.classList.add('nav-'+v2NavStyle);
    if(v2Spacing!=='default') b.classList.add('spacing-'+v2Spacing);
    if(v2GalGap!=='default') b.classList.add('galgap-'+v2GalGap);
    if(TPLS[cTPL].fonts){
        const fl=document.createElement('link');
        fl.rel='stylesheet';
        fl.href='https://fonts.googleapis.com/css2?family='+TPLS[cTPL].fonts+'&display=swap';
        c.querySelector('head').appendChild(fl);
    }
    if(BGS[cBG].id !== 'none'){
        b.classList.add('bg-'+BGS[cBG].id);
        const expLayer = c.querySelector('#bgLayer');
        if(expLayer && ['grain','grille','runes','tissu'].includes(BGS[cBG].id)){
            const rgb = hexToRgb(bgfxColor);
            let svg='';
            if(BGS[cBG].id==='grain') svg="<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/><feColorMatrix type='matrix' values='0 0 0 0 "+(rgb.r/255)+" 0 0 0 0 "+(rgb.g/255)+" 0 0 0 0 "+(rgb.b/255)+" 0 0 0 0.06 0'/></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>";
            if(svg){ expLayer.style.backgroundImage='url("data:image/svg+xml,'+encodeURIComponent(svg)+'")'; expLayer.style.backgroundRepeat='repeat'; }
        }
    }

    bakeSEO(c);

    c.querySelectorAll('script').forEach(e=>e.remove());
    // Remove JSZip
    c.querySelectorAll('script[src*="jszip"]').forEach(e=>e.remove());

    const ns=document.createElement('script');
    let exportScript = "document.querySelector('.menu-t')?.addEventListener('click',function(){document.querySelector('.n-links')?.classList.toggle('open')});\nfunction openCol(i){document.getElementById('colCoversView').style.display='none';document.getElementById('col-'+i).style.display='block';}\nfunction backToCovers(){document.querySelectorAll('.col-page').forEach(p=>p.style.display='none');document.getElementById('colCoversView').style.display='grid';}";

    if(collections.some(col => col.images.some(img => img))){
        exportScript += "\ndocument.querySelectorAll('.gi img').forEach(function(img){img.parentElement.style.cursor='pointer';img.parentElement.addEventListener('click',function(){var lb=document.createElement('div');lb.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:10001;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';var i=document.createElement('img');i.src=img.src;i.style.cssText='max-width:92%;max-height:90vh;object-fit:contain;';lb.appendChild(i);lb.onclick=function(){lb.remove();};document.body.appendChild(lb);});});";
    }

    if(collections.length > 1){
        exportScript += "\ndocument.querySelectorAll('.col-tab').forEach(function(tab,i){tab.addEventListener('click',function(){document.querySelectorAll('.col-tab').forEach(function(t){t.classList.remove('active');});tab.classList.add('active');document.querySelectorAll('.col-page').forEach(function(p){p.style.display='none';});document.querySelectorAll('.col-page')[i].style.display='';});});";
    }

    exportScript += "\nvar cf=document.getElementById('contactForm');if(cf){var mode=cf.getAttribute('data-mode')||'mailto';if(mode==='mailto'){cf.addEventListener('submit',function(e){e.preventDefault();var n=cf.querySelector('[name=name]').value,em=cf.querySelector('[name=email]').value,su=cf.querySelector('[name=subject]').value||'Nouveau message',ms=cf.querySelector('[name=message]').value,to=cf.getAttribute('data-mailto')||'';if(!to){alert('Email non configuré');return;}var body='Nom: '+n+'\\nEmail: '+em+'\\n\\n'+ms;window.open('mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(su)+'&body='+encodeURIComponent(body),'_blank');cf.reset();});}}";

    ns.textContent = exportScript;
    c.querySelector('body').appendChild(ns);

    return '<!DOCTYPE html>\n'+c.outerHTML;
}

// Init page manager on load
document.addEventListener('DOMContentLoaded', function(){ loadPages(); });


// =============================================
// THEME NUANCE SLIDERS
// =============================================
let nuanceHue = 0, nuanceSat = 0, nuanceLum = 0, nuanceCon = 0;

function hexToHSL(hex){
    let r=parseInt(hex.slice(1,3),16)/255, g=parseInt(hex.slice(3,5),16)/255, b=parseInt(hex.slice(5,7),16)/255;
    let max=Math.max(r,g,b), min=Math.min(r,g,b), h,s,l=(max+min)/2;
    if(max===min){h=s=0;}
    else{
        let d=max-min;
        s=l>0.5?d/(2-max-min):d/(max+min);
        switch(max){
            case r:h=((g-b)/d+(g<b?6:0))/6;break;
            case g:h=((b-r)/d+2)/6;break;
            case b:h=((r-g)/d+4)/6;break;
        }
    }
    return {h:h*360,s:s*100,l:l*100};
}

function hslToHex(h,s,l){
    h=((h%360)+360)%360; s=Math.max(0,Math.min(100,s))/100; l=Math.max(0,Math.min(100,l))/100;
    const a=s*Math.min(l,1-l);
    const f=n=>{const k=(n+h/30)%12;const c=l-a*Math.max(Math.min(k-3,9-k,1),-1);return Math.round(255*Math.max(0,Math.min(1,c))).toString(16).padStart(2,'0');};
    return '#'+f(0)+f(8)+f(4);
}

function adjustColor(hex, hueShift, satShift, lumShift, conShift){
    const hsl = hexToHSL(hex);
    let h = hsl.h + hueShift;
    let s = hsl.s + satShift;
    let l = hsl.l + lumShift;
    // Contrast: push darks darker, lights lighter
    if(conShift !== 0){
        const mid = 50;
        if(l < mid) l -= conShift * 0.3;
        else l += conShift * 0.3;
    }
    return hslToHex(h, s, l);
}

function applyNuance(){
    const t = TH[cTH];
    const r = document.documentElement.style;
    ['bg','bg2','bg3','text','dim','bright','accent','border'].forEach(k => {
        r.setProperty('--'+k, adjustColor(t[k], nuanceHue, nuanceSat, nuanceLum, nuanceCon));
    });
    updateNuancePreview();
    if(bgfxAuto) syncBgfxFromTheme();
    scheduleAutoSave();
}

function updateNuancePreview(){
    const t = TH[cTH];
    const preview = document.getElementById('nuancePreview');
    const keys = ['bg','bg2','accent','text','bright'];
    preview.innerHTML = '';
    keys.forEach(k => {
        const dot = document.createElement('div');
        dot.className = 'nuance-preview-dot';
        dot.style.background = adjustColor(t[k], nuanceHue, nuanceSat, nuanceLum, nuanceCon);
        dot.title = k;
        preview.appendChild(dot);
    });
}

function resetNuance(){
    nuanceHue=0; nuanceSat=0; nuanceLum=0; nuanceCon=0;
    document.getElementById('nuanceHue').value=0;
    document.getElementById('nuanceSat').value=0;
    document.getElementById('nuanceLum').value=0;
    document.getElementById('nuanceCon').value=0;
    document.getElementById('nuanceHueVal').textContent='0°';
    document.getElementById('nuanceSatVal').textContent='0%';
    document.getElementById('nuanceLumVal').textContent='0%';
    document.getElementById('nuanceConVal').textContent='0%';
    // Re-apply original theme
    const t=TH[cTH],r=document.documentElement.style;
    ['bg','bg2','bg3','text','dim','bright','accent','border'].forEach(k=>r.setProperty('--'+k,t[k]));
    updateNuancePreview();
    if(bgfxAuto) syncBgfxFromTheme();
    scheduleAutoSave();
}

function setNuanceFromValues(){
    document.getElementById('nuanceHue').value = nuanceHue;
    document.getElementById('nuanceSat').value = nuanceSat;
    document.getElementById('nuanceLum').value = nuanceLum;
    document.getElementById('nuanceCon').value = nuanceCon;
    document.getElementById('nuanceHueVal').textContent = nuanceHue+'°';
    document.getElementById('nuanceSatVal').textContent = nuanceSat+'%';
    document.getElementById('nuanceLumVal').textContent = nuanceLum+'%';
    document.getElementById('nuanceConVal').textContent = nuanceCon+'%';
    if(nuanceHue||nuanceSat||nuanceLum||nuanceCon) applyNuance();
    else updateNuancePreview();
}

// Wire up nuance sliders
document.getElementById('nuanceHue').addEventListener('input', function(e){ nuanceHue=parseInt(e.target.value); document.getElementById('nuanceHueVal').textContent=nuanceHue+'°'; applyNuance(); });
document.getElementById('nuanceSat').addEventListener('input', function(e){ nuanceSat=parseInt(e.target.value); document.getElementById('nuanceSatVal').textContent=nuanceSat+'%'; applyNuance(); });
document.getElementById('nuanceLum').addEventListener('input', function(e){ nuanceLum=parseInt(e.target.value); document.getElementById('nuanceLumVal').textContent=nuanceLum+'%'; applyNuance(); });
document.getElementById('nuanceCon').addEventListener('input', function(e){ nuanceCon=parseInt(e.target.value); document.getElementById('nuanceConVal').textContent=nuanceCon+'%'; applyNuance(); });
updateNuancePreview();

// =============================================
// CUSTOM BODY SECTIONS
// =============================================
let customSections = [];

function renderCustomSections(){
    const area = document.getElementById('customSectionsArea');
    area.innerHTML = '';
    customSections.forEach((sec, i) => {
        const block = document.createElement('section');
        block.className = 'custom-section-block';
        block.dataset.idx = i;
        let imgHTML = '';
        if(sec.image){
            imgHTML = `<img src="${sec.image}" alt="${escH(sec.title||'')}">`;
        } else {
            imgHTML = `<div class="csb-img-placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Image</div>`;
        }
        block.innerHTML = `
            <div class="csb-actions">
                ${i > 0 ? `<button class="csb-act-btn" onclick="moveCustomSection(${i},-1)" title="Monter">↑</button>` : ''}
                ${i < customSections.length-1 ? `<button class="csb-act-btn" onclick="moveCustomSection(${i},1)" title="Descendre">↓</button>` : ''}
                <button class="csb-act-btn" onclick="changeCustomLayout(${i})" title="Changer disposition">⬒</button>
                <button class="csb-act-btn del" onclick="removeCustomSection(${i})" title="Supprimer">✕</button>
            </div>
            <div class="cw">
                <div class="csb-inner layout-${sec.layout||'left'}">
                    <div class="csb-img-wrap">
                        ${imgHTML}
                        <input type="file" accept="image/*" data-csb="${i}" onchange="handleCSBImageUpload(event)">
                    </div>
                    <div class="csb-text">
                        <div class="csb-title editable" contenteditable="true" data-csb-field="title" data-csb-idx="${i}">${sec.title||'Titre de la section'}</div>
                        <div class="csb-desc editable" contenteditable="true" data-csb-field="desc" data-csb-idx="${i}">${sec.desc||'Décrivez cette section. Vous pouvez ajouter du texte, parler de votre processus créatif, vos inspirations, ou tout autre contenu.'}</div>
                    </div>
                </div>
            </div>`;
        area.appendChild(block);
    });
    // Wire up editable events on new sections
    area.querySelectorAll('.editable').forEach(el => {
        el.addEventListener('blur', function(){
            const idx = parseInt(this.dataset.csbIdx);
            const field = this.dataset.csbField;
            if(idx >= 0 && field && customSections[idx]){
                customSections[idx][field] = this.innerHTML;
                renderCSBPanel();
                scheduleAutoSave();
            }
        });
    });
}

function handleCSBImageUpload(e){
    const f = e.target.files[0]; if(!f) return;
    const idx = parseInt(e.target.dataset.csb);
    if(f.size > 5*1024*1024){ alert('Fichier trop volumineux (max 5Mo)'); return; }
    const r = new FileReader();
    r.onload = async ev => {
        customSections[idx].image = await compressImage(ev.target.result, 1200, 0.7);
        renderCustomSections();
        renderCSBPanel();
        scheduleAutoSave();
    };
    r.readAsDataURL(f);
}

function removeCustomSection(i){
    if(!confirm('Supprimer cette section ?')) return;
    customSections.splice(i, 1);
    renderCustomSections();
    renderCSBPanel();
    scheduleAutoSave();
}

function moveCustomSection(i, dir){
    const j = i + dir;
    if(j < 0 || j >= customSections.length) return;
    [customSections[i], customSections[j]] = [customSections[j], customSections[i]];
    renderCustomSections();
    renderCSBPanel();
    scheduleAutoSave();
}

function changeCustomLayout(i){
    const layouts = ['left','right','top','textonly'];
    const cur = layouts.indexOf(customSections[i].layout || 'left');
    customSections[i].layout = layouts[(cur+1)%layouts.length];
    renderCustomSections();
    renderCSBPanel();
    scheduleAutoSave();
}

// Layout picker for new sections
let layoutPickerCallback = null;

function openLayoutPicker(){
    document.getElementById('layoutPickerBg').classList.add('show');
}

function closeLayoutPicker(){
    document.getElementById('layoutPickerBg').classList.remove('show');
}

function pickLayout(layout){
    closeLayoutPicker();
    customSections.push({
        id: 'csb_' + Date.now(),
        title: 'Nouvelle section',
        desc: 'Décrivez cette section. Cliquez pour modifier le texte.',
        image: null,
        layout: layout
    });
    renderCustomSections();
    renderCSBPanel();
    scheduleAutoSave();
}

// Panel list in theme panel
function renderCSBPanel(){
    const list = document.getElementById('csbPanelList');
    if(!list) return;
    if(customSections.length === 0){
        list.innerHTML = '<div class="csb-empty">Aucune section — cliquez + pour ajouter</div>';
        return;
    }
    list.innerHTML = '';
    customSections.forEach((sec, i) => {
        const item = document.createElement('div');
        item.className = 'csb-panel-item';
        const layoutNames = {left:'◧ Gauche', right:'◨ Droite', top:'⬒ Haut', textonly:'¶ Texte'};
        const thumbHTML = sec.image
            ? `<img src="${sec.image}" alt="">`
            : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`;
        // Strip HTML tags for display
        const plainTitle = (sec.title||'Sans titre').replace(/<[^>]*>/g,'');
        item.innerHTML = `
            <div class="csb-panel-thumb">${thumbHTML}</div>
            <div class="csb-panel-info">
                <div class="csb-panel-name">${escH(plainTitle)}</div>
                <div class="csb-panel-layout">${layoutNames[sec.layout||'left']||'◧ Gauche'}</div>
            </div>
            <div class="csb-panel-btns">
                ${i > 0 ? `<button class="csb-panel-btn" onclick="moveCustomSection(${i},-1)" title="Monter">↑</button>` : ''}
                ${i < customSections.length-1 ? `<button class="csb-panel-btn" onclick="moveCustomSection(${i},1)" title="Descendre">↓</button>` : ''}
                <button class="csb-panel-btn" onclick="changeCustomLayout(${i})" title="Changer disposition">⬒</button>
                <button class="csb-panel-btn del" onclick="removeCustomSection(${i})" title="Supprimer">✕</button>
            </div>`;
        list.appendChild(item);
    });
}

renderCSBPanel();

// =============================================
// SAVE / LOAD SYSTEM
// =============================================
const SAVE_KEY = 'folyo-portfolio-state';
let autoSaveTimer = null;
let saveCount = 0;

function gatherState(){
    // Sync service blocks from DOM before saving
    syncServiceBlocksFromDOM();
    // Collect all editable text — null for service block editables (saved separately)
    const editables = {};
    document.querySelectorAll('.editable').forEach((el,i)=>{
        if(el.closest('#services .sg')){
            editables[i] = null; // placeholder to keep indices stable
        } else {
            editables[i] = el.innerHTML;
        }
    });
    return {
        v: 4,
        ts: Date.now(),
        cTPL, cTH, cBG,
        bgfxColor, bgfxAuto, bgfxIntensity,
        nuanceHue, nuanceSat, nuanceLum, nuanceCon,
        logoData,
        collections: collections.map(c=>({
            id:c.id, name:c.name, desc:c.desc,
            images:c.images, gridCols:c.gridCols
        })),
        activeCol,
        customSections: customSections.map(s=>({
            id:s.id, title:s.title, desc:s.desc,
            image:s.image, layout:s.layout
        })),
        mailMode, mailTo,
        mailFormspreeId: document.getElementById('mailFormspreeId').value,
        mailWeb3Key: document.getElementById('mailWeb3Key').value,
        socLinks: socLinks.map(l=>({icon:l.icon,label:l.label,url:l.url})),
        v2CardStyle: v2CardStyle,
        v2NavStyle: v2NavStyle,
        v2Spacing: v2Spacing,
        v2GalGap: v2GalGap,
        v2HeroSize: v2HeroSize,
        v2HeroSpacing: v2HeroSpacing,
        v2ScrollTop: v2ScrollTop,
        v2BgImgData: bgImgData,
        v2BgImgName: bgImgName,
        v2BgImgMode: bgImgMode,
        v2BgImgOpacity: bgImgOpacity,
        v2BgImgBrightness: bgImgBrightness,
        v2BgImgBlur: bgImgBlur,
        v2HeroLayout: curHeroLayout,
        v2GalLayout: curGalLayout,
        v2ScrollAnim: curScrollAnim,
        v2HoverFx: curHoverFx,
        v2CursorFx: curCursorFx,
        v2HeroMedia: heroMediaData,
        v2Audio: audioData,
        v2AudioName: audioName,
        statLabels: Array.from(document.querySelectorAll('#about .slb')).map(el=>el.textContent),
        serviceIcons: Array.from(document.querySelectorAll('#services .si')).map(el=>el.textContent),
        quickLinks: quickLinks.map(l=>({icon:l.icon||'🔗',label:l.label||'',url:l.url||''})),
        serviceBlocks: serviceBlocks.map(s=>({icon:s.icon||'✦',name:s.name||'',desc:s.desc||'',price:s.price||'',url:s.url||''})),
        advColors: Object.assign({}, advColors),
        typoBody, typoHead, typoSize, typoLine,
        editables,
        seoTitle, seoDesc, seoUrl, seoOgImage,
        sectionOrder
    };
}

function saveState(silent){
    try {
        const state = gatherState();
        const json = JSON.stringify(state);
        const sizeMB = (json.length * 2 / 1024 / 1024).toFixed(1);
        try {
            localStorage.setItem(SAVE_KEY, json);
        } catch(quotaErr) {
            // Quota exceeded — try compressing all stored images
            console.warn('Quota exceeded, compressing stored images...');
            for(const c of state.collections||[]){
                if(c.images){
                    c.images = c.images.map(img => {
                        if(!img) return null;
                        // Reduce quality further for already-stored images
                        if(img.length > 100000){
                            const canvas = document.createElement('canvas');
                            const tmpImg = new Image();
                            tmpImg.src = img;
                            // Can't async here — just truncate oversized base64
                            return img.substring(0, 80000);
                        }
                        return img;
                    });
                }
                if(c.cover && c.cover.length > 80000) c.cover = null;
            }
            // Remove hero media / bg image if too large
            if(state.v2HeroMedia && state.v2HeroMedia.length > 100000) delete state.v2HeroMedia;
            if(state.bgImgData && state.bgImgData.length > 100000) delete state.bgImgData;
            const reducedJson = JSON.stringify(state);
            try {
                localStorage.setItem(SAVE_KEY, reducedJson);
                if(!silent) showSaveConfirm('⚠ Sauvegardé (compressé)', 'Images réduites pour libérer de l\'espace');
                return true;
            } catch(e2){
                if(!silent) showSaveConfirm('⚠ Stockage plein', 'Supprimez des images ou cliquez Reset');
                return false;
            }
        }
        saveCount++;
        if(!silent){
            showSaveConfirm('✓ Sauvegardé (' + sizeMB + ' Mo)', new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}));
        } else {
            flashBadge();
        }
        return true;
    } catch(e){
        if(!silent) showSaveConfirm('⚠ Erreur', e.message||'Impossible de sauvegarder');
        return false;
    }
}

function loadState(){
    try {
        const raw = localStorage.getItem(SAVE_KEY);
        if(!raw) return false;
        const s = JSON.parse(raw);
        if(!s || !s.v) return false;

        // Migrate v3 → v4: extract service data from editables into serviceBlocks
        if(s.v < 4 && !s.serviceBlocks){
            // Old saves stored service text in the global editables array
            // Read current DOM services as baseline, then let editables restore overwrite them
            syncServiceBlocksFromDOM();
            s.serviceBlocks = serviceBlocks.map(b=>({...b}));
            s.v = 4;
        }

        // Template
        if(s.cTPL != null && s.cTPL < TPLS.length) applyTPL(s.cTPL);

        // Theme
        if(s.cTH != null && s.cTH < TH.length) applyTH(s.cTH);

        // Background
        if(s.cBG != null && s.cBG < BGS.length) applyBG(s.cBG);

        // Bgfx
        if(s.bgfxAuto != null) bgfxAuto = s.bgfxAuto;
        document.getElementById('bgfxAutoBtn').classList.toggle('active', bgfxAuto);
        if(s.bgfxColor && !bgfxAuto) applyBgfxColor(s.bgfxColor);
        if(bgfxAuto) syncBgfxFromTheme();
        if(s.bgfxIntensity != null){
            document.getElementById('bgfxIntSlider').value = s.bgfxIntensity;
            setIntensity(s.bgfxIntensity);
        }

        // Logo
        if(s.logoData){
            logoData = s.logoData;
            applyLogo(logoData);
            // Update preview panel
            document.getElementById('logoPreviewImg').src = logoData;
            document.getElementById('logoPreviewName').textContent = 'Logo sauvegardé';
            const kb = Math.round(logoData.length * 3 / 4 / 1024);
            document.getElementById('logoPreviewSize').textContent = kb + ' Ko';
            document.getElementById('logoUploadZone').style.display='none';
            document.getElementById('logoPreview').classList.add('active');
        }

        // Collections
        if(s.collections && s.collections.length){
            collections = s.collections.map(c=>({
                id: c.id,
                name: c.name,
                desc: c.desc || '',
                images: c.images || [],
                gridCols: c.gridCols || 3
            }));
            activeCol = (s.activeCol != null && s.activeCol < collections.length) ? s.activeCol : 0;
            renderColTabs();
            renderColContent();
        }

        // Mail config
        if(s.mailMode){ mailMode = s.mailMode; setMailMode(s.mailMode); }
        if(s.mailTo){ document.getElementById('mailTo').value = s.mailTo; mailTo = s.mailTo; }
        if(s.mailFormspreeId) document.getElementById('mailFormspreeId').value = s.mailFormspreeId;
        if(s.mailWeb3Key) document.getElementById('mailWeb3Key').value = s.mailWeb3Key;
        updateMailStatus();

        // Nuance
        if(s.nuanceHue != null) nuanceHue = s.nuanceHue;
        if(s.nuanceSat != null) nuanceSat = s.nuanceSat;
        if(s.nuanceLum != null) nuanceLum = s.nuanceLum;
        if(s.nuanceCon != null) nuanceCon = s.nuanceCon;
        setNuanceFromValues();

        // Custom sections
        if(s.customSections && s.customSections.length){
            customSections = s.customSections.map(sec=>({
                id: sec.id, title: sec.title||'', desc: sec.desc||'',
                image: sec.image||null, layout: sec.layout||'left'
            }));
            renderCustomSections();
            renderCSBPanel();
        }

        // Social links
        if(s.socLinks && Array.isArray(s.socLinks)){
            socLinks = s.socLinks.map(l=>({icon:l.icon||'🔗', label:l.label||'', url:l.url||''}));
            renderSocPanel();
        }

        // V2d: Extra customization
        if(s.v2CardStyle) setCardStyle(s.v2CardStyle);
        if(s.v2NavStyle) setNavStyle(s.v2NavStyle);
        if(s.v2Spacing) setSpacing(s.v2Spacing);
        if(s.v2GalGap) setGalGap(s.v2GalGap);
        if(s.v2HeroSize){
            v2HeroSize=s.v2HeroSize;
            document.getElementById('heroSizeSlider').value=v2HeroSize;
            document.getElementById('heroSizeVal').textContent=v2HeroSize+'%';
            setHeroSize(v2HeroSize);
        }
        if(s.v2HeroSpacing!=null){
            v2HeroSpacing=s.v2HeroSpacing;
            document.getElementById('heroSpacingSlider').value=v2HeroSpacing;
            document.getElementById('heroSpacingVal').textContent=v2HeroSpacing+'px';
            setHeroSpacing(v2HeroSpacing);
        }
        if(s.v2ScrollTop){ v2ScrollTop=s.v2ScrollTop; document.getElementById('scrollTopToggle')?.classList.toggle('active',true); }

        // V2: Background image
        if(s.v2BgImgData){
            bgImgData=s.v2BgImgData; bgImgName=s.v2BgImgName||'';
            bgImgMode=s.v2BgImgMode||'cover'; bgImgOpacity=s.v2BgImgOpacity||30;
            bgImgBrightness=s.v2BgImgBrightness||100; bgImgBlur=s.v2BgImgBlur||0;
            applyBgImg();
            document.getElementById('bgImgThumb').src=bgImgData;
            document.getElementById('bgImgName').textContent=bgImgName;
            document.getElementById('bgImgPreview').classList.add('active');
            document.getElementById('bgImgZone').style.display='none';
            document.getElementById('bgImgControls').classList.add('active');
            document.getElementById('bgImgOpSlider').value=bgImgOpacity;
            document.getElementById('bgImgOpVal').textContent=bgImgOpacity+'%';
            document.getElementById('bgImgBrSlider').value=bgImgBrightness;
            document.getElementById('bgImgBrVal').textContent=bgImgBrightness+'%';
            document.getElementById('bgImgBlSlider').value=bgImgBlur;
            document.getElementById('bgImgBlVal').textContent=bgImgBlur+'px';
            document.querySelectorAll('#bgImgModeRow .tp-chip').forEach(c=>{
                c.classList.toggle('active',c.textContent===BGIMG_MODES.find(m=>m.id===bgImgMode)?.n);
            });
        }

        // V2 state
        if(s.v2HeroLayout && s.v2HeroLayout!=='centered') setHeroLayout(s.v2HeroLayout);
        if(s.v2GalLayout && s.v2GalLayout!=='grid') setGalLayout(s.v2GalLayout);
        if(s.v2ScrollAnim && s.v2ScrollAnim!=='none') setScrollAnim(s.v2ScrollAnim);
        if(s.v2HoverFx && s.v2HoverFx!=='zoom') setHoverFx(s.v2HoverFx);
        if(s.v2CursorFx && s.v2CursorFx!=='none') setCursorFx(s.v2CursorFx);
        if(s.v2HeroMedia){heroMediaData=s.v2HeroMedia;const img=document.getElementById('heroMediaImg');const ph=document.getElementById('heroMediaPlaceholder');if(img){img.src=heroMediaData;img.style.display='block';}if(ph)ph.style.display='none';}
        if(s.v2Audio){audioData=s.v2Audio;audioName=s.v2AudioName||'';const el=document.getElementById('audioEl');el.src=audioData;document.getElementById('audioTitle').textContent=audioName;document.getElementById('audioPlayer').classList.add('active');}
        if(s.statLabels&&s.statLabels.length){document.querySelectorAll('#about .slb').forEach((el,i)=>{if(s.statLabels[i])el.textContent=s.statLabels[i];});}
        if(s.serviceIcons&&s.serviceIcons.length){document.querySelectorAll('#services .si').forEach((el,i)=>{if(s.serviceIcons[i])el.textContent=s.serviceIcons[i];});}

        // Quick links
        if(s.quickLinks && Array.isArray(s.quickLinks)){
            quickLinks = s.quickLinks.map(l=>({icon:l.icon||'🔗', label:l.label||'', url:l.url||''}));
            renderQuickLinksPanel();
        }

        // Service blocks — always restore (from save or from current DOM)
        if(s.serviceBlocks && Array.isArray(s.serviceBlocks) && s.serviceBlocks.length){
            serviceBlocks = s.serviceBlocks.map(b=>({icon:b.icon||'✦', name:b.name||'', desc:b.desc||'', price:b.price||'', url:b.url||''}));
        } else {
            // No saved serviceBlocks — read from current DOM (first load or old save)
            syncServiceBlocksFromDOM();
        }
        renderServiceBlocksDOM();
        renderServicePanel();

        // Advanced colors
        if(s.advColors && typeof s.advColors === 'object'){
            advColors = s.advColors;
            Object.keys(advColors).forEach(k => {
                if(advColors[k]) document.documentElement.style.setProperty('--'+k, advColors[k]);
            });
            syncAdvColorUI();
    // Load new features
    if(s.seoTitle !== undefined) loadSEO(s);
    if(s.sectionOrder) loadSectionOrder(s);
        }

        // Typography
        if(s.typoBody){ typoBody = s.typoBody; document.getElementById('typoBodySelect').value = typoBody; setTypoBody(typoBody); }
        if(s.typoHead){ typoHead = s.typoHead; document.getElementById('typoHeadSelect').value = typoHead; setTypoHead(typoHead); }
        if(s.typoSize != null){ typoSize = s.typoSize; document.getElementById('typoSizeSlider').value = typoSize; document.getElementById('typoSizeVal').textContent = typoSize+'%'; setTypoSize(typoSize); }
        if(s.typoLine != null){ typoLine = s.typoLine; document.getElementById('typoLineSlider').value = typoLine; document.getElementById('typoLineVal').textContent = (typoLine/100).toFixed(1); setTypoLine(typoLine); }

        // Editable text
        if(s.editables){
            document.querySelectorAll('.editable').forEach((el,i)=>{
                if(el.closest('#services .sg')) return; // restored via serviceBlocks
                if(s.editables[i] != null) el.innerHTML = s.editables[i];
            });
        }

        return true;
    } catch(e){
        console.warn('Erreur chargement sauvegarde:', e);
        return false;
    }
}

function manualSave(){
    saveState(false);
}

function confirmReset(){
    if(confirm('⚠ Supprimer toute la sauvegarde ?\n\nCette action est irréversible.\nLe portfolio reviendra à son état initial.')){
        localStorage.removeItem(SAVE_KEY);
        location.reload();
    }
}

function scheduleAutoSave(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(()=> saveState(true), 1500);
}

function flashBadge(){
    const b = document.getElementById('saveBadge');
    b.classList.add('show');
    setTimeout(()=>b.classList.remove('show'), 1800);
}

function showSaveConfirm(text, sub){
    const el = document.getElementById('saveConfirm');
    document.getElementById('saveConfirmText').textContent = text;
    document.getElementById('saveConfirmSub').textContent = sub || '';
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 2500);
}

// Hook autosave to all editable blur events
function hookAutoSave(){
    // Editables
    document.querySelectorAll('.editable').forEach(el=>{
        el.addEventListener('blur', scheduleAutoSave);
        el.addEventListener('input', ()=>{ if(autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(()=>saveState(true), 3000); });
    });
    // Panel inputs
    ['mailTo','mailFormspreeId','mailWeb3Key'].forEach(id=>{
        document.getElementById(id)?.addEventListener('input', scheduleAutoSave);
    });
    // Keyboard shortcut Ctrl+S
    document.addEventListener('keydown', e=>{
        if((e.ctrlKey || e.metaKey) && e.key === 's'){
            e.preventDefault();
            saveState(false);
        }
    });
}

// Wrap existing functions to trigger autosave
const _origApplyTH = applyTH;
applyTH = function(i){ _origApplyTH(i); if(nuanceHue||nuanceSat||nuanceLum||nuanceCon) applyNuance(); else updateNuancePreview(); scheduleAutoSave(); };
const _origApplyBG = applyBG;
applyBG = function(i){ _origApplyBG(i); scheduleAutoSave(); };
const _origApplyTPL = applyTPL;
applyTPL = function(i){ _origApplyTPL(i); scheduleAutoSave(); };
const _origApplyBgfxColor = applyBgfxColor;
applyBgfxColor = function(c){ _origApplyBgfxColor(c); scheduleAutoSave(); };
const _origSetIntensity = setIntensity;
setIntensity = function(v){ _origSetIntensity(v); scheduleAutoSave(); };
const _origToggleBgfxAuto = toggleBgfxAuto;
toggleBgfxAuto = function(){ _origToggleBgfxAuto(); scheduleAutoSave(); };
const _origSetMailMode = setMailMode;
setMailMode = function(m){ _origSetMailMode(m); scheduleAutoSave(); };


// =============================================
// V2: TAB SYSTEM
// =============================================
function switchTab(id){
    document.querySelectorAll('.tp-tab').forEach(t=>t.classList.toggle('active',t.textContent.toLowerCase().includes(id.substring(0,3))));
    document.querySelectorAll('.tp-pane').forEach(p=>p.classList.toggle('active',p.id==='pane-'+id));
}

// =============================================
// V2: HERO LAYOUTS
// =============================================
const HERO_LAYOUTS=[
    {id:'centered',n:'Centré'},
    {id:'split',n:'Split'},
    {id:'fullscreen',n:'Plein écran'},
    {id:'minimal',n:'Minimal'}
];
let curHeroLayout='centered';
let heroMediaData=null;

function buildHeroLayoutRow(){
    const r=document.getElementById('heroLayoutRow');
    if(!r) return;
    const heroTips={centered:'Texte centré, classique et universel',split:'Texte à gauche, image à droite',fullscreen:'Image plein écran avec texte superposé',minimal:'Titre géant uniquement, ultra épuré'};
    HERO_LAYOUTS.forEach(l=>{
        const c=document.createElement('button');
        c.className='tp-chip'+(l.id===curHeroLayout?' active':'');
        c.textContent=l.n;
        if(heroTips[l.id]) c.title=heroTips[l.id];
        c.onclick=()=>setHeroLayout(l.id);
        r.appendChild(c);
    });
}

function setHeroLayout(id){
    const hero=document.getElementById('hero');
    const media=document.getElementById('heroMedia');
    curHeroLayout=id;
    hero.className='hero';
    if(media) media.style.display='none';

    if(id==='split'){
        hero.classList.add('hero-split');
        // Wrap text content in .hero-text if not already
        if(!hero.querySelector('.hero-text')){
            const textEls=[hero.querySelector('.ptc'),hero.querySelector('.hero-logo-wrap'),
                hero.querySelector('.h-sub'),hero.querySelector('.h-title'),
                hero.querySelector('.h-tag'),hero.querySelector('.h-desc'),
                hero.querySelector('.h-btns')].filter(Boolean);
            const wrapper=document.createElement('div');
            wrapper.className='hero-text';
            textEls.forEach(el=>wrapper.appendChild(el));
            hero.insertBefore(wrapper, hero.firstChild);
        }
        if(media) media.style.display='';
    } else if(id==='fullscreen'){
        hero.classList.add('hero-fullscreen');
        // Unwrap text if wrapped
        unwrapHeroText(hero);
        if(media) media.style.display='';
    } else if(id==='minimal'){
        hero.classList.add('hero-minimal');
        unwrapHeroText(hero);
    } else {
        unwrapHeroText(hero);
    }

    document.querySelectorAll('#heroLayoutRow .tp-chip').forEach(c=>c.classList.toggle('active',c.textContent===HERO_LAYOUTS.find(l=>l.id===id)?.n));
    scheduleAutoSave();
}

function unwrapHeroText(hero){
    const wrapper=hero.querySelector('.hero-text');
    if(wrapper){
        while(wrapper.firstChild) hero.insertBefore(wrapper.firstChild, wrapper);
        wrapper.remove();
    }
}

function handleHeroMedia(e){
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
        heroMediaData=ev.target.result;
        const img=document.getElementById('heroMediaImg');
        const ph=document.getElementById('heroMediaPlaceholder');
        if(img){img.src=heroMediaData; img.style.display='block';}
        if(ph) ph.style.display='none';
        scheduleAutoSave();
    };
    reader.readAsDataURL(file);
}

// =============================================
// V2: GALLERY LAYOUTS
// =============================================
const GAL_LAYOUTS=[
    {id:'grid',n:'Grille'},
    {id:'masonry',n:'Masonry'},
    {id:'hscroll',n:'Horizontal'},
    {id:'showcase',n:'Showcase'},
    {id:'list',n:'Liste'}
];
let curGalLayout='grid';

function buildGalLayoutRow(){
    const r=document.getElementById('galLayoutRow');
    if(!r) return;
    const galTips={grid:'Images en grille uniforme (carrés)',masonry:'Style Pinterest, hauteurs variables',hscroll:'Défilement horizontal, une image à la fois',showcase:'Grandes cartes 16:9 panoramiques',list:'Liste minimaliste, image au survol'};
    GAL_LAYOUTS.forEach(l=>{
        const c=document.createElement('button');
        c.className='tp-chip'+(l.id===curGalLayout?' active':'');
        c.textContent=l.n;
        if(galTips[l.id]) c.title=galTips[l.id];
        c.onclick=()=>setGalLayout(l.id);
        r.appendChild(c);
    });
}

function setGalLayout(id){
    curGalLayout=id;
    document.querySelectorAll('.gal').forEach(g=>{
        g.classList.remove('gal-masonry','gal-hscroll','gal-showcase','gal-list');
        if(id==='masonry') g.classList.add('gal-masonry');
        else if(id==='hscroll') g.classList.add('gal-hscroll');
        else if(id==='showcase') g.classList.add('gal-showcase');
        else if(id==='list') g.classList.add('gal-list');
    });
    document.querySelectorAll('#galLayoutRow .tp-chip').forEach(c=>c.classList.toggle('active',c.textContent===GAL_LAYOUTS.find(l=>l.id===id)?.n));
    scheduleAutoSave();
}

// =============================================
// V2: SCROLL ANIMATIONS
// =============================================
const SCROLL_ANIMS=[
    {id:'none',n:'Aucune'},
    {id:'fade',n:'Fade In'},
    {id:'slide',n:'Slide'},
    {id:'scale',n:'Scale'}
];
let curScrollAnim='none';
let scrollObserver=null;

function buildScrollAnimRow(){
    const r=document.getElementById('scrollAnimRow');
    if(!r) return;
    const scrollTips={none:'Pas d\'animation, tout est visible directement',fade:'Apparition douce du bas vers le haut',slide:'Glissement latéral élégant',scale:'Zoom subtil à l\'apparition'};
    SCROLL_ANIMS.forEach(a=>{
        const c=document.createElement('button');
        c.className='tp-chip'+(a.id===curScrollAnim?' active':'');
        c.textContent=a.n;
        if(scrollTips[a.id]) c.title=scrollTips[a.id];
        c.onclick=()=>setScrollAnim(a.id);
        r.appendChild(c);
    });
}

function setScrollAnim(id){
    curScrollAnim=id;
    document.body.classList.toggle('scroll-anim',id!=='none');

    // Reset all animated elements
    document.querySelectorAll('[data-anim]').forEach(el=>{
        el.classList.remove('anim-in');
        if(id==='none'){
            el.style.opacity=''; el.style.transform='';
        }
    });

    if(scrollObserver) scrollObserver.disconnect();
    if(id!=='none'){
        scrollObserver=new IntersectionObserver((entries)=>{
            entries.forEach(e=>{
                if(e.isIntersecting) e.target.classList.add('anim-in');
            });
        },{threshold:0.15,rootMargin:'0px 0px -50px 0px'});
        document.querySelectorAll('[data-anim]').forEach((el,i)=>{
            el.style.transitionDelay=(i%4)*0.1+'s';
            scrollObserver.observe(el);
        });
    }
    document.querySelectorAll('#scrollAnimRow .tp-chip').forEach(c=>c.classList.toggle('active',c.textContent===SCROLL_ANIMS.find(a=>a.id===id)?.n));
    scheduleAutoSave();
}

// =============================================
// V2: HOVER EFFECTS
// =============================================
const HOVER_FX=[
    {id:'zoom',n:'Zoom'},
    {id:'overlay',n:'Overlay'},
    {id:'bw',n:'N&B'},
    {id:'blur',n:'Flou'},
    {id:'border',n:'Bordure'}
];
let curHoverFx='zoom';

function buildHoverFxRow(){
    const r=document.getElementById('hoverFxRow');
    if(!r) return;
    const hoverTips={zoom:'Léger agrandissement de l\'image',overlay:'Voile sombre qui apparaît',bw:'Noir & blanc → couleur au survol',blur:'Flou qui se dissipe',border:'Bordure colorée qui apparaît'};
    HOVER_FX.forEach(h=>{
        const c=document.createElement('button');
        c.className='tp-chip'+(h.id===curHoverFx?' active':'');
        c.textContent=h.n;
        if(hoverTips[h.id]) c.title=hoverTips[h.id];
        c.onclick=()=>setHoverFx(h.id);
        r.appendChild(c);
    });
}

function setHoverFx(id){
    curHoverFx=id;
    const port=document.getElementById('portfolio');
    if(port){
        port.classList.remove('hover-overlay','hover-bw','hover-blur','hover-border');
        if(id!=='zoom') port.classList.add('hover-'+id);
    }
    document.querySelectorAll('#hoverFxRow .tp-chip').forEach(c=>c.classList.toggle('active',c.textContent===HOVER_FX.find(h=>h.id===id)?.n));
    scheduleAutoSave();
}

// =============================================
// V2: CURSOR EFFECTS
// =============================================
const CURSOR_FX=[
    {id:'none',n:'Standard'},
    {id:'dot',n:'Dot'}
];
let curCursorFx='none';

function buildCursorFxRow(){
    const r=document.getElementById('cursorFxRow');
    if(!r) return;
    CURSOR_FX.forEach(c=>{
        const btn=document.createElement('button');
        btn.className='tp-chip'+(c.id===curCursorFx?' active':'');
        btn.textContent=c.n;
        btn.onclick=()=>setCursorFx(c.id);
        r.appendChild(btn);
    });
}

function setCursorFx(id){
    curCursorFx=id;
    const dot=document.getElementById('cursorDot');
    const ring=document.getElementById('cursorRing');
    if(id==='dot'){
        dot.classList.add('visible');ring.classList.add('visible');
        document.body.style.cursor='none';
    } else {
        dot.classList.remove('visible');ring.classList.remove('visible');
        document.body.style.cursor='';
    }
    document.querySelectorAll('#cursorFxRow .tp-chip').forEach(c=>c.classList.toggle('active',c.textContent===CURSOR_FX.find(x=>x.id===id)?.n));
    scheduleAutoSave();
}

// Cursor movement
let mouseX=0,mouseY=0,dotX=0,dotY=0;
document.addEventListener('mousemove',e=>{
    mouseX=e.clientX;mouseY=e.clientY;
    const ring=document.getElementById('cursorRing');
    if(ring) {ring.style.left=mouseX+'px';ring.style.top=mouseY+'px';}
});
(function animDot(){
    dotX+=(mouseX-dotX)*0.15;dotY+=(mouseY-dotY)*0.15;
    const dot=document.getElementById('cursorDot');
    if(dot){dot.style.left=dotX-2.5+'px';dot.style.top=dotY-2.5+'px';}
    requestAnimationFrame(animDot);
})();
document.addEventListener('mouseenter',()=>{
    if(curCursorFx==='dot'){document.getElementById('cursorDot')?.classList.add('visible');document.getElementById('cursorRing')?.classList.add('visible');}
});
document.addEventListener('mouseleave',()=>{
    document.getElementById('cursorDot')?.classList.remove('visible');document.getElementById('cursorRing')?.classList.remove('visible');
});
document.addEventListener('mouseover',e=>{
    const ring=document.getElementById('cursorRing');
    if(ring && (e.target.matches('a,button,.gi,.sc,.tp-chip,.tpl-card,.tp-opt,.preset-card,[contenteditable]')||e.target.closest('a,button,.gi,.sc,.tp-chip,.tpl-card,.tp-opt,.preset-card'))){
        ring.classList.add('hover');
    }
});
document.addEventListener('mouseout',e=>{
    const ring=document.getElementById('cursorRing');
    if(ring && (e.target.matches('a,button,.gi,.sc,.tp-chip,.tpl-card,.tp-opt,.preset-card,[contenteditable]')||e.target.closest('a,button,.gi,.sc,.tp-chip,.tpl-card,.tp-opt,.preset-card'))){
        ring.classList.remove('hover');
    }
});

// =============================================
// V2: AUDIO PLAYER
// =============================================
let audioData=null,audioName='';

function handleAudioUpload(e){
    const file=e.target.files[0];
    if(!file) return;
    audioName=file.name.replace(/\.[^.]+$/,'');
    const reader=new FileReader();
    reader.onload=ev=>{
        audioData=ev.target.result;
        const el=document.getElementById('audioEl');
        el.src=audioData;
        document.getElementById('audioTitle').textContent=audioName;
        document.getElementById('audioPlayer').classList.add('active');
        scheduleAutoSave();
    };
    reader.readAsDataURL(file);
}

function toggleAudio(){
    const el=document.getElementById('audioEl');
    const btn=document.getElementById('audioPlayBtn');
    if(el.paused){el.play();btn.textContent='❚❚';}
    else{el.pause();btn.textContent='▶';}
}

function seekAudio(e){
    const el=document.getElementById('audioEl');
    const bar=document.getElementById('audioProgress');
    const pct=e.offsetX/bar.offsetWidth;
    if(el.duration) el.currentTime=pct*el.duration;
}

function removeAudio(){
    const el=document.getElementById('audioEl');
    el.pause();el.src='';
    audioData=null;audioName='';
    document.getElementById('audioPlayer').classList.remove('active');
    document.getElementById('audioPlayBtn').textContent='▶';
    scheduleAutoSave();
}

// Audio progress update
setInterval(()=>{
    const el=document.getElementById('audioEl');
    const fill=document.getElementById('audioFill');
    if(el&&fill&&el.duration){
        fill.style.width=(el.currentTime/el.duration*100)+'%';
    }
    if(el&&el.ended){document.getElementById('audioPlayBtn').textContent='▶';}
},200);

// =============================================
// V2: PRESETS MÉTIER
// =============================================
const PRESETS=[
    {id:'artiste',n:'Artiste',icon:'🔮',th:6,tpl:0,bg:0,
     texts:{heroSub:'CREATIVE STUDIO',heroTitle:'FOLYO',heroTag:"BUILD DIFFERENT. STAND OUT.",heroDesc:"Un site à votre image en quelques minutes. Design premium, export clé en main. Pas de compromis — juste votre vision, amplifiée.",btnCta:'LANCER UN PROJET',btnSec:'DÉCOUVRIR LE TRAVAIL',portfolioTitle:'SELECTED WORK',colName:'Tous les projets',aboutTitle:"À PROPOS",aboutP1:'Studio créatif indépendant. On conçoit des identités qui marquent.',aboutP2:"Rigueur stratégique, exécution sans concession, allergie au générique.",stats:[{v:'120+',l:'PROJETS'},{v:'5',l:'ANS'},{v:'100%',l:'CLIENTS SATISFAITS'}],servicesTitle:'NOS SERVICES',services:[{i:'◉',n:'DIRECTION ARTISTIQUE',d:"Identité visuelle, charte graphique, guidelines.",p:'Sur mesure'},{i:'▲',n:'DESIGN & PRODUCTION',d:'Web design, supports print, motion. Du concept à la livraison.',p:'Sur devis'},{i:'⬡',n:'STRATÉGIE DIGITALE',d:'Positionnement, contenu, déploiement.',p:'Nous contacter'}],contactTitle:'PARLONS PROJET',footer:'© <span id="footerYear">2025</span> FOLYO — Tous droits réservés. Built different.'},
     socials:[{icon:'📷',label:'@VOTREPSEUDO',url:'https://instagram.com/'},{icon:'♪',label:'TIKTOK',url:'https://tiktok.com/'}]},
    {id:'ecommerce',n:'E-Commerce',icon:'🛒',th:24,tpl:1,bg:4,
     texts:{heroSub:'BOUTIQUE EN LIGNE',heroTitle:'VOTRE BOUTIQUE',heroTag:'SHOPPING SANS LIMITES',heroDesc:'Découvrez notre sélection de produits soigneusement choisis.',btnCta:'DÉCOUVRIR',btnSec:'BEST-SELLERS',portfolioTitle:'NOS PRODUITS',colName:'Catalogue',aboutTitle:'NOTRE HISTOIRE',aboutP1:'Née d\'une passion pour <strong>l\'excellence</strong>.',aboutP2:'Chaque article est choisi avec soin.',stats:[{v:'500+',l:'PRODUITS'},{v:'10K',l:'CLIENTS'},{v:'4.8★',l:'NOTE'}],servicesTitle:'NOS ENGAGEMENTS',services:[{i:'📦',n:'LIVRAISON EXPRESS',d:'Expédition sous 24h.',p:'Gratuit dès 50€'},{i:'🔄',n:'RETOURS FACILES',d:'30 jours pour changer d\'avis.',p:'Gratuit'},{i:'💎',n:'QUALITÉ GARANTIE',d:'Satisfaction ou remboursé.',p:'Garanti'}],contactTitle:'SERVICE CLIENT',footer:'© 2025 VOTRE BOUTIQUE'},
     socials:[{icon:'📷',label:'@BOUTIQUE',url:'https://instagram.com/'},{icon:'🛒',label:'SHOP',url:'#'}]},
    {id:'artisan',n:'Artisanat',icon:'🪵',th:15,tpl:8,bg:10,
     texts:{heroSub:'ARTISAN CRÉATEUR',heroTitle:"NOM DE L'ARTISAN",heroTag:'FAIT MAIN, FAIT CŒUR',heroDesc:'Chaque pièce est unique, façonnée à la main.',btnCta:'VOIR LES CRÉATIONS',btnSec:'SAVOIR-FAIRE',portfolioTitle:'MES CRÉATIONS',colName:'Pièces Uniques',aboutTitle:"L'ARTISAN",aboutP1:'Artisan passionné depuis <strong>10 ans</strong>.',aboutP2:"De l'atelier à vos mains.",stats:[{v:'200+',l:'CRÉATIONS'},{v:'10',l:'ANNÉES'},{v:'100%',l:'FAIT MAIN'}],servicesTitle:'SAVOIR-FAIRE',services:[{i:'✋',n:'SUR MESURE',d:'Création personnalisée.',p:'Sur devis'},{i:'🔧',n:'RESTAURATION',d:'Réparation de pièces anciennes.',p:'Dès 40€'},{i:'🎁',n:"PIÈCES D'EXCEPTION",d:'Collection signée et numérotée.',p:'Voir boutique'}],contactTitle:'COMMANDER',footer:"© 2025 NOM DE L'ARTISAN"},
     socials:[{icon:'📷',label:'@ARTISAN',url:'https://instagram.com/'},{icon:'🛒',label:'ETSY',url:'https://etsy.com/'}]},
    {id:'restaurant',n:'Restaurant',icon:'🍽️',th:11,tpl:4,bg:6,
     texts:{heroSub:'RESTAURANT & BAR',heroTitle:'NOM DU RESTAURANT',heroTag:'UNE EXPÉRIENCE CULINAIRE',heroDesc:'Cuisine raffinée, produits de saison.',btnCta:'RÉSERVER',btnSec:'LA CARTE',portfolioTitle:'NOS PLATS',colName:'La Carte',aboutTitle:'PHILOSOPHIE',aboutP1:'Notre cuisine célèbre les <strong>produits locaux</strong>.',aboutP2:'Laissez-vous porter par une expérience authentique.',stats:[{v:'45',l:'COUVERTS'},{v:'5',l:'ANNÉES'},{v:'4.9★',l:'AVIS'}],servicesTitle:'NOS SERVICES',services:[{i:'🍽️',n:'DÉJEUNER & DÎNER',d:'Cuisine de marché.',p:'Menu dès 28€'},{i:'🥂',n:'ÉVÉNEMENTS PRIVÉS',d:'Privatisation.',p:'Sur devis'},{i:'🛵',n:'CLICK & COLLECT',d:'Commandez à emporter.',p:'Carte complète'}],contactTitle:'RÉSERVATION',footer:'© 2025 NOM DU RESTAURANT'},
     socials:[{icon:'📷',label:'@RESTAURANT',url:'https://instagram.com/'},{icon:'📞',label:'APPELER',url:'tel:+33123456789'}]},
    {id:'festival',n:'Festival',icon:'🎪',th:10,tpl:7,bg:5,
     texts:{heroSub:'ÉDITION 2025',heroTitle:'NOM DU FESTIVAL',heroTag:'3 JOURS · 50 ARTISTES',heroDesc:'Musique, art et rencontres.',btnCta:'BILLETTERIE',btnSec:'PROGRAMMATION',portfolioTitle:'LINE-UP',colName:'Artistes 2025',aboutTitle:'LE FESTIVAL',aboutP1:'Depuis <strong>5 éditions</strong>.',aboutP2:'Trois jours hors du temps.',stats:[{v:'15K',l:'FESTIVALIERS'},{v:'50+',l:'ARTISTES'},{v:'3',l:'SCÈNES'}],servicesTitle:'INFOS PRATIQUES',services:[{i:'🎫',n:'BILLETTERIE',d:'Pass 1, 2 ou 3 jours.',p:'Dès 45€/jour'},{i:'⛺',n:'CAMPING',d:'Espace sur site.',p:'Dès 15€/nuit'},{i:'🍕',n:'FOOD & DRINKS',d:'Village food.',p:'Sur place'}],contactTitle:'CONTACT & PRESSE',footer:'© 2025 NOM DU FESTIVAL'},
     socials:[{icon:'📷',label:'@FESTIVAL',url:'https://instagram.com/'},{icon:'🎵',label:'SPOTIFY',url:'https://spotify.com/'}]},
    {id:'photo',n:'Photographe',icon:'📸',th:6,tpl:2,bg:2,
     texts:{heroSub:'PHOTOGRAPHE PROFESSIONNEL',heroTitle:'NOM DU PHOTOGRAPHE',heroTag:"CAPTURER L'INSTANT",heroDesc:'Chaque cliché raconte une histoire.',btnCta:'RÉSERVER UN SHOOTING',btnSec:'PORTFOLIO',portfolioTitle:'PORTFOLIO',colName:'Sélection',aboutTitle:"DERRIÈRE L'OBJECTIF",aboutP1:'Photographe depuis <strong>8 ans</strong>.',aboutP2:'Mon approche mêle spontanéité et direction artistique.',stats:[{v:'500+',l:'SHOOTINGS'},{v:'8',l:'ANNÉES'},{v:'50+',l:'CLIENTS'}],servicesTitle:'PRESTATIONS',services:[{i:'👤',n:'PORTRAIT & BOOK',d:'Shooting portrait.',p:'Dès 150€'},{i:'💍',n:'MARIAGE',d:'Reportage complet.',p:'Dès 800€'},{i:'🏢',n:'CORPORATE',d:'Photos pour entreprise.',p:'Sur devis'}],contactTitle:'PRENDRE RDV',footer:'© 2025 NOM DU PHOTOGRAPHE'},
     socials:[{icon:'📷',label:'@PHOTO',url:'https://instagram.com/'},{icon:'📸',label:'500PX',url:'https://500px.com/'}]},
    {id:'coach',n:'Coach',icon:'🎯',th:21,tpl:1,bg:1,
     texts:{heroSub:'COACH & CONSULTANT',heroTitle:'VOTRE NOM',heroTag:'LIBÉREZ VOTRE POTENTIEL',heroDesc:'Accompagnement personnalisé.',btnCta:'PRENDRE RDV',btnSec:'MES SERVICES',portfolioTitle:'TÉMOIGNAGES',colName:'Résultats Clients',aboutTitle:'QUI SUIS-JE',aboutP1:'Coach certifié, <strong>12 ans d\'expérience</strong>.',aboutP2:'Ma méthode combine écoute et outils concrets.',stats:[{v:'200+',l:'CLIENTS'},{v:'12',l:'ANNÉES'},{v:'98%',l:'SATISFACTION'}],servicesTitle:'ACCOMPAGNEMENT',services:[{i:'🎯',n:'COACHING INDIVIDUEL',d:'Séances 1:1.',p:'120€/séance'},{i:'👥',n:"COACHING D'ÉQUIPE",d:'Ateliers collectifs.',p:'Sur devis'},{i:'📊',n:'CONSEIL STRATÉGIQUE',d:'Audit et plan d\'action.',p:'Dès 500€'}],contactTitle:'ÉCHANGE GRATUIT',footer:'© 2025 VOTRE NOM — Coach certifié'},
     socials:[{icon:'💼',label:'LINKEDIN',url:'https://linkedin.com/'},{icon:'📷',label:'@COACH',url:'https://instagram.com/'}]},
    {id:'tattoo',n:'Tatoueur',icon:'🖋️',th:4,tpl:0,bg:7,
     texts:{heroSub:'TATOUEUR & BODY ART',heroTitle:"NOM DE L'ARTISTE",heroTag:"L'ENCRE SOUS LA PEAU",heroDesc:'Tatouages sur mesure.',btnCta:'PRENDRE RDV',btnSec:'RÉALISATIONS',portfolioTitle:'RÉALISATIONS',colName:'Flash & Custom',aboutTitle:"L'ARTISTE",aboutP1:'Spécialisé en <strong>blackwork, dotwork, fine line</strong>.',aboutP2:'Votre peau est ma toile.',stats:[{v:'1000+',l:'TATOUAGES'},{v:'7',l:'ANNÉES'},{v:'5★',l:'GOOGLE'}],servicesTitle:'PRESTATIONS',services:[{i:'🖋️',n:'TATOUAGE CUSTOM',d:'Design unique.',p:'Dès 80€'},{i:'⚡',n:'FLASH TATTOO',d:'Designs prêts à tatouer.',p:'Dès 50€'},{i:'🔄',n:'COVER-UP',d:'Recouvrement.',p:'Sur consultation'}],contactTitle:'PRENDRE RDV',footer:"© 2025 NOM DE L'ARTISTE"},
     socials:[{icon:'📷',label:'@TATOUEUR',url:'https://instagram.com/'},{icon:'📅',label:'RDV',url:'https://calendly.com/'}]}
];
let pendingPreset=-1;

function buildPresetGrid(){
    const g=document.getElementById('presetGrid');
    if(!g) return;
    PRESETS.forEach((p,i)=>{
        const c=document.createElement('div');
        c.className='preset-card';
        c.innerHTML=`<div class="preset-card-icon">${p.icon}</div><div class="preset-card-name">${p.n}</div>`;
        c.onclick=()=>openPresetConfirm(i);
        g.appendChild(c);
    });
}

function openPresetConfirm(i){
    pendingPreset=i;const p=PRESETS[i];
    document.getElementById('presetConfirmIcon').textContent=p.icon;
    document.getElementById('presetConfirmTitle').textContent=p.n.toUpperCase();
    document.getElementById('presetConfirmDesc').textContent='Transformer en site '+p.n.toLowerCase()+'.';
    document.getElementById('presetConfirmBg').classList.add('show');
}
function closePresetConfirm(){document.getElementById('presetConfirmBg').classList.remove('show');pendingPreset=-1;}
function confirmPresetApply(){
    if(pendingPreset<0) return;
    applyPreset(pendingPreset);closePresetConfirm();
    showSaveConfirm('✓ Preset appliqué',PRESETS[pendingPreset].n);
}

function applyPreset(i){
    const p=PRESETS[i],t=p.texts;
    applyTH(p.th);applyTPL(p.tpl);applyBG(p.bg);
    nuanceHue=0;nuanceSat=0;nuanceLum=0;nuanceCon=0;setNuanceFromValues();
    const qs=(s,v)=>{const el=document.querySelector(s);if(el)el.innerHTML=v;};
    qs('.h-sub .editable',t.heroSub);qs('.h-title.editable',t.heroTitle);
    qs('.h-tag.editable',t.heroTag);qs('.h-desc.editable',t.heroDesc);
    qs('.ba.editable',t.btnCta);qs('.bb.editable',t.btnSec);
    qs('#portfolio .st.editable',t.portfolioTitle);
    if(collections.length>0){collections[0].name=t.colName;renderColTabs();}
    qs('#about .st.editable',t.aboutTitle);
    const aboutPs=document.querySelectorAll('#about .at .editable');
    if(aboutPs[0])aboutPs[0].innerHTML=t.aboutP1;if(aboutPs[1])aboutPs[1].innerHTML=t.aboutP2;
    const statW=document.querySelectorAll('#about .a-stats > div');
    t.stats.forEach((s,j)=>{if(statW[j]){const n=statW[j].querySelector('.sn');const l=statW[j].querySelector('.slb');if(n)n.innerHTML=s.v;if(l)l.textContent=s.l;}});
    qs('#services .st.editable',t.servicesTitle);
    const sCards=document.querySelectorAll('#services .sc');
    t.services.forEach((s,j)=>{if(sCards[j]){const ic=sCards[j].querySelector('.si');const nm=sCards[j].querySelector('.snn');const ds=sCards[j].querySelector('.sd');const pr=sCards[j].querySelector('.stg');if(ic)ic.textContent=s.i;if(nm)nm.innerHTML=s.n;if(ds)ds.innerHTML=s.d;if(pr)pr.innerHTML=s.p;}});
    qs('#contact .st.editable',t.contactTitle);
    qs('footer .editable',t.footer);
    socLinks=p.socials.map(s=>({icon:s.icon,label:s.label,url:s.url}));renderSocPanel();
    if(!logoData){qs('#navLogo .editable',t.heroTitle);}
    scheduleAutoSave();
}



// =============================================
// V2: BACKGROUND IMAGE
// =============================================
let bgImgData=null, bgImgName='', bgImgMode='cover', bgImgOpacity=30, bgImgBrightness=100, bgImgBlur=0;

const BGIMG_MODES=[
    {id:'cover',n:'Cover',tip:'Image remplissant tout l\'écran, recadrée si besoin'},
    {id:'contain',n:'Contenir',tip:'Image entière visible, bords possibles'},
    {id:'fixed',n:'Fixe',tip:'Image fixe pendant que le contenu défile dessus'},
    {id:'scroll',n:'Scroll',tip:'Image qui défile avec la page'},
    {id:'parallax',n:'Parallaxe',tip:'Effet de profondeur au scroll'},
    {id:'tile',n:'Mosaïque',tip:'Image répétée en tuile (idéal pour textures)'}
];

function buildBgImgModeRow(){
    const r=document.getElementById('bgImgModeRow');
    if(!r) return;
    BGIMG_MODES.forEach(m=>{
        const c=document.createElement('button');
        c.className='tp-chip'+(m.id===bgImgMode?' active':'');
        c.textContent=m.n;
        c.title=m.tip;
        c.onclick=()=>setBgImgMode(m.id);
        r.appendChild(c);
    });
}

function handleBgImgUpload(e){
    const file=e.target.files[0];
    if(!file) return;
    bgImgName=file.name;
    const reader=new FileReader();
    reader.onload=ev=>{
        bgImgData=ev.target.result;
        applyBgImg();
        // Show preview
        document.getElementById('bgImgThumb').src=bgImgData;
        document.getElementById('bgImgName').textContent=bgImgName;
        document.getElementById('bgImgPreview').classList.add('active');
        document.getElementById('bgImgZone').style.display='none';
        document.getElementById('bgImgControls').classList.add('active');
        scheduleAutoSave();
    };
    reader.readAsDataURL(file);
}

function applyBgImg(){
    const layer=document.getElementById('bgImgLayer');
    const img=document.getElementById('bgImgEl');
    if(!bgImgData){
        layer.classList.remove('active');
        return;
    }
    // Set image
    if(bgImgMode==='tile'){
        img.style.display='none';
        layer.style.backgroundImage=`url(${bgImgData})`;
        layer.style.backgroundRepeat='repeat';
        layer.style.backgroundSize='auto';
    } else {
        img.style.display='';
        img.src=bgImgData;
        layer.style.backgroundImage='';
        layer.style.backgroundRepeat='';
        layer.style.backgroundSize='';
    }
    // Apply mode classes
    layer.className='active';
    layer.id='bgImgLayer';
    layer.classList.add('bgimg-'+bgImgMode);
    if(bgImgMode==='cover' || bgImgMode==='fixed' || bgImgMode==='parallax') layer.classList.add('bgimg-cover');
    // Apply opacity + filters
    layer.style.opacity=bgImgOpacity/100;
    const filters=[];
    if(bgImgBrightness!==100) filters.push(`brightness(${bgImgBrightness/100})`);
    if(bgImgBlur>0) filters.push(`blur(${bgImgBlur}px)`);
    layer.style.filter=filters.length?filters.join(' '):'';
}

function setBgImgMode(id){
    bgImgMode=id;
    document.querySelectorAll('#bgImgModeRow .tp-chip').forEach(c=>{
        c.classList.toggle('active',c.textContent===BGIMG_MODES.find(m=>m.id===id)?.n);
    });
    applyBgImg();
    scheduleAutoSave();
}

function setBgImgOpacity(v){
    bgImgOpacity=parseInt(v);
    document.getElementById('bgImgOpVal').textContent=v+'%';
    const layer=document.getElementById('bgImgLayer');
    layer.style.opacity=bgImgOpacity/100;
    scheduleAutoSave();
}

function setBgImgBrightness(v){
    bgImgBrightness=parseInt(v);
    document.getElementById('bgImgBrVal').textContent=v+'%';
    applyBgImg();
    scheduleAutoSave();
}

function setBgImgBlur(v){
    bgImgBlur=parseInt(v);
    document.getElementById('bgImgBlVal').textContent=v+'px';
    applyBgImg();
    scheduleAutoSave();
}

function removeBgImg(){
    bgImgData=null; bgImgName='';
    const layer=document.getElementById('bgImgLayer');
    layer.classList.remove('active');
    layer.className=''; layer.id='bgImgLayer';
    layer.style.opacity=''; layer.style.filter='';
    layer.style.backgroundImage=''; layer.style.backgroundRepeat=''; layer.style.backgroundSize='';
    document.getElementById('bgImgEl').src='';
    document.getElementById('bgImgPreview').classList.remove('active');
    document.getElementById('bgImgZone').style.display='';
    document.getElementById('bgImgControls').classList.remove('active');
    scheduleAutoSave();
}

// Parallax scroll handler
let parallaxRaf=null;
window.addEventListener('scroll',()=>{
    if(bgImgMode!=='parallax'||!bgImgData) return;
    if(parallaxRaf) return;
    parallaxRaf=requestAnimationFrame(()=>{
        const y=window.scrollY*0.3;
        const img=document.getElementById('bgImgEl');
        if(img) img.style.transform=`scale(1.15) translateY(${-y}px)`;
        parallaxRaf=null;
    });
});


// =============================================
// V2d: COLLECTION COVERS
// =============================================
function handleCoverUpload(e, colIdx){
    const file = e.target.files[0]; if(!file) return;
    const r = new FileReader();
    r.onload = ev => {
        collections[colIdx].cover = ev.target.result;
        renderColTabs(); renderColContent(); scheduleAutoSave();
    };
    r.readAsDataURL(file);
}
function removeCover(colIdx){
    collections[colIdx].cover = null;
    renderColTabs(); renderColContent(); scheduleAutoSave();
}

// =============================================
// V2d: PREVIEW MODE
// =============================================
let isPreview = false;
function enterPreview(){
    isPreview = true;
    document.body.classList.add('preview-mode');
    // Disable contenteditable
    document.querySelectorAll('[contenteditable]').forEach(el => {
        el.setAttribute('contenteditable','false');
    });
    // If multiple collections, show cover cards view
    if(collections.length > 1){
        showCoverCardsView();
    }
    window.scrollTo({top:0, behavior:'smooth'});
}
function exitPreview(){
    isPreview = false;
    document.body.classList.remove('preview-mode');
    document.querySelectorAll('.editable').forEach(el => {
        el.setAttribute('contenteditable','true');
    });
    // Restore editor gallery view
    renderColTabs(); renderColContent();
}

function showCoverCardsView(){
    const wrap = document.getElementById('colContent');
    const tabs = document.getElementById('colTabs');
    if(tabs) tabs.style.display='none';
    let html = '<div class="col-covers">';
    collections.forEach((col, ci) => {
        const count = col.images.filter(Boolean).length;
        const coverSrc = col.cover || col.images.find(Boolean) || '';
        html += `<div class="col-cover-card" onclick="openCoverCollection(${ci})">`;
        if(coverSrc){
            html += `<img src="${coverSrc}" alt="${escH(col.name)}">`;
        } else {
            html += `<div class="col-cover-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>`;
        }
        html += `<div class="col-cover-info"><div class="col-cover-name">${escH(col.name)}</div><div class="col-cover-count">${count} œuvre${count!==1?'s':''}</div></div>`;
        html += `</div>`;
    });
    html += '</div>';
    wrap.innerHTML = html;
}

function openCoverCollection(ci){
    const wrap = document.getElementById('colContent');
    const col = collections[ci];
    const imgs = col.images.filter(Boolean);
    let html = `<button class="col-back-btn" onclick="showCoverCardsView()">← Retour aux collections</button>`;
    if(col.desc) html += `<p class="col-desc">${col.desc}</p>`;
    html += `<div class="gal" style="grid-template-columns:repeat(${col.gridCols},1fr);">`;
    imgs.forEach((img,i) => {
        html += `<div class="gi gi-has-img"><img src="${img}" alt="Œuvre ${i+1}"></div>`;
    });
    html += '</div>';
    wrap.innerHTML = html;
    // Wire lightbox
    wrap.querySelectorAll('.gi').forEach(gi => {
        gi.onclick = () => {
            const src = gi.querySelector('img')?.src;
            if(src){ document.getElementById('lbi').src = src; document.getElementById('lb').classList.add('show'); }
        };
    });
}

// =============================================
// V2d: EXTRA CUSTOMIZATION
// =============================================
let v2CardStyle='default', v2NavStyle='default', v2Spacing='default', v2GalGap='default';
let v2HeroSize=100, v2HeroSpacing=5, v2ScrollTop=false;

const CARD_STYLES=[
    {id:'default',n:'Par défaut',tip:'Coins du template actuel'},
    {id:'sharp',n:'Angulaire',tip:'Coins droits, aucun arrondi'},
    {id:'round',n:'Arrondis',tip:'Coins arrondis 8px'},
    {id:'pill',n:'Pilule',tip:'Coins très arrondis 20px'}
];
const NAV_STYLES=[
    {id:'default',n:'Flou',tip:'Fond flouté semi-transparent'},
    {id:'solid',n:'Solide',tip:'Fond opaque de la couleur bg2'},
    {id:'minimal',n:'Invisible',tip:'Navigation transparente'},
    {id:'hidden',n:'Cachée',tip:'Pas de barre de navigation'}
];
const SPACING_OPTS=[
    {id:'compact',n:'Compact',tip:'Sections rapprochées (3rem)'},
    {id:'default',n:'Normal',tip:'Espacement standard (5rem)'},
    {id:'wide',n:'Aéré',tip:'Beaucoup d\'espace (7rem)'}
];
const GALGAP_OPTS=[
    {id:'none',n:'0',tip:'Images collées'},
    {id:'small',n:'Fin',tip:'2px entre les images'},
    {id:'default',n:'Normal',tip:'4px standard'},
    {id:'medium',n:'Moyen',tip:'8px entre les images'},
    {id:'large',n:'Large',tip:'16px entre les images'}
];

function buildExtraControls(){
    buildChipRow('cardStyleRow', CARD_STYLES, v2CardStyle, setCardStyle);
    buildChipRow('navStyleRow', NAV_STYLES, v2NavStyle, setNavStyle);
    buildChipRow('spacingRow', SPACING_OPTS, v2Spacing, setSpacing);
    buildChipRow('galGapRow', GALGAP_OPTS, v2GalGap, setGalGap);
    document.getElementById('scrollTopToggle')?.classList.toggle('active', v2ScrollTop);
}

function buildChipRow(rowId, opts, current, setter){
    const r = document.getElementById(rowId);
    if(!r) return;
    r.innerHTML = '';
    opts.forEach(o => {
        const c = document.createElement('button');
        c.className = 'tp-chip' + (o.id===current?' active':'');
        c.textContent = o.n;
        c.title = o.tip;
        c.onclick = () => setter(o.id);
        r.appendChild(c);
    });
}

function setCardStyle(id){
    v2CardStyle = id;
    document.body.classList.remove('cards-sharp','cards-round','cards-pill');
    if(id!=='default') document.body.classList.add('cards-'+id);
    buildChipRow('cardStyleRow', CARD_STYLES, v2CardStyle, setCardStyle);
    scheduleAutoSave();
}
function setNavStyle(id){
    v2NavStyle = id;
    document.body.classList.remove('nav-solid','nav-hidden','nav-minimal');
    if(id!=='default') document.body.classList.add('nav-'+id);
    buildChipRow('navStyleRow', NAV_STYLES, v2NavStyle, setNavStyle);
    scheduleAutoSave();
}
function setSpacing(id){
    v2Spacing = id;
    document.body.classList.remove('spacing-compact','spacing-wide');
    if(id!=='default') document.body.classList.add('spacing-'+id);
    buildChipRow('spacingRow', SPACING_OPTS, v2Spacing, setSpacing);
    scheduleAutoSave();
}
function setGalGap(id){
    v2GalGap = id;
    document.body.classList.remove('galgap-none','galgap-small','galgap-medium','galgap-large');
    if(id!=='default') document.body.classList.add('galgap-'+id);
    buildChipRow('galGapRow', GALGAP_OPTS, v2GalGap, setGalGap);
    scheduleAutoSave();
}
function setHeroSize(v){
    v2HeroSize = parseInt(v);
    document.getElementById('heroSizeVal').textContent = v+'%';
    const hero = document.querySelector('.hn');
    if(hero) hero.style.fontSize = `calc(clamp(2rem, 8vw, 4.5rem) * ${v/100})`;
    scheduleAutoSave();
}
function setHeroSpacing(v){
    v2HeroSpacing = parseInt(v);
    document.getElementById('heroSpacingVal').textContent = v+'px';
    const hero = document.querySelector('.hn');
    if(hero) hero.style.letterSpacing = v+'px';
    scheduleAutoSave();
}
function toggleScrollTop(){
    v2ScrollTop = !v2ScrollTop;
    document.getElementById('scrollTopToggle')?.classList.toggle('active', v2ScrollTop);
    scheduleAutoSave();
}

// Scroll-to-top visibility
window.addEventListener('scroll', () => {
    const btn = document.getElementById('scrollTopBtn');
    if(btn) btn.classList.toggle('visible', v2ScrollTop && window.scrollY > 400);
});

// =============================================
// QUICK LINKS
// =============================================
let quickLinks = [];

function renderQuickLinksPanel(){
    const list = document.getElementById('qlinkList');
    if(!list) return;
    if(quickLinks.length === 0){
        list.innerHTML = '<div class="qlink-empty">Aucun lien — cliquez + pour ajouter</div>';
    } else {
        list.innerHTML = '';
        quickLinks.forEach((link, i) => {
            const item = document.createElement('div');
            item.className = 'qlink-item';
            item.innerHTML = `
                <button class="soc-icon-pick" data-qi="${i}" onclick="openSocPickerForQlink(${i})">${link.icon||'🔗'}</button>
                <div class="qlink-fields">
                    <input class="qlink-field" value="${escH(link.label)}" placeholder="Libellé du bouton" data-i="${i}" data-f="label">
                    <input class="qlink-field qlink-field-url" value="${escH(link.url)}" placeholder="https://..." data-i="${i}" data-f="url">
                </div>
                <button class="qlink-del" onclick="removeQuickLink(${i})" title="Supprimer">✕</button>`;
            item.querySelectorAll('.qlink-field').forEach(inp => {
                inp.addEventListener('input', function(){
                    quickLinks[parseInt(this.dataset.i)][this.dataset.f] = this.value;
                    renderQuickLinksBar();
                    scheduleAutoSave();
                });
            });
            list.appendChild(item);
        });
    }
    renderQuickLinksBar();
}

function renderQuickLinksBar(){
    const bar = document.getElementById('quickLinksBar');
    if(!bar) return;
    bar.innerHTML = '';
    quickLinks.forEach(link => {
        if(!link.label && !link.url) return;
        const a = document.createElement('a');
        a.href = link.url || '#';
        a.className = 'quick-link-btn';
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = (link.icon ? link.icon + ' ' : '') + (link.label || 'Lien');
        bar.appendChild(a);
    });
}

function addQuickLink(){
    quickLinks.push({ icon: '🔗', label: '', url: '' });
    renderQuickLinksPanel();
    scheduleAutoSave();
}

function removeQuickLink(i){
    quickLinks.splice(i, 1);
    renderQuickLinksPanel();
    scheduleAutoSave();
}

function openSocPickerForQlink(i){
    qlinkPickerTarget = i;
    const grid = document.getElementById('socPickerGrid');
    grid.innerHTML = '';
    SOC_ICONS.forEach(icon => {
        const el = document.createElement('div');
        el.className = 'soc-picker-item';
        el.textContent = icon;
        el.onclick = () => {
            if(qlinkPickerTarget >= 0){
                quickLinks[qlinkPickerTarget].icon = icon;
                qlinkPickerTarget = -1;
                renderQuickLinksPanel();
                scheduleAutoSave();
                closeSocPicker();
            } else {
                pickSocIcon(icon);
            }
        };
        grid.appendChild(el);
    });
    document.getElementById('socPickerCustom').value = '';
    document.getElementById('socPickerBg').classList.add('show');
}

// =============================================
// SERVICE BLOCKS MANAGEMENT
// =============================================
let serviceBlocks = [];

function syncServiceBlocksFromDOM(){
    serviceBlocks = [];
    document.querySelectorAll('#services .sc').forEach(sc => {
        const stg = sc.querySelector('.stg');
        const link = stg?.closest('a.stg-link');
        serviceBlocks.push({
            icon: sc.querySelector('.si')?.textContent || '✦',
            name: sc.querySelector('.snn')?.innerHTML || '',
            desc: sc.querySelector('.sd')?.innerHTML || '',
            price: stg?.innerHTML || '',
            url: link?.getAttribute('href') || sc.dataset.svcUrl || ''
        });
    });
}

function renderServiceBlocksDOM(){
    const sg = document.querySelector('#services .sg');
    if(!sg) return;
    sg.innerHTML = '';
    serviceBlocks.forEach((svc, i) => {
        const card = document.createElement('div');
        card.className = 'sc';
        card.dataset.anim = 'fade';
        card.dataset.svcUrl = svc.url || '';
        let tagHTML;
        if(svc.url){
            tagHTML = `<a href="${escH(svc.url)}" class="stg-link" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;"><span class="stg editable" contenteditable="true">${svc.price}</span></a>`;
        } else {
            tagHTML = `<span class="stg editable" contenteditable="true">${svc.price}</span>`;
        }
        card.innerHTML = `
            <div class="si">${svc.icon}</div>
            <div class="snn editable" contenteditable="true">${svc.name}</div>
            <div class="sd editable" contenteditable="true">${svc.desc}</div>
            ${tagHTML}`;
        sg.appendChild(card);
    });
    // Re-wire editables for blur sync only (no DOM rebuild on blur)
    sg.querySelectorAll('.editable').forEach(el => {
        el.addEventListener('blur', () => {
            syncServiceBlocksFromDOM();
            scheduleAutoSave();
        });
    });
}

function renderServicePanel(){
    const list = document.getElementById('svcList');
    if(!list) return;
    if(serviceBlocks.length === 0){
        list.innerHTML = '<div class="svc-empty">Aucun service — cliquez + pour ajouter</div>';
        return;
    }
    list.innerHTML = '';
    serviceBlocks.forEach((svc, i) => {
        const item = document.createElement('div');
        item.className = 'svc-item';
        const plainName = (svc.name||'Sans nom').replace(/<[^>]*>/g,'');
        item.innerHTML = `
            <button class="svc-icon-pick" onclick="openSvcIconPicker(${i})">${svc.icon}</button>
            <div class="svc-fields">
                <input class="svc-field" value="${escH(plainName)}" placeholder="Nom du service" data-i="${i}" data-f="name">
                <input class="svc-field svc-field-desc" value="${escH((svc.desc||'').replace(/<[^>]*>/g,''))}" placeholder="Description..." data-i="${i}" data-f="desc">
                <input class="svc-field svc-field-price" value="${escH((svc.price||'').replace(/<[^>]*>/g,''))}" placeholder="Prix / bouton..." data-i="${i}" data-f="price">
                <input class="svc-field svc-field-url" value="${escH(svc.url||'')}" placeholder="🔗 URL du bouton (optionnel)" data-i="${i}" data-f="url" style="font-size:0.4rem;color:var(--dim);letter-spacing:0.02em;">
            </div>
            <div class="svc-btns">
                ${i > 0 ? `<button class="svc-mini-btn" onclick="moveServiceBlock(${i},-1)" title="Monter">↑</button>` : '<span style="width:14px;height:14px;display:block;"></span>'}
                ${i < serviceBlocks.length-1 ? `<button class="svc-mini-btn" onclick="moveServiceBlock(${i},1)" title="Descendre">↓</button>` : '<span style="width:14px;height:14px;display:block;"></span>'}
                <button class="svc-mini-btn del" onclick="removeServiceBlock(${i})" title="Supprimer">✕</button>
            </div>`;
        item.querySelectorAll('.svc-field').forEach(inp => {
            const evType = inp.dataset.f === 'url' ? 'change' : 'input';
            inp.addEventListener(evType, function(){
                const idx = parseInt(this.dataset.i);
                const f = this.dataset.f;
                if(serviceBlocks[idx]){
                    serviceBlocks[idx][f] = this.value;
                    if(f==='url'){
                        // Rebuild DOM to add/remove link wrapper
                        renderServiceBlocksDOM();
                        renderServicePanel();
                    } else {
                        // Update DOM in-place without full rebuild
                        const cards = document.querySelectorAll('#services .sc');
                        const card = cards[idx];
                        if(card){
                            if(f==='name'){ const el=card.querySelector('.snn'); if(el) el.innerHTML=this.value; }
                            else if(f==='desc'){ const el=card.querySelector('.sd'); if(el) el.innerHTML=this.value; }
                            else if(f==='price'){ const el=card.querySelector('.stg'); if(el) el.innerHTML=this.value; }
                        }
                    }
                    scheduleAutoSave();
                }
            });
        });
        list.appendChild(item);
    });
}

function addServiceBlock(){
    serviceBlocks.push({ icon: '✦', name: 'NOUVEAU SERVICE', desc: 'Description du service.', price: 'Sur devis', url: '' });
    renderServiceBlocksDOM();
    renderServicePanel();
    scheduleAutoSave();
}

function removeServiceBlock(i){
    if(!confirm('Supprimer ce service ?')) return;
    serviceBlocks.splice(i, 1);
    renderServiceBlocksDOM();
    renderServicePanel();
    scheduleAutoSave();
}

function moveServiceBlock(i, dir){
    const j = i + dir;
    if(j < 0 || j >= serviceBlocks.length) return;
    [serviceBlocks[i], serviceBlocks[j]] = [serviceBlocks[j], serviceBlocks[i]];
    renderServiceBlocksDOM();
    renderServicePanel();
    scheduleAutoSave();
}

function openSvcIconPicker(i){
    svcIconPickerTarget = i;
    const grid = document.getElementById('socPickerGrid');
    grid.innerHTML = '';
    SOC_ICONS.forEach(icon => {
        const el = document.createElement('div');
        el.className = 'soc-picker-item';
        el.textContent = icon;
        el.onclick = () => {
            if(svcIconPickerTarget >= 0){
                serviceBlocks[svcIconPickerTarget].icon = icon;
                svcIconPickerTarget = -1;
                renderServiceBlocksDOM();
                renderServicePanel();
                scheduleAutoSave();
                closeSocPicker();
            } else {
                pickSocIcon(icon);
            }
        };
        grid.appendChild(el);
    });
    document.getElementById('socPickerCustom').value = '';
    document.getElementById('socPickerBg').classList.add('show');
}

// =============================================
// ADVANCED COLORS
// =============================================
let advColors = {};
const ADV_COLOR_KEYS = ['bg','bg2','bg3','text','dim','bright','accent','border'];
const ADV_MAP = {bg:'Bg',bg2:'Bg2',bg3:'Bg3',text:'Text',dim:'Dim',bright:'Bright',accent:'Accent',border:'Border'};

function setAdvColor(key, val){
    advColors[key] = val;
    document.documentElement.style.setProperty('--'+key, val);
    const picker = document.getElementById('advCol'+ADV_MAP[key]);
    const hex = document.getElementById('advCol'+ADV_MAP[key]+'Hex');
    if(picker) picker.value = val;
    if(hex) hex.value = val;
    scheduleAutoSave();
}

function setAdvColorHex(key, val){
    if(/^#[0-9a-fA-F]{6}$/.test(val)){
        setAdvColor(key, val);
    }
}

function resetAdvColor(key){
    delete advColors[key];
    const t = TH[cTH];
    if(t && t[key]) document.documentElement.style.setProperty('--'+key, t[key]);
    syncAdvColorUI();
    // Load new features
    if(s.seoTitle !== undefined) loadSEO(s);
    if(s.sectionOrder) loadSectionOrder(s);
    scheduleAutoSave();
}

function resetAllAdvColors(){
    advColors = {};
    const t = TH[cTH];
    ADV_COLOR_KEYS.forEach(k => {
        if(t && t[k]) document.documentElement.style.setProperty('--'+k, t[k]);
    });
    syncAdvColorUI();
    // Load new features
    if(s.seoTitle !== undefined) loadSEO(s);
    if(s.sectionOrder) loadSectionOrder(s);
    scheduleAutoSave();
}

function syncAdvColorUI(){
    ADV_COLOR_KEYS.forEach(k => {
        const mKey = ADV_MAP[k];
        if(!mKey) return;
        const picker = document.getElementById('advCol'+mKey);
        const hex = document.getElementById('advCol'+mKey+'Hex');
        const val = advColors[k] || getComputedStyle(document.documentElement).getPropertyValue('--'+k).trim();
        if(picker && val) picker.value = val;
        if(hex && val) hex.value = val;
    });
}

// =============================================
// ADVANCED TYPOGRAPHY
// =============================================
let typoBody = '', typoHead = '', typoSize = 100, typoLine = 170;

function setTypoBody(val){
    typoBody = val;
    if(val){
        document.body.style.fontFamily = val;
        document.querySelectorAll('.cd, .at p, .csb-desc, .sd').forEach(el => el.style.fontFamily = val);
    } else {
        document.body.style.fontFamily = '';
        document.querySelectorAll('.cd, .at p, .csb-desc, .sd').forEach(el => el.style.fontFamily = '');
    }
    scheduleAutoSave();
}

function setTypoHead(val){
    typoHead = val;
    const els = document.querySelectorAll('.hn, .st, .snn, .csb-title, nav .n-logo span');
    if(val){
        els.forEach(el => el.style.fontFamily = val);
    } else {
        els.forEach(el => el.style.fontFamily = '');
    }
    scheduleAutoSave();
}

function setTypoSize(val){
    typoSize = parseInt(val);
    document.getElementById('typoSizeVal').textContent = val + '%';
    document.body.style.fontSize = (typoSize/100) + 'rem';
    scheduleAutoSave();
}

function setTypoLine(val){
    typoLine = parseInt(val);
    document.getElementById('typoLineVal').textContent = (val/100).toFixed(1);
    document.body.style.lineHeight = (val/100).toFixed(2);
    scheduleAutoSave();
}

// =============================================
// UNDO / REDO
// =============================================
const undoStack = [];
const redoStack = [];
const MAX_UNDO = 30;
let undoTimer = null;
let lastUndoSnapshot = '';

function takeSnapshot(){
    const state = JSON.stringify(gatherState());
    if(state === lastUndoSnapshot) return; // no change
    undoStack.push(lastUndoSnapshot);
    if(undoStack.length > MAX_UNDO) undoStack.shift();
    redoStack.length = 0;
    lastUndoSnapshot = state;
    updateUndoButtons();
}

function scheduleSnapshot(){
    if(undoTimer) clearTimeout(undoTimer);
    undoTimer = setTimeout(takeSnapshot, 2000);
}

function undo(){
    if(undoStack.length === 0) return;
    redoStack.push(lastUndoSnapshot);
    lastUndoSnapshot = undoStack.pop();
    applySnapshot(lastUndoSnapshot);
    updateUndoButtons();
    showSaveConfirm('↩ Annulé','');
}

function redo(){
    if(redoStack.length === 0) return;
    undoStack.push(lastUndoSnapshot);
    lastUndoSnapshot = redoStack.pop();
    applySnapshot(lastUndoSnapshot);
    updateUndoButtons();
    showSaveConfirm('↪ Rétabli','');
}

function applySnapshot(json){
    try {
        const s = JSON.parse(json);
        // Store temporarily and reload
        localStorage.setItem(SAVE_KEY, json);
        // Re-apply without full page reload
        loadState();
        scheduleAutoSave();
    } catch(e){ console.warn('Undo error', e); }
}

function updateUndoButtons(){
    const u = document.getElementById('undoBtn');
    const r = document.getElementById('redoBtn');
    if(u) u.disabled = undoStack.length === 0;
    if(r) r.disabled = redoStack.length === 0;
}

// =============================================
// ABOUT PANEL EDITOR
// =============================================
function syncAboutPanelFromDOM(){
    const title = document.querySelector('#about .st.editable');
    const p1 = document.querySelectorAll('#about .at .editable')[0];
    const p2 = document.querySelectorAll('#about .at .editable')[1];
    const titleInput = document.getElementById('aboutCfgTitle');
    const p1Input = document.getElementById('aboutCfgP1');
    const p2Input = document.getElementById('aboutCfgP2');
    if(titleInput && title) titleInput.value = title.textContent;
    if(p1Input && p1) p1Input.value = p1.textContent;
    if(p2Input && p2) p2Input.value = p2.textContent;
    // Stats
    const statsList = document.getElementById('aboutStatsList');
    if(!statsList) return;
    statsList.innerHTML = '';
    document.querySelectorAll('#about .a-stats > div').forEach((statDiv, i) => {
        const val = statDiv.querySelector('.sn');
        const lbl = statDiv.querySelector('.slb');
        const row = document.createElement('div');
        row.className = 'about-stat-row';
        row.innerHTML = `
            <input class="about-stat-field" value="${escH(val?.textContent||'')}" placeholder="Valeur" data-si="${i}" data-sf="val">
            <input class="about-stat-field" value="${escH(lbl?.textContent||'')}" placeholder="Label" data-si="${i}" data-sf="lbl">`;
        row.querySelectorAll('.about-stat-field').forEach(inp => {
            inp.addEventListener('input', function(){
                const idx = parseInt(this.dataset.si);
                const field = this.dataset.sf;
                const statDivs = document.querySelectorAll('#about .a-stats > div');
                if(statDivs[idx]){
                    if(field==='val'){ const el = statDivs[idx].querySelector('.sn'); if(el) el.textContent = this.value; }
                    if(field==='lbl'){ const el = statDivs[idx].querySelector('.slb'); if(el) el.textContent = this.value; }
                }
                scheduleAutoSave();
            });
        });
        statsList.appendChild(row);
    });
}

function syncAboutFromPanel(){
    const title = document.querySelector('#about .st.editable');
    const p1 = document.querySelectorAll('#about .at .editable')[0];
    const p2 = document.querySelectorAll('#about .at .editable')[1];
    const titleVal = document.getElementById('aboutCfgTitle')?.value || '';
    const p1Val = document.getElementById('aboutCfgP1')?.value || '';
    const p2Val = document.getElementById('aboutCfgP2')?.value || '';
    if(title) title.textContent = titleVal;
    if(p1) p1.textContent = p1Val;
    if(p2) p2.textContent = p2Val;
    scheduleAutoSave();
}


// =============================================
// FEATURE: ONBOARDING
// =============================================
function showOnboard(){
    const el = document.getElementById('onboardBg');
    if(el) el.style.display = 'flex';
}
function closeOnboard(){
    const el = document.getElementById('onboardBg');
    if(el) el.style.display = 'none';
    try { localStorage.setItem('folyo-onboard-done','1'); } catch(e){}
}
function checkOnboard(){
    try {
        if(!localStorage.getItem('folyo-onboard-done') && !localStorage.getItem(SAVE_KEY)){
            showOnboard();
        }
    } catch(e){}
}

// =============================================
// FEATURE: DYNAMIC FOOTER YEAR
// =============================================
function updateFooterYear(){
    const el = document.getElementById('footerYear');
    if(el) el.textContent = new Date().getFullYear();
}

// =============================================
// FEATURE: SEO PANEL
// =============================================
let seoTitle = '', seoDesc = '', seoUrl = '', seoOgImage = '';

function updateSEO(){
    seoTitle = document.getElementById('seoTitle')?.value || '';
    seoDesc = document.getElementById('seoDesc')?.value || '';
    seoUrl = document.getElementById('seoUrl')?.value || '';
    seoOgImage = document.getElementById('seoOgImage')?.value || '';
    // Update live meta
    document.title = seoTitle || 'FOLYO — L\'Encre Prend Vie';
    let metaDesc = document.querySelector('meta[name="description"]');
    if(!metaDesc){ metaDesc = document.createElement('meta'); metaDesc.name='description'; document.head.appendChild(metaDesc); }
    metaDesc.content = seoDesc;
    // Update preview
    const pt = document.getElementById('seoPreviewTitle');
    const pu = document.getElementById('seoPreviewUrl');
    const pd = document.getElementById('seoPreviewDesc');
    if(pt) pt.textContent = seoTitle || 'Titre du site';
    if(pu) pu.textContent = seoUrl ? seoUrl.replace(/^https?:\/\//, '') : 'votresite.com';
    if(pd) pd.textContent = seoDesc || 'Description du site...';
    scheduleAutoSave();
}

function loadSEO(state){
    if(state.seoTitle !== undefined){
        seoTitle = state.seoTitle || '';
        seoDesc = state.seoDesc || '';
        seoUrl = state.seoUrl || '';
        seoOgImage = state.seoOgImage || '';
        const t = document.getElementById('seoTitle');
        const d = document.getElementById('seoDesc');
        const u = document.getElementById('seoUrl');
        const o = document.getElementById('seoOgImage');
        if(t) t.value = seoTitle;
        if(d) d.value = seoDesc;
        if(u) u.value = seoUrl;
        if(o) o.value = seoOgImage;
        updateSEO();
    }
}

function bakeSEO(clone){
    const head = clone.querySelector('head');
    if(!head) return;
    // Title
    const title = clone.querySelector('title');
    if(title && seoTitle) title.textContent = seoTitle;
    // Meta description
    let md = clone.querySelector('meta[name="description"]');
    if(!md && seoDesc){ md = document.createElement('meta'); md.setAttribute('name','description'); head.appendChild(md); }
    if(md && seoDesc) md.setAttribute('content', seoDesc);
    // OG tags
    const ogTags = {
        'og:title': seoTitle,
        'og:description': seoDesc,
        'og:image': seoOgImage,
        'og:url': seoUrl,
        'og:type': 'website'
    };
    for(const [prop, val] of Object.entries(ogTags)){
        if(!val) continue;
        let tag = clone.querySelector(`meta[property="${prop}"]`);
        if(!tag){ tag = document.createElement('meta'); tag.setAttribute('property', prop); head.appendChild(tag); }
        tag.setAttribute('content', val);
    }
    // Twitter card
    let tw = clone.querySelector('meta[name="twitter:card"]');
    if(!tw && seoOgImage){ tw = document.createElement('meta'); tw.setAttribute('name','twitter:card'); head.appendChild(tw); }
    if(tw) tw.setAttribute('content', 'summary_large_image');
}

// =============================================
// FEATURE: EXPORT / IMPORT JSON
// =============================================
function exportJSON(){
    const state = gatherState();
    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'folyo-backup-' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
    showSaveConfirm('↓ JSON exporté', (json.length/1024).toFixed(0) + ' Ko');
}

function importJSON(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
        try {
            const state = JSON.parse(ev.target.result);
            if(!state.v || !state.editables){
                showSaveConfirm('⚠ Fichier invalide', 'Ce n\'est pas un backup Folyo');
                return;
            }
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
            loadState();
            syncAboutPanelFromDOM();
            loadSEO(state);
            loadSectionOrder(state);
            showSaveConfirm('✓ Données importées', 'Rechargement...');
            setTimeout(() => location.reload(), 800);
        } catch(err){
            showSaveConfirm('⚠ Erreur import', err.message);
        }
    };
    reader.readAsText(file);
    e.target.value = '';
}

// =============================================
// FEATURE: SECTION REORDER
// =============================================
const MAIN_SECTIONS = [
    { id: 'hero', label: 'Accueil (Hero)' },
    { id: 'portfolio', label: 'Portfolio' },
    { id: 'about', label: 'À propos' },
    { id: 'services', label: 'Services' },
    { id: 'customSectionsArea', label: 'Sections custom' },
    { id: 'contact', label: 'Contact' }
];
let sectionOrder = MAIN_SECTIONS.map(s => s.id);

function renderSectionReorder(){
    const list = document.getElementById('sectionReorderList');
    if(!list) return;
    list.innerHTML = '';
    sectionOrder.forEach((secId, idx) => {
        const info = MAIN_SECTIONS.find(s => s.id === secId);
        if(!info) return;
        const item = document.createElement('div');
        item.className = 'section-reorder-item';
        item.draggable = true;
        item.dataset.idx = idx;
        item.innerHTML = `
            <span class="section-reorder-handle">⠿</span>
            <span class="section-reorder-name">${info.label}</span>
            <div class="section-reorder-arrows">
                <button class="section-reorder-arrow" onclick="moveSectionUp(${idx})" ${idx===0?'disabled':''}">↑</button>
                <button class="section-reorder-arrow" onclick="moveSectionDown(${idx})" ${idx===sectionOrder.length-1?'disabled':''}>↓</button>
            </div>`;
        // Drag events
        item.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', idx); item.classList.add('dragging'); });
        item.addEventListener('dragend', () => item.classList.remove('dragging'));
        item.addEventListener('dragover', e => { e.preventDefault(); item.classList.add('drag-over'); });
        item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
        item.addEventListener('drop', e => {
            e.preventDefault();
            item.classList.remove('drag-over');
            const from = parseInt(e.dataTransfer.getData('text/plain'));
            const to = idx;
            if(from !== to) reorderSection(from, to);
        });
        list.appendChild(item);
    });
}

function moveSectionUp(idx){
    if(idx <= 0) return;
    [sectionOrder[idx-1], sectionOrder[idx]] = [sectionOrder[idx], sectionOrder[idx-1]];
    applySectionOrder();
}

function moveSectionDown(idx){
    if(idx >= sectionOrder.length - 1) return;
    [sectionOrder[idx], sectionOrder[idx+1]] = [sectionOrder[idx+1], sectionOrder[idx]];
    applySectionOrder();
}

function reorderSection(from, to){
    const item = sectionOrder.splice(from, 1)[0];
    sectionOrder.splice(to, 0, item);
    applySectionOrder();
}

function applySectionOrder(){
    // Find the parent that holds all sections (body or a wrapper)
    const ticker = document.querySelector('.ticker');
    const footer = document.querySelector('footer');
    if(!ticker || !footer) return;
    // Insert sections after ticker in the specified order
    let insertAfter = ticker;
    sectionOrder.forEach(secId => {
        let el;
        if(secId === 'hero') el = document.querySelector('.hero');
        else if(secId === 'customSectionsArea') el = document.getElementById('customSectionsArea');
        else el = document.getElementById(secId);
        if(el){
            insertAfter.after(el);
            insertAfter = el;
        }
    });
    renderSectionReorder();
    scheduleAutoSave();
}

function loadSectionOrder(state){
    if(state.sectionOrder && Array.isArray(state.sectionOrder)){
        // Validate all IDs exist
        const valid = state.sectionOrder.filter(id => MAIN_SECTIONS.some(s => s.id === id));
        // Add any missing sections
        MAIN_SECTIONS.forEach(s => { if(!valid.includes(s.id)) valid.push(s.id); });
        sectionOrder = valid;
        applySectionOrder();
    }
}


// =============================================
// INIT
// =============================================
buildTP();
buildTplSelector();
buildBGGrid();
buildHeroLayoutRow();
buildGalLayoutRow();
buildScrollAnimRow();
buildHoverFxRow();
buildCursorFxRow();
buildPresetGrid();
buildBgImgModeRow();
buildExtraControls();
syncBgfxFromTheme();
mkP();
renderColTabs();
renderColContent();
renderSocPanel();
renderCustomSections();
renderCSBPanel();
syncServiceBlocksFromDOM();
renderServicePanel();
renderQuickLinksPanel();
syncAdvColorUI();

// About panel init
syncAboutPanelFromDOM();
renderSectionReorder();
updateFooterYear();

// Load saved state (after UI is built)
const hadSave = loadState();
hookAutoSave();

// Re-sync about panel after load
syncAboutPanelFromDOM();
// Re-render section order after load
renderSectionReorder();

// Initialize undo system with current state
lastUndoSnapshot = JSON.stringify(gatherState());
updateUndoButtons();

// Wire undo snapshots to autosave
const _origScheduleAutoSave = scheduleAutoSave;
scheduleAutoSave = function(){
    _origScheduleAutoSave();
    scheduleSnapshot();
};

// Ctrl+Z / Ctrl+Y shortcuts
document.addEventListener('keydown', e => {
    if((e.ctrlKey||e.metaKey) && e.key === 'z' && !e.shiftKey){
        // Only intercept if not focused on editable/input
        const tag = document.activeElement?.tagName;
        if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.contentEditable === 'true') return;
        e.preventDefault();
        undo();
    }
    if((e.ctrlKey||e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))){
        const tag = document.activeElement?.tagName;
        if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.contentEditable === 'true') return;
        e.preventDefault();
        redo();
    }
});

// Wire about section DOM edits back to panel
document.querySelectorAll('#about .editable').forEach(el => {
    el.addEventListener('blur', () => { syncAboutPanelFromDOM(); });
});

checkOnboard();

if(hadSave){
    const ts = JSON.parse(localStorage.getItem(SAVE_KEY)||'{}').ts;
    const d = ts ? new Date(ts) : null;
    const timeStr = d ? d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) : '';
    showSaveConfirm('✓ Sauvegarde restaurée', timeStr ? 'Dernière sauvegarde: ' + timeStr : '');
}
</script>
</body>
</html>